<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meditation & Mindfulness - Divine Temple</title>
    
    <!-- Performance optimizations -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//fonts.gstatic.com">
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Critical CSS -->
    <link rel="preload" href="../css/critical.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="../css/critical.min.css"></noscript>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    
    <style>
        :root {
            --primary-bg: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            --accent-purple: #8b5fbf;
            --accent-gold: #d4af37;
            --accent-blue: #4fc3f7;
            --accent-green: #66bb6a;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--primary-bg);
            color: white;
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .meditation-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-5px);
        }

        .meditation-header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 3rem 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 25px;
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
        }

        .meditation-title {
            font-family: 'Playfair Display', serif;
            font-size: clamp(2.5rem, 5vw, 4rem);
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
            text-shadow: var(--text-shadow);
        }

        .meditation-subtitle {
            font-size: 1.3rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 2rem;
            font-weight: 300;
        }

        .meditation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .meditation-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            transition: all 0.4s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            animation: breathingCard 6s ease-in-out infinite;
        }

        .meditation-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px rgba(79, 195, 247, 0.4), 0 0 30px rgba(102, 187, 106, 0.3);
            border-color: var(--accent-blue);
            animation-play-state: paused;
        }

        .meditation-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-green));
            animation: peacefulFlow 8s ease-in-out infinite;
        }

        .meditation-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(
                circle,
                rgba(79, 195, 247, 0.1) 0%,
                transparent 70%
            );
            animation: meditationAura 10s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes breathingCard {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 10px 20px rgba(79, 195, 247, 0.2);
            }
            50% { 
                transform: scale(1.01);
                box-shadow: 0 15px 30px rgba(79, 195, 247, 0.3);
            }
        }

        @keyframes peacefulFlow {
            0%, 100% { 
                background: linear-gradient(90deg, var(--accent-blue), var(--accent-green));
            }
            33% { 
                background: linear-gradient(90deg, var(--accent-green), var(--accent-purple));
            }
            66% { 
                background: linear-gradient(90deg, var(--accent-purple), var(--accent-blue));
            }
        }

        @keyframes meditationAura {
            0%, 100% { 
                opacity: 0.3;
                transform: rotate(0deg) scale(1);
            }
            50% { 
                opacity: 0.6;
                transform: rotate(180deg) scale(1.1);
            }
        }

        .card-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
            text-align: center;
            animation: iconBreathing 4s ease-in-out infinite;
            filter: drop-shadow(0 0 10px rgba(79, 195, 247, 0.5));
            transition: all 0.3s ease;
        }

        .meditation-card:hover .card-icon {
            animation: iconPulse 1s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(102, 187, 106, 0.8));
            transform: scale(1.1);
        }

        @keyframes iconBreathing {
            0%, 100% { 
                transform: scale(1);
                opacity: 0.8;
            }
            50% { 
                transform: scale(1.05);
                opacity: 1;
            }
        }

        @keyframes iconPulse {
            0%, 100% { 
                transform: scale(1.1);
                filter: drop-shadow(0 0 20px rgba(102, 187, 106, 0.8));
            }
            50% { 
                transform: scale(1.15);
                filter: drop-shadow(0 0 30px rgba(102, 187, 106, 1));
            }
        }

        .card-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--accent-blue);
            margin-bottom: 1rem;
            text-align: center;
        }

        .card-description {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .card-features {
            list-style: none;
            margin-bottom: 2rem;
        }

        .card-features li {
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.5rem;
            padding-left: 1.5rem;
            position: relative;
        }

        .card-features li::before {
            content: '🌟';
            position: absolute;
            left: 0;
            color: var(--accent-green);
        }

        .meditation-btn {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .meditation-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 195, 247, 0.4);
        }

        .featured-tool {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, rgba(79, 195, 247, 0.2), rgba(102, 187, 106, 0.2));
            border: 2px solid var(--accent-green);
        }

        .featured-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--accent-green);
            color: #000;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        /* Meditation Session Modal */
        .session-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 2rem;
            backdrop-filter: blur(10px);
        }

        .session-modal {
            background: var(--primary-bg);
            border-radius: 25px;
            padding: 0;
            max-width: 800px;
            max-height: 600px;
            width: 100%;
            height: 80vh;
            position: relative;
            border: 2px solid var(--accent-blue);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .session-header {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
            padding: 2rem;
            text-align: center;
            position: relative;
        }

        .session-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            margin: 0;
            text-shadow: var(--text-shadow);
        }

        .session-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .session-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .session-content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            text-align: center;
        }

        .breathing-guide {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 3rem;
            padding: 2rem;
        }

        .breath-circle {
            position: relative;
            width: 200px;
            height: 200px;
            border: 3px solid var(--accent-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
            transition: all 4s ease-in-out;
            background: radial-gradient(
                circle,
                rgba(79, 195, 247, 0.1) 0%,
                rgba(79, 195, 247, 0.05) 50%,
                transparent 100%
            );
            animation: breathCircle 12s ease-in-out infinite;
        }

        .breath-circle.breath-hold {
            transform: scale(1.2);
            border-color: var(--accent-green);
            background: radial-gradient(
                circle,
                rgba(102, 187, 106, 0.2) 0%,
                rgba(102, 187, 106, 0.1) 50%,
                transparent 100%
            );
        }

        .breath-circle.breath-exhale {
            transform: scale(0.8);
            border-color: var(--accent-purple);
            background: radial-gradient(
                circle,
                rgba(139, 95, 191, 0.1) 0%,
                rgba(139, 95, 191, 0.05) 50%,
                transparent 100%
            );
        }

        .breath-inner-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--accent-blue), var(--accent-green));
            opacity: 0.6;
            transition: all 4s ease-in-out;
            animation: breathInner 12s ease-in-out infinite;
        }

        .breath-inner-circle.breath-hold {
            transform: scale(1.3);
            background: linear-gradient(45deg, var(--accent-green), var(--accent-gold));
        }

        .breath-inner-circle.breath-exhale {
            transform: scale(0.7);
            background: linear-gradient(45deg, var(--accent-purple), var(--accent-blue));
        }

        .breath-text {
            position: absolute;
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .breath-instructions {
            text-align: center;
        }

        .breath-phase {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-blue);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .breath-count {
            font-size: 3rem;
            font-weight: 900;
            color: var(--accent-gold);
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.8);
        }

        @keyframes breathCircle {
            0%, 33% { transform: scale(1); }
            66% { transform: scale(1.2); }
            100% { transform: scale(0.8); }
        }

        @keyframes breathInner {
            0%, 33% { transform: scale(1); opacity: 0.6; }
            66% { transform: scale(1.3); opacity: 0.8; }
            100% { transform: scale(0.7); opacity: 0.4; }
        }

        .ambient-visualization {
            position: relative;
            width: 100%;
            height: 300px;
            margin-bottom: 2rem;
            border-radius: 20px;
            background: linear-gradient(135deg, 
                rgba(79, 195, 247, 0.1) 0%,
                rgba(102, 187, 106, 0.1) 50%,
                rgba(139, 95, 191, 0.1) 100%);
            overflow: hidden;
        }

        .ambient-particles {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: radial-gradient(circle, white, transparent);
            border-radius: 50%;
            animation: floatParticle 15s ease-in-out infinite;
        }

        .particle:nth-child(odd) {
            background: radial-gradient(circle, var(--accent-blue), transparent);
            animation-duration: 12s;
        }

        .particle:nth-child(3n) {
            background: radial-gradient(circle, var(--accent-green), transparent);
            animation-duration: 18s;
        }

        .meditation-focus {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .focus-center {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 0 auto 2rem;
        }

        .focus-ripple {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid var(--accent-gold);
            border-radius: 50%;
            animation: focusRipple 4s ease-out infinite;
        }

        .focus-ripple:nth-child(2) {
            animation-delay: 1.3s;
        }

        .focus-ripple:nth-child(3) {
            animation-delay: 2.6s;
        }

        .focus-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
            font-style: italic;
            max-width: 300px;
            margin: 0 auto;
            animation: fadeInOut 6s ease-in-out infinite;
        }

        @keyframes floatParticle {
            0%, 100% {
                transform: translateY(0) translateX(0) scale(0);
                opacity: 0;
            }
            10%, 90% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                transform: translateY(-100px) translateX(50px) scale(1.2);
                opacity: 0.8;
            }
        }

        @keyframes focusRipple {
            0% {
                width: 20px;
                height: 20px;
                opacity: 1;
            }
            100% {
                width: 100px;
                height: 100px;
                opacity: 0;
            }
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .timer-display {
            font-size: 4rem;
            font-weight: 700;
            color: var(--accent-blue);
            margin-bottom: 2rem;
            font-family: 'Inter', monospace;
        }

        .session-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 1rem 2rem;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .control-btn.active {
            background: var(--accent-blue);
        }

        .breathing-guide {
            font-size: 2rem;
            color: var(--accent-green);
            margin-bottom: 2rem;
            font-weight: 600;
        }

        .progress-ring {
            width: 200px;
            height: 200px;
            margin: 0 auto 2rem;
            position: relative;
        }

        .progress-ring svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 8;
        }

        .progress-ring .background {
            stroke: rgba(255, 255, 255, 0.1);
        }

        .progress-ring .progress {
            stroke: var(--accent-blue);
            stroke-linecap: round;
            transition: stroke-dashoffset 0.3s ease;
        }

        .chakra-wheel {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1rem;
            margin: 2rem 0;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
        }

        .chakra {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .chakra:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

        .chakra.active {
            animation: chakraPulse 2s infinite;
        }

        .affirmations {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .affirmation-text {
            font-size: 1.5rem;
            font-style: italic;
            color: var(--accent-gold);
            text-align: center;
            margin-bottom: 1rem;
            min-height: 3rem;
        }

        /* Enhanced Breathing Exercises Styles */
        .breathing-techniques {
            padding: 20px;
        }

        .technique-selection h4 {
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }

        .technique-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .technique-card {
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(255, 215, 0, 0.1));
            border: 2px solid var(--primary-color);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .technique-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(79, 172, 254, 0.3);
            border-color: var(--accent-color);
        }

        .technique-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .technique-card h5 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .technique-card p {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.8);
        }

        .breathing-visualizer {
            text-align: center;
            padding: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            margin: 20px 0;
        }

        .breathing-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border: 3px solid var(--primary-color);
            position: relative;
            transition: all 2s ease-in-out;
        }

        .breathing-circle.breathing-active {
            box-shadow: 0 0 30px var(--primary-color);
        }

        .breathing-text {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .breathing-count {
            font-size: 2em;
            font-weight: bold;
            color: var(--accent-color);
        }

        .breathing-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .breathing-controls button {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border: none;
            border-radius: 25px;
            padding: 12px 24px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .breathing-controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .breathing-progress {
            display: flex;
            justify-content: space-around;
            color: var(--primary-color);
            font-weight: bold;
        }

        .breathing-instructions {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .breathing-benefits ul {
            list-style: none;
            padding: 0;
        }

        .breathing-benefits li {
            padding: 5px 0;
            color: rgba(255, 255, 255, 0.9);
            position: relative;
            padding-left: 20px;
        }

        .breathing-benefits li:before {
            content: "✨";
            position: absolute;
            left: 0;
        }

        /* Enhanced Chakra Balancing Styles */
        .chakra-wheel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .chakra-point {
            aspect-ratio: 1;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .chakra-point:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 0 30px currentColor;
        }

        .chakra-point.selected {
            transform: scale(1.15);
            box-shadow: 0 0 40px currentColor;
            border-color: white;
        }

        .chakra-symbol {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .chakra-name {
            font-weight: bold;
            font-size: 0.9em;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .chakra-frequency {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .chakra-session-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 25px;
            margin: 30px 0;
        }

        .chakra-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .chakra-symbol-large {
            font-size: 3em;
        }

        .chakra-properties {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .property {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .chakra-session-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .chakra-session-controls button {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border: none;
            border-radius: 25px;
            padding: 12px 20px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .chakra-session-controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .current-chakra-display {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            align-items: center;
            margin-bottom: 20px;
        }

        .chakra-visualization {
            text-align: center;
        }

        .spinning-chakra {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        @keyframes chakraSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .chakra-details h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .mantra-display, .frequency-display {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }

        .session-timer {
            text-align: center;
            margin: 20px 0;
        }

        #chakra-timer {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color);
            display: block;
            margin-bottom: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 4px;
            transition: width 1s ease;
            width: 0%;
        }

        .chakra-affirmation {
            background: rgba(0, 0, 0, 0.4);
            border-left: 4px solid var(--accent-color);
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 10px 10px 0;
            font-style: italic;
            text-align: center;
            color: var(--primary-color);
            font-size: 1.1em;
        }

        .chakra-guidance {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
        }

        .chakra-benefits ul {
            list-style: none;
            padding: 0;
        }

        .chakra-benefits li {
            padding: 8px 0;
            color: rgba(255, 255, 255, 0.9);
            position: relative;
            padding-left: 25px;
        }

        .chakra-benefits li:before {
            content: "🌈";
            position: absolute;
            left: 0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .meditation-container {
                padding: 1rem;
            }

            .meditation-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .featured-tool {
                grid-column: 1;
            }

            .session-modal {
                margin: 1rem;
                height: calc(100vh - 2rem);
            }

            .chakra-wheel {
                grid-template-columns: repeat(4, 1fr);
                gap: 0.5rem;
            }

            .chakra {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }

            .timer-display {
                font-size: 3rem;
            }
        }

        @keyframes chakraPulse {
            0%, 100% { 
                box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 30px rgba(255, 255, 255, 0.7);
                transform: scale(1.05);
            }
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .breathing-animation {
            animation: breathe 4s infinite ease-in-out;
        }
    </style>
</head>
<body>
    <div class="meditation-container">
        <button class="back-btn" onclick="window.parent.postMessage('back', '*')">
            ← Back to Temple
        </button>

        <div class="meditation-header">
            <div class="card-icon">🧘</div>
            <h1 class="meditation-title">Meditation & Mindfulness</h1>
            <p class="meditation-subtitle">Find peace, balance, and inner wisdom through guided practices</p>
        </div>

        <div class="meditation-grid">
            <!-- Guided Meditation - Featured Tool -->
            <div class="meditation-card featured-tool" onclick="openGuidedMeditation()">
                <div class="featured-badge">Most Popular</div>
                <div class="card-icon">🎧</div>
                <h3 class="card-title">Guided Meditation</h3>
                <p class="card-description">
                    Follow along with soothing guided meditations for relaxation, healing, and spiritual connection.
                </p>
                <ul class="card-features">
                    <li>10+ guided meditation tracks</li>
                    <li>Various durations (5-60 minutes)</li>
                    <li>Healing, chakra, and mindfulness themes</li>
                    <li>Customizable background sounds</li>
                    <li>Progress tracking and favorites</li>
                </ul>
                <button class="meditation-btn">Start Guided Session</button>
            </div>

            <!-- Breathing Exercises -->
            <div class="meditation-card" onclick="openBreathingExercises()">
                <div class="card-icon">🌬️</div>
                <h3 class="card-title">Breathing Exercises</h3>
                <p class="card-description">
                    Master your breath with guided breathing techniques for calm, focus, and energy.
                </p>
                <ul class="card-features">
                    <li>4-7-8 breathing technique</li>
                    <li>Box breathing (Navy SEAL method)</li>
                    <li>Wim Hof breathing</li>
                    <li>Visual breathing guides</li>
                </ul>
                <button class="meditation-btn" onclick="openBreathingExercises()">Begin Breathing</button>
            </div>

            <!-- Chakra Balancing -->
            <div class="meditation-card" onclick="openChakraBalancing()">
                <div class="card-icon">💎</div>
                <h3 class="card-title">Chakra Balancing</h3>
                <p class="card-description">
                    Align your energy centers with targeted chakra meditations and healing frequencies.
                </p>
                <ul class="card-features">
                    <li>All 7 chakra meditations</li>
                    <li>Healing frequency tones</li>
                    <li>Visual chakra wheel</li>
                    <li>Energy assessment tools</li>
                </ul>
                <button class="meditation-btn">Balance Chakras</button>
            </div>

            <!-- Mindfulness Practices -->
            <div class="meditation-card" onclick="openMindfulness()">
                <div class="card-icon">🌱</div>
                <h3 class="card-title">Mindfulness Practices</h3>
                <p class="card-description">
                    Cultivate present-moment awareness with mindfulness exercises and daily practices.
                </p>
                <ul class="card-features">
                    <li>Body scan meditation</li>
                    <li>Walking meditation guide</li>
                    <li>Mindful eating practices</li>
                    <li>Daily mindfulness reminders</li>
                </ul>
                <button class="meditation-btn">Practice Mindfulness</button>
            </div>

            <!-- Loving-Kindness -->
            <div class="meditation-card" onclick="openLovingKindness()">
                <div class="card-icon">💝</div>
                <h3 class="card-title">Loving-Kindness</h3>
                <p class="card-description">
                    Open your heart with compassion meditations and loving-kindness practices.
                </p>
                <ul class="card-features">
                    <li>Self-compassion exercises</li>
                    <li>Forgiveness meditations</li>
                    <li>Heart-opening practices</li>
                    <li>Relationship healing</li>
                </ul>
                <button class="meditation-btn">Cultivate Love</button>
            </div>

            <!-- Silent Meditation -->
            <div class="meditation-card" onclick="openSilentMeditation()">
                <div class="card-icon">🤫</div>
                <h3 class="card-title">Silent Meditation</h3>
                <p class="card-description">
                    Practice traditional silent meditation with customizable timers and gentle bells.
                </p>
                <ul class="card-features">
                    <li>Customizable session length</li>
                    <li>Interval bells and chimes</li>
                    <li>Background nature sounds</li>
                    <li>Session statistics</li>
                </ul>
                <button class="meditation-btn">Sit in Silence</button>
            </div>
        </div>
    </div>

    <!-- Meditation Session Modal -->
    <div id="session-modal" class="session-modal-overlay">
        <div class="session-modal">
            <div class="session-header">
                <h2 class="session-title" id="session-title">Meditation Session</h2>
                <button class="session-close" onclick="closeSession()">×</button>
            </div>
            <div class="session-content" id="session-content">
                <!-- Session content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Performance Scripts -->
    <script src="../js/performance.js" defer></script>
    <script src="../js/image-optimizer.js" defer></script>

    <script>
        // Meditation data and state
        let currentSession = {
            type: '',
            duration: 0,
            isActive: false,
            timeRemaining: 0,
            interval: null,
            startTime: null,
            totalSessions: 0,
            sessionHistory: []
        };

        let meditationProgress = {
            totalMinutes: 0,
            streak: 0,
            lastSession: null,
            achievements: [],
            favoritePractices: [],
            sessionStats: {
                guided: 0,
                breathing: 0,
                chakra: 0,
                mindfulness: 0,
                lovingKindness: 0,
                silent: 0
            }
        };

        // Load progress from localStorage
        function loadMeditationProgress() {
            const saved = localStorage.getItem('meditationProgress');
            if (saved) {
                meditationProgress = { ...meditationProgress, ...JSON.parse(saved) };
            }
            updateProgressDisplay();
        }

        // Save progress to localStorage
        function saveMeditationProgress() {
            localStorage.setItem('meditationProgress', JSON.stringify(meditationProgress));
            // Trigger progress update event for universal system
            window.parent.postMessage({ 
                type: 'progressUpdate', 
                section: 'meditation',
                data: meditationProgress 
            }, '*');
        }

        // Session completion tracking
        function completeSession() {
            stopSession();
            
            if (currentSession.startTime) {
                const sessionMinutes = Math.floor((Date.now() - currentSession.startTime) / 60000);
                const sessionData = {
                    type: currentSession.type,
                    duration: sessionMinutes,
                    date: new Date().toISOString(),
                    completed: true
                };

                // Update progress stats
                meditationProgress.totalMinutes += sessionMinutes;
                meditationProgress.sessionStats[currentSession.type] = 
                    (meditationProgress.sessionStats[currentSession.type] || 0) + 1;
                
                // Update streak
                updateStreak();
                
                // Add to session history
                currentSession.sessionHistory.push(sessionData);
                if (currentSession.sessionHistory.length > 50) {
                    currentSession.sessionHistory = currentSession.sessionHistory.slice(-50);
                }

                // Check for achievements
                checkAchievements(sessionMinutes);
                
                // Save progress
                saveMeditationProgress();
                
                // Show completion message with stats
                showSessionComplete(sessionMinutes);
            }
        }

        function updateStreak() {
            const today = new Date().toDateString();
            const lastSessionDate = meditationProgress.lastSession ? 
                new Date(meditationProgress.lastSession).toDateString() : null;
            
            if (lastSessionDate === today) {
                // Already meditated today, keep streak
                return;
            } else if (lastSessionDate === 
                new Date(Date.now() - 86400000).toDateString()) {
                // Meditated yesterday, increment streak
                meditationProgress.streak++;
            } else {
                // Streak broken, reset
                meditationProgress.streak = 1;
            }
            
            meditationProgress.lastSession = new Date().toISOString();
        }

        function checkAchievements(sessionMinutes) {
            const achievements = [];
            
            // First meditation achievement
            if (meditationProgress.totalMinutes === sessionMinutes) {
                achievements.push({
                    id: 'first_meditation',
                    title: 'First Steps to Peace',
                    description: 'Completed your first meditation session',
                    icon: '🌱',
                    earned: new Date().toISOString()
                });
            }

            // Time-based achievements
            if (meditationProgress.totalMinutes >= 60 && !hasAchievement('hour_master')) {
                achievements.push({
                    id: 'hour_master',
                    title: 'Hour of Peace',
                    description: 'Meditated for a total of 1 hour',
                    icon: '⏰',
                    earned: new Date().toISOString()
                });
            }

            if (meditationProgress.totalMinutes >= 600 && !hasAchievement('zen_master')) {
                achievements.push({
                    id: 'zen_master',
                    title: 'Zen Master',
                    description: 'Achieved 10 hours of meditation',
                    icon: '🧘‍♂️',
                    earned: new Date().toISOString()
                });
            }

            // Streak achievements
            if (meditationProgress.streak >= 7 && !hasAchievement('week_warrior')) {
                achievements.push({
                    id: 'week_warrior',
                    title: 'Week Warrior',
                    description: '7-day meditation streak',
                    icon: '🔥',
                    earned: new Date().toISOString()
                });
            }

            if (meditationProgress.streak >= 30 && !hasAchievement('month_monk')) {
                achievements.push({
                    id: 'month_monk',
                    title: 'Month Monk',
                    description: '30-day meditation streak',
                    icon: '🏆',
                    earned: new Date().toISOString()
                });
            }

            // Add new achievements
            achievements.forEach(achievement => {
                if (!hasAchievement(achievement.id)) {
                    meditationProgress.achievements.push(achievement);
                    showAchievementNotification(achievement);
                }
            });
        }

        function hasAchievement(achievementId) {
            return meditationProgress.achievements.some(a => a.id === achievementId);
        }

        function showAchievementNotification(achievement) {
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="
                    position: fixed; top: 20px; right: 20px; z-index: 10001;
                    background: linear-gradient(135deg, #f59e0b, #d97706);
                    color: white; padding: 1.5rem; border-radius: 15px;
                    box-shadow: 0 15px 35px rgba(245, 158, 11, 0.4);
                    animation: achievementPop 0.6s ease;
                    max-width: 300px;
                ">
                    <div style="text-align: center; margin-bottom: 1rem; font-size: 2rem;">
                        ${achievement.icon}
                    </div>
                    <div style="font-weight: 700; margin-bottom: 0.5rem; text-align: center;">
                        🏆 Achievement Unlocked!
                    </div>
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">
                        ${achievement.title}
                    </div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">
                        ${achievement.description}
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Play achievement sound
            playAchievementSound();
            
            setTimeout(() => {
                notification.style.animation = 'achievementSlideOut 0.5s ease';
                setTimeout(() => notification.remove(), 500);
            }, 4000);
        }

        function showSessionComplete(minutes) {
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    z-index: 10001; background: linear-gradient(135deg, #10b981, #059669);
                    color: white; padding: 2rem; border-radius: 20px;
                    box-shadow: 0 20px 40px rgba(16, 185, 129, 0.4);
                    text-align: center; max-width: 400px;
                    animation: sessionCompleteShow 0.6s ease;
                ">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">🧘‍♂️</div>
                    <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem;">
                        Session Complete!
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>${minutes} minutes</strong> of peaceful practice
                    </div>
                    <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 1.5rem;">
                        Total meditation time: ${meditationProgress.totalMinutes} minutes<br>
                        Current streak: ${meditationProgress.streak} days
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
                        color: white; padding: 0.5rem 1.5rem; border-radius: 10px;
                        cursor: pointer; transition: all 0.3s ease;
                    ">Continue</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Play completion sound
            playCompletionSound();
            
            // Auto-remove after 5 seconds if user doesn't click
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function updateProgressDisplay() {
            // Update any visible progress displays
            const progressElements = document.querySelectorAll('.progress-display');
            progressElements.forEach(el => {
                el.innerHTML = `
                    <div class="stat-item">
                        <div class="stat-value">${meditationProgress.totalMinutes}</div>
                        <div class="stat-label">Total Minutes</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${meditationProgress.streak}</div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${meditationProgress.achievements.length}</div>
                        <div class="stat-label">Achievements</div>
                    </div>
                `;
            });
        }

        const guidedMeditations = [
            {
                id: 'deep_relaxation',
                title: 'Deep Relaxation',
                duration: 10,
                category: 'relaxation',
                description: 'Release tension and stress with this calming meditation',
                script: [
                    { time: 0, text: "Find a comfortable position and close your eyes gently..." },
                    { time: 30, text: "Take three deep breaths, feeling your body relax with each exhale..." },
                    { time: 90, text: "Notice any tension in your shoulders and let it melt away..." },
                    { time: 150, text: "Feel your breathing becoming naturally slower and deeper..." },
                    { time: 240, text: "Scan your body from head to toe, releasing any remaining tension..." },
                    { time: 360, text: "Rest in this peaceful state, feeling completely relaxed..." },
                    { time: 480, text: "When you're ready, slowly bring your awareness back..." },
                    { time: 570, text: "Take a deep breath and gently open your eyes..." }
                ],
                ambientSound: 'rain',
                frequency: 528 // Love frequency
            },
            {
                id: 'healing_light',
                title: 'Divine Healing Light',
                duration: 15,
                category: 'healing',
                description: 'Channel divine healing energy through visualization',
                script: [
                    { time: 0, text: "Settle into a comfortable position and breathe naturally..." },
                    { time: 45, text: "Imagine a brilliant golden light above your head..." },
                    { time: 120, text: "See this healing light slowly entering the crown of your head..." },
                    { time: 180, text: "Feel the warm, loving energy flowing through your entire body..." },
                    { time: 300, text: "The light is healing every cell, bringing perfect health..." },
                    { time: 420, text: "Areas of discomfort are being filled with healing energy..." },
                    { time: 540, text: "You are completely surrounded by divine healing light..." },
                    { time: 660, text: "Feel grateful for this healing energy flowing through you..." },
                    { time: 780, text: "The light remains with you as you slowly return to awareness..." },
                    { time: 870, text: "Take a moment to appreciate the healing you've received..." }
                ],
                ambientSound: 'nature',
                frequency: 639 // Heart chakra frequency
            },
            {
                id: 'spiritual_connection',
                title: 'Spiritual Connection',
                duration: 20,
                category: 'spiritual',
                description: 'Connect with your higher self and divine wisdom',
                script: [
                    { time: 0, text: "Create sacred space by setting your intention for connection..." },
                    { time: 60, text: "Breathe in divine love, breathe out anything that separates you..." },
                    { time: 150, text: "Feel your heart center opening to receive divine guidance..." },
                    { time: 240, text: "Imagine yourself surrounded by loving spiritual presence..." },
                    { time: 360, text: "Ask your higher self: 'What do I most need to know today?'..." },
                    { time: 480, text: "Listen with your heart, not your mind, for the gentle response..." },
                    { time: 600, text: "Feel the wisdom and love that is always available to you..." },
                    { time: 720, text: "You are deeply connected to infinite love and wisdom..." },
                    { time: 900, text: "Express gratitude for this sacred connection..." },
                    { time: 1020, text: "Carry this connection with you throughout your day..." },
                    { time: 1140, text: "Slowly return to ordinary awareness, feeling blessed and guided..." }
                ],
                ambientSound: 'temple_bells',
                frequency: 963 // Crown chakra frequency
            },
            {
                id: 'chakra_journey',
                title: 'Complete Chakra Journey',
                duration: 25,
                category: 'chakra',
                description: 'Travel through all seven chakras for complete energy alignment',
                script: [
                    { time: 0, text: "Ground yourself and connect with the earth beneath you..." },
                    { time: 120, text: "Focus on your root chakra, feeling safe and secure..." },
                    { time: 240, text: "Move to your sacral chakra, embracing creativity and flow..." },
                    { time: 360, text: "Energize your solar plexus, feeling personal power..." },
                    { time: 480, text: "Open your heart chakra to infinite love and compassion..." },
                    { time: 600, text: "Clear your throat chakra, expressing your authentic truth..." },
                    { time: 720, text: "Activate your third eye, seeing with inner wisdom..." },
                    { time: 840, text: "Crown chakra opens to divine connection and unity..." },
                    { time: 960, text: "Feel all chakras spinning in perfect harmony..." },
                    { time: 1200, text: "You are a being of light, perfectly balanced and aligned..." },
                    { time: 1380, text: "Carry this energetic alignment into your daily life..." }
                ],
                ambientSound: 'crystal_bowls',
                frequency: 'chakra_sequence'
            }
        ];

        const ambientSounds = {
            rain: {
                name: 'Gentle Rain',
                description: 'Soft rainfall for deep relaxation',
                frequencies: [200, 400, 800, 1600],
                volume: 0.3
            },
            nature: {
                name: 'Forest Sounds',
                description: 'Birds and gentle breeze',
                frequencies: [300, 600, 1200, 2400],
                volume: 0.25
            },
            temple_bells: {
                name: 'Temple Bells',
                description: 'Sacred Tibetan singing bowls',
                frequencies: [256, 384, 512, 768],
                volume: 0.4
            },
            crystal_bowls: {
                name: 'Crystal Bowls',
                description: 'Pure crystal healing tones',
                frequencies: [432, 528, 639, 741],
                volume: 0.35
            },
            ocean: {
                name: 'Ocean Waves',
                description: 'Rhythmic waves on the shore',
                frequencies: [100, 200, 400, 800],
                volume: 0.3
            }
        };

        // Web Audio API for ambient sounds and frequencies
        let audioContext = null;
        let ambientNodes = [];
        let currentMeditation = null;

        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }

        function startAmbientSound(soundType) {
            if (!ambientSounds[soundType]) return;
            
            const ctx = initAudioContext();
            const sound = ambientSounds[soundType];
            
            // Stop any existing ambient sounds
            stopAmbientSound();
            
            // Create oscillators for each frequency
            sound.frequencies.forEach((freq, index) => {
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                const filter = ctx.createBiquadFilter();
                
                oscillator.frequency.value = freq;
                oscillator.type = 'sine';
                
                // Add slight variation to make it more natural
                const lfo = ctx.createOscillator();
                const lfoGain = ctx.createGain();
                lfo.frequency.value = 0.1 + (index * 0.05);
                lfoGain.gain.value = freq * 0.01;
                lfo.connect(lfoGain);
                lfoGain.connect(oscillator.frequency);
                
                // Low-pass filter for warmth
                filter.type = 'lowpass';
                filter.frequency.value = freq * 2;
                filter.Q.value = 0.5;
                
                gainNode.gain.value = sound.volume / sound.frequencies.length;
                
                oscillator.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                oscillator.start();
                lfo.start();
                
                ambientNodes.push({ oscillator, gainNode, filter, lfo });
            });
        }

        function stopAmbientSound() {
            ambientNodes.forEach(node => {
                try {
                    node.oscillator.stop();
                    node.lfo.stop();
                } catch (e) {
                    // Node may already be stopped
                }
            });
            ambientNodes = [];
        }

        function playHealingFrequency(frequency) {
            const ctx = initAudioContext();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0, ctx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.1, ctx.currentTime + 1);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 10);
            
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            oscillator.start();
            oscillator.stop(ctx.currentTime + 10);
        }

        function playBellSound(frequency = 528) {
            const ctx = initAudioContext();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 3);
            
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            oscillator.start();
            oscillator.stop(ctx.currentTime + 3);
        }

        function playCompletionSound() {
            // Play a series of ascending bells
            [528, 594, 660, 792].forEach((freq, index) => {
                setTimeout(() => playBellSound(freq), index * 200);
            });
        }

        function playAchievementSound() {
            // Play celebration tones
            const ctx = initAudioContext();
            [264, 330, 396, 528].forEach((freq, index) => {
                setTimeout(() => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.frequency.value = freq;
                    osc.type = 'sine';
                    gain.gain.setValueAtTime(0.2, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.8);
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.8);
                }, index * 150);
            });
        }

        const chakraData = [
            { name: 'Root', color: '#ff0000', frequency: 396, symbol: '🔴', element: 'Earth', mantra: 'LAM' },
            { name: 'Sacral', color: '#ff8c00', frequency: 417, symbol: '🟠', element: 'Water', mantra: 'VAM' },
            { name: 'Solar Plexus', color: '#ffd700', frequency: 528, symbol: '🟡', element: 'Fire', mantra: 'RAM' },
            { name: 'Heart', color: '#00ff00', frequency: 639, symbol: '💚', element: 'Air', mantra: 'YAM' },
            { name: 'Throat', color: '#00bfff', frequency: 741, symbol: '🔵', element: 'Sound', mantra: 'HAM' },
            { name: 'Third Eye', color: '#4b0082', frequency: 852, symbol: '🟣', element: 'Light', mantra: 'OM' },
            { name: 'Crown', color: '#9400d3', frequency: 963, symbol: '🟤', element: 'Thought', mantra: 'AUM' }
        ];

        const affirmations = [
            "I am at peace with myself and the world around me.",
            "I breathe in calm and breathe out tension.",
            "My mind is clear and focused.",
            "I am grounded in the present moment.",
            "Divine light flows through every cell of my being.",
            "I release all that no longer serves me.",
            "I am connected to infinite love and wisdom.",
            "Each breath brings me deeper into peace.",
            "I trust the process of life.",
            "I am worthy of love and happiness.",
            "My heart is open to giving and receiving love.",
            "I am perfectly balanced in mind, body, and spirit."
        ];

        // Enhanced timer with progress visualization
        function startTimer(seconds) {
            currentSession.duration = seconds;
            currentSession.timeRemaining = seconds;
            currentSession.isActive = true;
            
            const progressCircle = document.getElementById('session-progress-circle');
            const circumference = 565.48;
            
            currentSession.interval = setInterval(() => {
                if (currentSession.timeRemaining > 0) {
                    currentSession.timeRemaining--;
                    updateTimerDisplay();
                    
                    // Update progress circle
                    if (progressCircle) {
                        const progress = (currentSession.duration - currentSession.timeRemaining) / currentSession.duration;
                        const offset = circumference - (progress * circumference);
                        progressCircle.style.strokeDashoffset = offset;
                    }
                } else {
                    completeSession();
                }
            }, 1000);
            
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(currentSession.timeRemaining / 60);
            const seconds = currentSession.timeRemaining % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const timer = document.getElementById('session-timer') || document.getElementById('timer');
            if (timer) timer.textContent = display;
        }

        function pauseSession() {
            const pauseBtn = document.getElementById('pause-btn');
            
            if (currentSession.isActive) {
                clearInterval(currentSession.interval);
                currentSession.isActive = false;
                if (pauseBtn) pauseBtn.textContent = 'Resume';
                
                // Pause ambient sounds by reducing volume
                ambientNodes.forEach(node => {
                    node.gainNode.gain.setValueAtTime(node.gainNode.gain.value * 0.3, audioContext.currentTime);
                });
            } else {
                // Resume session
                currentSession.isActive = true;
                startTimer(currentSession.timeRemaining);
                if (pauseBtn) pauseBtn.textContent = 'Pause';
                
                // Restore ambient sound volume
                ambientNodes.forEach(node => {
                    const originalVolume = node.gainNode.gain.value / 0.3;
                    node.gainNode.gain.setValueAtTime(originalVolume, audioContext.currentTime);
                });
            }
        }

        function stopSession() {
            if (currentSession.interval) {
                clearInterval(currentSession.interval);
            }
            currentSession.isActive = false;
            currentSession.timeRemaining = 0;
            
            // Stop all audio
            stopAmbientSound();
            
            // Clear breathing cycle if active
            if (breathingCycle) {
                clearInterval(breathingCycle);
                breathingCycle = null;
            }
        }

        // Enhanced breathing exercises
        // Using existing breathingCycle variable from above
        let currentBreathingTechnique = null;
        let breathingSessionTime = 0;
        let breathingCycles = 0;
        let breathingTimer = null;

        const breathingTechniques = {
            box: {
                name: 'Box Breathing',
                phases: [
                    { name: 'Inhale', duration: 4000, instruction: 'Breathe in slowly and deeply' },
                    { name: 'Hold', duration: 4000, instruction: 'Hold your breath gently' },
                    { name: 'Exhale', duration: 4000, instruction: 'Breathe out completely' },
                    { name: 'Hold', duration: 4000, instruction: 'Rest and prepare' }
                ],
                benefits: 'Promotes calmness, improves focus, reduces stress and anxiety',
                description: 'Used by Navy SEALs and emergency responders for peak performance under pressure'
            },
            triangle: {
                name: 'Triangle Breathing',
                phases: [
                    { name: 'Inhale', duration: 4000, instruction: 'Breathe in gently' },
                    { name: 'Hold', duration: 4000, instruction: 'Hold with ease' },
                    { name: 'Exhale', duration: 8000, instruction: 'Long, slow exhale' }
                ],
                benefits: 'Deep relaxation, stress relief, improved sleep quality',
                description: 'Extended exhale activates the parasympathetic nervous system'
            },
            pranayama: {
                name: 'Pranayama (4-7-8)',
                phases: [
                    { name: 'Inhale', duration: 4000, instruction: 'Breathe in through nose' },
                    { name: 'Hold', duration: 7000, instruction: 'Retain breath mindfully' },
                    { name: 'Exhale', duration: 8000, instruction: 'Exhale completely through mouth' }
                ],
                benefits: 'Spiritual awakening, energy balance, mental clarity',
                description: 'Ancient yogic practice for life force (prana) cultivation'
            },
            coherent: {
                name: 'Heart Coherence',
                phases: [
                    { name: 'Inhale', duration: 5000, instruction: 'Breathe into your heart' },
                    { name: 'Exhale', duration: 5000, instruction: 'Breathe out from your heart' }
                ],
                benefits: 'Heart-brain coherence, emotional balance, intuitive clarity',
                description: 'Creates coherence between heart rhythm and breathing'
            }
        };

        function openBreathingExercises() {
            showPracticeSection('breathing');
            document.getElementById('breathing-viz').style.display = 'none';
            document.getElementById('breathing-instructions').style.display = 'block';
        }

        function startBreathingExercise(technique) {
            currentBreathingTechnique = breathingTechniques[technique];
            breathingCycles = 0;
            breathingSessionTime = 0;
            
            // Update instructions
            const title = document.getElementById('instruction-title');
            const text = document.getElementById('instruction-text');
            const benefits = document.getElementById('breathing-benefits');
            
            if (title) title.textContent = currentBreathingTechnique.name;
            if (text) text.innerHTML = `
                <p><strong>Description:</strong> ${currentBreathingTechnique.description}</p>
                <p><strong>Benefits:</strong> ${currentBreathingTechnique.benefits}</p>
                <p><strong>Instructions:</strong> Follow the visual guide and text prompts. The circle will expand and contract to guide your breathing rhythm.</p>
            `;
            
            // Show visualizer
            document.getElementById('breathing-viz').style.display = 'block';
            document.getElementById('breathing-instructions').style.display = 'block';
            
            // Update display
            updateBreathingDisplay();
        }

        function toggleBreathing() {
            const toggleBtn = document.getElementById('breathing-toggle');
            
            if (breathingCycle) {
                // Stop breathing
                clearInterval(breathingCycle);
                clearInterval(breathingTimer);
                breathingCycle = null;
                toggleBtn.textContent = 'Start';
                
                const circle = document.getElementById('breathing-circle');
                if (circle) circle.classList.remove('breathing-active');
            } else {
                // Start breathing
                if (!currentBreathingTechnique) {
                    alert('Please select a breathing technique first');
                    return;
                }
                
                startBreathingCycle();
                toggleBtn.textContent = 'Pause';
                
                // Start session timer
                breathingTimer = setInterval(() => {
                    breathingSessionTime++;
                    updateBreathingDisplay();
                }, 1000);
            }
        }

        function startBreathingCycle() {
            let phaseIndex = 0;
            let phaseStartTime = Date.now();
            
            const circle = document.getElementById('breathing-circle');
            const text = document.getElementById('breathing-text');
            
            if (circle) circle.classList.add('breathing-active');
            
            function runPhase() {
                const phase = currentBreathingTechnique.phases[phaseIndex];
                const elapsedTime = Date.now() - phaseStartTime;
                
                // Update text
                if (text) text.textContent = phase.instruction;
                
                // Update circle animation
                if (circle) {
                    if (phase.name === 'Inhale') {
                        circle.style.transform = 'scale(1.3)';
                        circle.style.backgroundColor = 'rgba(79, 172, 254, 0.3)';
                    } else if (phase.name === 'Exhale') {
                        circle.style.transform = 'scale(0.7)';
                        circle.style.backgroundColor = 'rgba(255, 215, 0, 0.3)';
                    } else {
                        circle.style.transform = 'scale(1)';
                        circle.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                    }
                    circle.style.transition = `all ${phase.duration}ms ease-in-out`;
                }
                
                if (elapsedTime >= phase.duration) {
                    phaseIndex = (phaseIndex + 1) % currentBreathingTechnique.phases.length;
                    phaseStartTime = Date.now();
                    
                    // Complete cycle when back to first phase
                    if (phaseIndex === 0) {
                        breathingCycles++;
                        updateBreathingDisplay();
                        
                        // Play completion sound
                        if (audioContext) {
                            playTone(528, 0.1, 200); // Healing frequency chime
                        }
                    }
                }
            }
            
            breathingCycle = setInterval(runPhase, 100);
        }

        function stopBreathing() {
            if (breathingCycle) {
                clearInterval(breathingCycle);
                breathingCycle = null;
            }
            if (breathingTimer) {
                clearInterval(breathingTimer);
                breathingTimer = null;
            }
            
            const toggleBtn = document.getElementById('breathing-toggle');
            const circle = document.getElementById('breathing-circle');
            const text = document.getElementById('breathing-text');
            
            if (toggleBtn) toggleBtn.textContent = 'Start';
            if (circle) {
                circle.classList.remove('breathing-active');
                circle.style.transform = 'scale(1)';
                circle.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
            }
            if (text) text.textContent = 'Select a technique to begin';
            
            // Save session to progress
            if (breathingSessionTime > 0) {
                updateProgress('breathing', Math.floor(breathingSessionTime / 60));
                showNotification(`Breathing session complete! ${breathingCycles} cycles in ${formatTime(breathingSessionTime)}`);
            }
        }

        function adjustBreathingSpeed() {
            if (!currentBreathingTechnique) {
                alert('Please select a breathing technique first');
                return;
            }
            
            const speedFactor = prompt('Adjust breathing speed (0.5 = slower, 1.5 = faster):', '1.0');
            if (speedFactor && !isNaN(speedFactor)) {
                const factor = parseFloat(speedFactor);
                if (factor > 0.3 && factor < 3.0) {
                    // Adjust all phase durations
                    Object.keys(currentBreathingTechnique.phases).forEach(key => {
                        currentBreathingTechnique.phases[key].duration = 
                            currentBreathingTechnique.phases[key].duration / factor;
                    });
                    
                    showNotification(`Breathing speed adjusted to ${Math.round(factor * 100)}%`);
                } else {
                    alert('Speed factor must be between 0.3 and 3.0');
                }
            }
        }

        function updateBreathingDisplay() {
            const cyclesCount = document.getElementById('cycles-count');
            const timer = document.getElementById('breathing-timer');
            
            if (cyclesCount) cyclesCount.textContent = breathingCycles;
            if (timer) timer.textContent = formatTime(breathingSessionTime);
        }

        // Chakra balancing functionality
        let chakraSession = null;
        let currentChakra = 0;

        function openChakraBalancing() {
            showPracticeSection('chakra');
            displayChakraWheel();
        }

        function displayChakraWheel() {
            const content = document.getElementById('chakra-content');
            if (!content) return;
            
            content.innerHTML = `
                <h3>🌈 Chakra Balancing Wheel</h3>
                <div class="chakra-wheel">
                    ${chakraData.map((chakra, index) => `
                        <div class="chakra-point" style="background: linear-gradient(135deg, ${chakra.color}, ${adjustColor(chakra.color, -20)})"
                             onclick="selectChakra(${index})" data-chakra="${index}">
                            <div class="chakra-symbol">${chakra.symbol}</div>
                            <div class="chakra-name">${chakra.name}</div>
                            <div class="chakra-frequency">${chakra.frequency}Hz</div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="chakra-session-panel" id="chakra-session-panel" style="display: none;">
                    <div class="selected-chakra-info" id="selected-chakra-info"></div>
                    
                    <div class="chakra-session-controls">
                        <button onclick="startChakraSession()" id="chakra-start-btn">Begin Chakra Healing</button>
                        <button onclick="startFullChakraSession()">Full Chakra Balance (All 7)</button>
                        <button onclick="stopChakraSession()">Stop Session</button>
                    </div>
                    
                    <div class="chakra-progress" id="chakra-progress" style="display: none;">
                        <div class="current-chakra-display">
                            <div class="chakra-visualization" id="chakra-viz">
                                <div class="spinning-chakra" id="spinning-chakra"></div>
                            </div>
                            <div class="chakra-details" id="chakra-details"></div>
                        </div>
                        
                        <div class="session-timer">
                            <span id="chakra-timer">05:00</span>
                            <div class="progress-bar">
                                <div class="progress-fill" id="chakra-progress-fill"></div>
                            </div>
                        </div>
                        
                        <div class="chakra-affirmation" id="chakra-affirmation"></div>
                    </div>
                </div>
                
                <div class="chakra-guidance">
                    <h4>Chakra Healing Guidance</h4>
                    <p>Select a chakra above to focus on specific healing, or choose "Full Chakra Balance" for a complete session working through all seven energy centers.</p>
                    
                    <div class="chakra-benefits">
                        <h5>Benefits of Chakra Balancing:</h5>
                        <ul>
                            <li>Harmonizes energy flow throughout the body</li>
                            <li>Promotes emotional and spiritual well-being</li>
                            <li>Enhances meditation and awareness</li>
                            <li>Supports physical and mental health</li>
                            <li>Strengthens connection to higher consciousness</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function selectChakra(index) {
            currentChakra = index;
            const chakra = chakraData[index];
            const panel = document.getElementById('chakra-session-panel');
            const info = document.getElementById('selected-chakra-info');
            
            if (panel) panel.style.display = 'block';
            if (info) {
                info.innerHTML = `
                    <div class="chakra-header">
                        <span class="chakra-symbol-large">${chakra.symbol}</span>
                        <h4>${chakra.name} Chakra</h4>
                    </div>
                    <div class="chakra-properties">
                        <div class="property"><strong>Element:</strong> ${chakra.element}</div>
                        <div class="property"><strong>Frequency:</strong> ${chakra.frequency}Hz</div>
                        <div class="property"><strong>Mantra:</strong> ${chakra.mantra}</div>
                    </div>
                `;
            }
            
            // Highlight selected chakra
            document.querySelectorAll('.chakra-point').forEach(point => {
                point.classList.remove('selected');
            });
            document.querySelector(`[data-chakra="${index}"]`).classList.add('selected');
        }

        function startChakraSession() {
            if (currentChakra === null) {
                alert('Please select a chakra first');
                return;
            }
            
            const chakra = chakraData[currentChakra];
            const duration = 300; // 5 minutes
            
            startChakraHealing(chakra, duration);
        }

        function startFullChakraSession() {
            currentChakra = 0;
            startChakraSequence();
        }

        function startChakraSequence() {
            if (currentChakra >= chakraData.length) {
                completeChakraSession();
                return;
            }
            
            const chakra = chakraData[currentChakra];
            const duration = 180; // 3 minutes per chakra
            
            showNotification(`Starting ${chakra.name} Chakra healing...`);
            startChakraHealing(chakra, duration, () => {
                currentChakra++;
                setTimeout(() => startChakraSequence(), 1000);
            });
        }

        function startChakraHealing(chakra, duration, onComplete = null) {
            const progress = document.getElementById('chakra-progress');
            const viz = document.getElementById('spinning-chakra');
            const details = document.getElementById('chakra-details');
            const affirmation = document.getElementById('chakra-affirmation');
            const timer = document.getElementById('chakra-timer');
            const progressFill = document.getElementById('chakra-progress-fill');
            
            if (progress) progress.style.display = 'block';
            
            // Set up visualization
            if (viz) {
                viz.style.background = `radial-gradient(circle, ${chakra.color}, ${adjustColor(chakra.color, -30)})`;
                viz.style.animation = 'chakraSpin 4s linear infinite';
            }
            
            if (details) {
                details.innerHTML = `
                    <h4>${chakra.symbol} ${chakra.name} Chakra</h4>
                    <div class="mantra-display">Mantra: ${chakra.mantra}</div>
                    <div class="frequency-display">Frequency: ${chakra.frequency}Hz</div>
                `;
            }
            
            // Play healing frequency
            if (audioContext) {
                playHealingFrequency(chakra.frequency);
            }
            
            // Display chakra-specific affirmations
            const chakraAffirmations = getChakraAffirmations(chakra.name);
            let affirmationIndex = 0;
            
            function updateAffirmation() {
                if (affirmation) {
                    affirmation.textContent = chakraAffirmations[affirmationIndex];
                    affirmationIndex = (affirmationIndex + 1) % chakraAffirmations.length;
                }
            }
            
            updateAffirmation();
            const affirmationInterval = setInterval(updateAffirmation, 15000);
            
            // Timer countdown
            let timeRemaining = duration;
            const timerInterval = setInterval(() => {
                if (timeRemaining > 0) {
                    timeRemaining--;
                    const minutes = Math.floor(timeRemaining / 60);
                    const seconds = timeRemaining % 60;
                    if (timer) timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    // Update progress bar
                    const progressPercent = ((duration - timeRemaining) / duration) * 100;
                    if (progressFill) progressFill.style.width = `${progressPercent}%`;
                } else {
                    clearInterval(timerInterval);
                    clearInterval(affirmationInterval);
                    
                    if (onComplete) {
                        onComplete();
                    } else {
                        completeChakraSession();
                    }
                }
            }, 1000);
            
            chakraSession = { timerInterval, affirmationInterval };
        }

        function stopChakraSession() {
            if (chakraSession) {
                clearInterval(chakraSession.timerInterval);
                clearInterval(chakraSession.affirmationInterval);
                chakraSession = null;
            }
            
            stopAmbientSound();
            
            const progress = document.getElementById('chakra-progress');
            if (progress) progress.style.display = 'none';
            
            showNotification('Chakra session stopped');
        }

        function completeChakraSession() {
            stopChakraSession();
            updateProgress('chakra', 5);
            showNotification('Chakra balancing session complete! 🌈✨');
            
            // Play completion chime
            if (audioContext) {
                playTone(528, 0.2, 1000);
            }
        }

        function getChakraAffirmations(chakraName) {
            const affirmationMap = {
                'Root': [
                    'I am grounded and secure in my being',
                    'I trust the process of life',
                    'I am safe and protected',
                    'My foundation is strong and stable'
                ],
                'Sacral': [
                    'I embrace my creativity and passion',
                    'I honor my emotions and desires',
                    'I flow with life naturally',
                    'I am worthy of pleasure and joy'
                ],
                'Solar Plexus': [
                    'I am confident in my personal power',
                    'I trust my inner wisdom',
                    'I am worthy of respect and love',
                    'I manifest my dreams with ease'
                ],
                'Heart': [
                    'I give and receive love freely',
                    'My heart is open to compassion',
                    'I forgive myself and others',
                    'Love flows through me abundantly'
                ],
                'Throat': [
                    'I speak my truth with clarity',
                    'I express myself authentically',
                    'My voice matters and is heard',
                    'I communicate with love and wisdom'
                ],
                'Third Eye': [
                    'I trust my intuition and inner knowing',
                    'I see clearly with divine vision',
                    'I am connected to universal wisdom',
                    'My perception is clear and focused'
                ],
                'Crown': [
                    'I am connected to divine consciousness',
                    'I am one with the universe',
                    'Divine wisdom flows through me',
                    'I am a channel for divine light'
                ]
            };
            
            return affirmationMap[chakraName] || affirmations;
        }

        function adjustColor(color, percent) {
            const f = parseInt(color.slice(1), 16);
            const t = percent < 0 ? 0 : 255;
            const p = percent < 0 ? percent * -1 : percent;
            const R = f >> 16;
            const G = f >> 8 & 0x00FF;
            const B = f & 0x0000FF;
            return "#" + (0x1000000 + (Math.round((t - R) * p / 100) + R) * 0x10000 +
                (Math.round((t - G) * p / 100) + G) * 0x100 +
                (Math.round((t - B) * p / 100) + B)).toString(16).slice(1);
        }

        function playHealingFrequency(frequency) {
            if (!audioContext) return;
            
            // Create oscillator for the healing frequency
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.5);
            
            oscillator.start();
            
            // Store for cleanup
            ambientNodes.push({ oscillator, gainNode });
        }

        // Session Functions
        function openGuidedMeditation() {
            showSessionModal('Guided Meditation');
            loadGuidedMeditationContent();
            initializeAmbientVisualizations();
        }

        function initializeAmbientVisualizations() {
            const modalContent = document.querySelector('.session-content');
            
            // Add ambient visualization
            const ambientContainer = document.createElement('div');
            ambientContainer.className = 'ambient-visualization';
            ambientContainer.innerHTML = `
                <div class="ambient-particles">
                    ${Array.from({length: 15}, (_, i) => 
                        `<div class="particle particle-${i + 1}"></div>`
                    ).join('')}
                </div>
                <div class="meditation-focus">
                    <div class="focus-center">
                        <div class="focus-ripple"></div>
                        <div class="focus-ripple"></div>
                        <div class="focus-ripple"></div>
                    </div>
                    <p class="focus-text">Focus on your breath and let your mind settle</p>
                </div>
            `;
            
            modalContent.insertBefore(ambientContainer, modalContent.firstChild);
            
            // Randomize particle positions
            const particles = ambientContainer.querySelectorAll('.particle');
            particles.forEach(particle => {
                const left = Math.random() * 100;
                const top = Math.random() * 100;
                const delay = Math.random() * 15;
                
                particle.style.left = left + '%';
                particle.style.top = top + '%';
                particle.style.animationDelay = delay + 's';
            });
        }

        function openBreathingExercises() {
            showSessionModal('Breathing Exercises');
            loadBreathingContent();
            initializeBreathingAnimations();
        }

        function initializeBreathingAnimations() {
            const modalContent = document.querySelector('.session-content');
            
            // Add breathing circle visual guide
            const breathingGuide = document.createElement('div');
            breathingGuide.className = 'breathing-guide';
            breathingGuide.innerHTML = `
                <div class="breath-circle">
                    <div class="breath-inner-circle"></div>
                    <div class="breath-text">Breathe</div>
                </div>
                <div class="breath-instructions">
                    <p class="breath-phase">Inhale</p>
                    <p class="breath-count">4</p>
                </div>
            `;
            
            // Insert breathing guide at the beginning of content
            modalContent.insertBefore(breathingGuide, modalContent.firstChild);
            
            // Start breathing animation cycle
            startBreathingCycle();
        }

        let breathingCycle;

        function startBreathingCycle() {
            const circle = document.querySelector('.breath-circle');
            const innerCircle = document.querySelector('.breath-inner-circle');
            const phaseText = document.querySelector('.breath-phase');
            const countText = document.querySelector('.breath-count');
            
            let phase = 'inhale';
            let count = 4;
            
            // Clear any existing cycle
            if (breathingCycle) clearInterval(breathingCycle);
            
            breathingCycle = setInterval(() => {
                count--;
                countText.textContent = count;
                
                if (count === 0) {
                    if (phase === 'inhale') {
                        phase = 'hold';
                        phaseText.textContent = 'Hold';
                        circle.classList.add('breath-hold');
                        innerCircle.classList.add('breath-hold');
                        count = 4;
                    } else if (phase === 'hold') {
                        phase = 'exhale';
                        phaseText.textContent = 'Exhale';
                        circle.classList.remove('breath-hold');
                        circle.classList.add('breath-exhale');
                        innerCircle.classList.remove('breath-hold');
                        innerCircle.classList.add('breath-exhale');
                        count = 4;
                    } else {
                        phase = 'inhale';
                        phaseText.textContent = 'Inhale';
                        circle.classList.remove('breath-exhale');
                        innerCircle.classList.remove('breath-exhale');
                        count = 4;
                    }
                }
            }, 1000);
        }

        function openChakraBalancing() {
            showSessionModal('Chakra Balancing');
            loadChakraContent();
        }

        function openMindfulness() {
            showSessionModal('Mindfulness Practice');
            loadMindfulnessContent();
        }

        function openLovingKindness() {
            showSessionModal('Loving-Kindness Meditation');
            loadLovingKindnessContent();
        }

        function openSilentMeditation() {
            showSessionModal('Silent Meditation');
            loadSilentMeditationContent();
        }

        function showSessionModal(title) {
            document.getElementById('session-title').textContent = title;
            document.getElementById('session-modal').style.display = 'flex';
        }

        function closeSession() {
            stopSession();
            document.getElementById('session-modal').style.display = 'none';
        }

        function loadGuidedMeditationContent() {
            const content = document.getElementById('session-content');
            
            const meditationCards = guidedMeditations.map(meditation => `
                <div class="meditation-option-card" onclick="startGuidedSession('${meditation.id}')">
                    <div class="option-header">
                        <h4>${meditation.title}</h4>
                        <span class="duration-badge">${meditation.duration} min</span>
                    </div>
                    <p class="option-description">${meditation.description}</p>
                    <div class="option-features">
                        <span class="feature-tag">${meditation.category}</span>
                        <span class="feature-tag">🎵 ${ambientSounds[meditation.ambientSound]?.name || 'Silence'}</span>
                        <span class="feature-tag">🎼 ${typeof meditation.frequency === 'number' ? meditation.frequency + 'Hz' : 'Multi-frequency'}</span>
                    </div>
                </div>
            `).join('');

            content.innerHTML = `
                <div class="guided-session-selector">
                    <div class="progress-display">
                        <div class="stat-item">
                            <div class="stat-value">${meditationProgress.totalMinutes}</div>
                            <div class="stat-label">Total Minutes</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${meditationProgress.streak}</div>
                            <div class="stat-label">Day Streak</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${meditationProgress.achievements.length}</div>
                            <div class="stat-label">Achievements</div>
                        </div>
                    </div>

                    <h3>Choose Your Guided Journey</h3>
                    <p class="selection-subtitle">Each meditation includes healing frequencies and ambient sounds</p>
                    
                    <div class="meditation-options-grid">
                        ${meditationCards}
                    </div>

                    <div class="custom-session">
                        <h4>Create Custom Session</h4>
                        <div class="custom-controls">
                            <div class="control-group">
                                <label>Duration:</label>
                                <select id="custom-duration">
                                    <option value="5">5 minutes</option>
                                    <option value="10">10 minutes</option>
                                    <option value="15">15 minutes</option>
                                    <option value="20">20 minutes</option>
                                    <option value="30">30 minutes</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label>Ambient Sound:</label>
                                <select id="custom-ambient">
                                    ${Object.entries(ambientSounds).map(([key, sound]) => 
                                        `<option value="${key}">${sound.name}</option>`
                                    ).join('')}
                                    <option value="none">Silence</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label>Healing Frequency:</label>
                                <select id="custom-frequency">
                                    <option value="528">528 Hz - Love</option>
                                    <option value="639">639 Hz - Heart</option>
                                    <option value="741">741 Hz - Intuition</option>
                                    <option value="852">852 Hz - Spiritual</option>
                                    <option value="963">963 Hz - Divine</option>
                                    <option value="none">No Frequency</option>
                                </select>
                            </div>
                        </div>
                        <button class="meditation-btn" onclick="startCustomSession()">Start Custom Session</button>
                    </div>
                </div>

                <style>
                    .guided-session-selector {
                        max-width: 800px;
                        margin: 0 auto;
                    }

                    .progress-display {
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        gap: 1rem;
                        margin-bottom: 2rem;
                        padding: 1.5rem;
                        background: rgba(255, 255, 255, 0.05);
                        border-radius: 15px;
                        border: 1px solid var(--glass-border);
                    }

                    .stat-item {
                        text-align: center;
                    }

                    .stat-value {
                        font-size: 2rem;
                        font-weight: 700;
                        color: var(--accent-blue);
                        margin-bottom: 0.5rem;
                    }

                    .stat-label {
                        color: rgba(255, 255, 255, 0.7);
                        font-size: 0.9rem;
                    }

                    .selection-subtitle {
                        text-align: center;
                        color: rgba(255, 255, 255, 0.7);
                        margin-bottom: 2rem;
                    }

                    .meditation-options-grid {
                        display: grid;
                        gap: 1.5rem;
                        margin-bottom: 3rem;
                    }

                    .meditation-option-card {
                        background: rgba(255, 255, 255, 0.05);
                        border: 1px solid var(--glass-border);
                        border-radius: 15px;
                        padding: 1.5rem;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    }

                    .meditation-option-card:hover {
                        background: rgba(255, 255, 255, 0.1);
                        border-color: var(--accent-blue);
                        transform: translateY(-3px);
                    }

                    .option-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 1rem;
                    }

                    .option-header h4 {
                        color: var(--accent-blue);
                        margin: 0;
                    }

                    .duration-badge {
                        background: var(--accent-green);
                        color: white;
                        padding: 0.3rem 0.8rem;
                        border-radius: 12px;
                        font-size: 0.8rem;
                        font-weight: 600;
                    }

                    .option-description {
                        color: rgba(255, 255, 255, 0.8);
                        margin-bottom: 1rem;
                        line-height: 1.5;
                    }

                    .option-features {
                        display: flex;
                        gap: 0.5rem;
                        flex-wrap: wrap;
                    }

                    .feature-tag {
                        background: rgba(79, 195, 247, 0.2);
                        color: var(--accent-blue);
                        padding: 0.3rem 0.6rem;
                        border-radius: 8px;
                        font-size: 0.8rem;
                    }

                    .custom-session {
                        background: rgba(255, 255, 255, 0.03);
                        border: 1px solid var(--glass-border);
                        border-radius: 15px;
                        padding: 2rem;
                    }

                    .custom-session h4 {
                        color: var(--accent-green);
                        margin-bottom: 1.5rem;
                        text-align: center;
                    }

                    .custom-controls {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 1rem;
                        margin-bottom: 2rem;
                    }

                    .control-group {
                        display: flex;
                        flex-direction: column;
                        gap: 0.5rem;
                    }

                    .control-group label {
                        color: rgba(255, 255, 255, 0.8);
                        font-weight: 500;
                    }

                    .control-group select {
                        background: rgba(255, 255, 255, 0.1);
                        border: 1px solid var(--glass-border);
                        color: white;
                        padding: 0.8rem;
                        border-radius: 8px;
                        font-size: 0.9rem;
                    }

                    .control-group select:focus {
                        outline: none;
                        border-color: var(--accent-blue);
                    }

                    @media (max-width: 768px) {
                        .progress-display {
                            grid-template-columns: repeat(2, 1fr);
                            gap: 0.8rem;
                        }

                        .custom-controls {
                            grid-template-columns: 1fr;
                        }
                    }
                </style>
            `;
        }

        function startGuidedSession(meditationId) {
            currentMeditation = guidedMeditations.find(m => m.id === meditationId);
            if (!currentMeditation) return;

            currentSession.type = 'guided';
            currentSession.startTime = Date.now();
            
            // Start ambient sound
            if (currentMeditation.ambientSound) {
                startAmbientSound(currentMeditation.ambientSound);
            }

            // Start healing frequency
            if (typeof currentMeditation.frequency === 'number') {
                playHealingFrequency(currentMeditation.frequency);
            }

            // Load session interface
            loadMeditationSession(currentMeditation);
            
            // Start meditation script
            startMeditationScript(currentMeditation);
        }

        function startCustomSession() {
            const duration = parseInt(document.getElementById('custom-duration').value);
            const ambient = document.getElementById('custom-ambient').value;
            const frequency = document.getElementById('custom-frequency').value;

            const customMeditation = {
                id: 'custom',
                title: 'Custom Session',
                duration: duration,
                ambientSound: ambient !== 'none' ? ambient : null,
                frequency: frequency !== 'none' ? parseInt(frequency) : null,
                script: [
                    { time: 0, text: "Begin your custom meditation session..." },
                    { time: Math.floor(duration * 60 * 0.8), text: "Prepare to complete your session..." }
                ]
            };

            currentMeditation = customMeditation;
            startGuidedSession('custom');
        }

        function loadMeditationSession(meditation) {
            const content = document.getElementById('session-content');
            content.innerHTML = `
                <div class="active-meditation">
                    <div class="meditation-info">
                        <h3>${meditation.title}</h3>
                        <p>Duration: ${meditation.duration} minutes</p>
                        ${meditation.ambientSound ? `<p>🎵 ${ambientSounds[meditation.ambientSound].name}</p>` : ''}
                        ${meditation.frequency ? `<p>🎼 ${meditation.frequency}Hz healing frequency</p>` : ''}
                    </div>

                    <div class="timer-display" id="session-timer">${meditation.duration}:00</div>
                    
                    <div class="meditation-guidance" id="guidance-text">
                        Preparing your meditation space...
                    </div>

                    <div class="session-progress">
                        <div class="progress-ring">
                            <svg>
                                <circle class="background" cx="100" cy="100" r="90"></circle>
                                <circle class="progress" cx="100" cy="100" r="90" 
                                    stroke-dasharray="565.48" 
                                    stroke-dashoffset="565.48" 
                                    id="session-progress-circle"></circle>
                            </svg>
                        </div>
                    </div>

                    <div class="session-controls">
                        <button class="control-btn" onclick="pauseSession()" id="pause-btn">Pause</button>
                        <button class="control-btn" onclick="stopSession()">End Session</button>
                        <button class="control-btn" onclick="adjustVolume()">🔊 Volume</button>
                    </div>
                </div>

                <style>
                    .active-meditation {
                        text-align: center;
                        max-width: 600px;
                        margin: 0 auto;
                    }

                    .meditation-info {
                        background: rgba(255, 255, 255, 0.05);
                        border-radius: 15px;
                        padding: 1.5rem;
                        margin-bottom: 2rem;
                    }

                    .meditation-info h3 {
                        color: var(--accent-blue);
                        margin-bottom: 1rem;
                    }

                    .meditation-info p {
                        color: rgba(255, 255, 255, 0.8);
                        margin: 0.5rem 0;
                    }

                    .meditation-guidance {
                        background: rgba(255, 255, 255, 0.03);
                        border: 1px solid var(--glass-border);
                        border-radius: 15px;
                        padding: 2rem;
                        margin: 2rem 0;
                        min-height: 100px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 1.1rem;
                        line-height: 1.6;
                        color: rgba(255, 255, 255, 0.9);
                        font-style: italic;
                    }

                    .session-progress {
                        margin: 2rem 0;
                    }
                </style>
            `;

            // Start timer
            startTimer(meditation.duration * 60);
        }

        function startMeditationScript(meditation) {
            if (!meditation.script) return;

            meditation.script.forEach(instruction => {
                setTimeout(() => {
                    const guidanceElement = document.getElementById('guidance-text');
                    if (guidanceElement && currentSession.isActive) {
                        guidanceElement.textContent = instruction.text;
                        
                        // Add gentle fade animation
                        guidanceElement.style.opacity = '0';
                        setTimeout(() => {
                            guidanceElement.style.opacity = '1';
                        }, 100);
                    }
                }, instruction.time * 1000);
            });
        }

        function loadBreathingContent() {
            const content = document.getElementById('session-content');
            content.innerHTML = `
                <div class="breathing-selector">
                    <h3>Select Breathing Technique</h3>
                    <div class="breathing-options">
                        <button class="control-btn" onclick="startBreathing('478')">4-7-8 Breathing</button>
                        <button class="control-btn" onclick="startBreathing('box')">Box Breathing</button>
                        <button class="control-btn" onclick="startBreathing('wim')">Wim Hof Method</button>
                    </div>
                    <div id="breathing-display" class="breathing-display">
                        <div class="progress-ring">
                            <svg>
                                <circle class="background" cx="100" cy="100" r="90"></circle>
                                <circle class="progress" cx="100" cy="100" r="90" stroke-dasharray="565.48" stroke-dashoffset="565.48" id="breathing-circle"></circle>
                            </svg>
                        </div>
                        <div class="breathing-guide" id="breathing-guide">Choose a breathing technique above</div>
                        <div class="session-controls">
                            <button class="control-btn" onclick="stopSession()">Stop</button>
                            <button class="control-btn" onclick="pauseSession()">Pause</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadChakraContent() {
            const content = document.getElementById('session-content');
            const chakraWheel = chakraData.map((chakra, index) => 
                `<div class="chakra" style="background: ${chakra.color}" onclick="activateChakra(${index})" data-chakra="${index}">${chakra.symbol}</div>`
            ).join('');
            
            content.innerHTML = `
                <div class="chakra-session">
                    <h3>Chakra Balancing Session</h3>
                    <p>Click on a chakra to focus your meditation</p>
                    <div class="chakra-wheel">${chakraWheel}</div>
                    <div class="timer-display" id="timer">00:00</div>
                    <div class="session-controls">
                        <button class="control-btn" onclick="startChakraSession()">Start Session</button>
                        <button class="control-btn" onclick="stopSession()">Stop</button>
                    </div>
                    <div class="affirmations">
                        <div class="affirmation-text" id="affirmation"></div>
                    </div>
                </div>
            `;
            
            cycleAffirmations();
        }

        function loadMindfulnessContent() {
            const content = document.getElementById('session-content');
            content.innerHTML = `
                <div class="mindfulness-session">
                    <h3>Mindfulness Practice</h3>
                    <div class="practice-options">
                        <button class="control-btn" onclick="startBodyScan()">Body Scan</button>
                        <button class="control-btn" onclick="startWalkingMeditation()">Walking Meditation</button>
                        <button class="control-btn" onclick="startMindfulBreathing()">Mindful Breathing</button>
                    </div>
                    <div class="timer-display" id="timer">00:00</div>
                    <div class="practice-guide" id="mindfulness-guide">Select a practice to begin</div>
                    <div class="session-controls">
                        <button class="control-btn" onclick="stopSession()">End Practice</button>
                    </div>
                </div>
            `;
        }

        function loadLovingKindnessContent() {
            const content = document.getElementById('session-content');
            content.innerHTML = `
                <div class="loving-kindness-session">
                    <h3>Loving-Kindness Meditation</h3>
                    <div class="timer-display" id="timer">00:00</div>
                    <div class="kindness-guide" id="kindness-guide">
                        Begin by sending love to yourself...
                    </div>
                    <div class="session-controls">
                        <button class="control-btn" onclick="startLovingKindness()">Begin</button>
                        <button class="control-btn" onclick="stopSession()">End</button>
                    </div>
                </div>
            `;
        }

        function loadSilentMeditationContent() {
            const content = document.getElementById('session-content');
            content.innerHTML = `
                <div class="silent-session">
                    <h3>Silent Meditation</h3>
                    <div class="duration-selector">
                        <label>Session Duration:</label>
                        <select id="duration-select">
                            <option value="5">5 minutes</option>
                            <option value="10" selected>10 minutes</option>
                            <option value="15">15 minutes</option>
                            <option value="20">20 minutes</option>
                            <option value="30">30 minutes</option>
                            <option value="60">60 minutes</option>
                        </select>
                    </div>
                    <div class="timer-display" id="timer">10:00</div>
                    <div class="session-controls">
                        <button class="control-btn" onclick="startSilentSession()">Start</button>
                        <button class="control-btn" onclick="pauseSession()">Pause</button>
                        <button class="control-btn" onclick="stopSession()">Stop</button>
                    </div>
                </div>
            `;
        }

        // Session Control Functions
        function startSilentSession() {
            const duration = parseInt(document.getElementById('duration-select').value);
            startTimer(duration * 60);
        }

        function startTimer(seconds) {
            currentSession.duration = seconds;
            currentSession.timeRemaining = seconds;
            currentSession.isActive = true;
            
            currentSession.interval = setInterval(() => {
                if (currentSession.timeRemaining > 0) {
                    currentSession.timeRemaining--;
                    updateTimerDisplay();
                } else {
                    completeSession();
                }
            }, 1000);
            
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(currentSession.timeRemaining / 60);
            const seconds = currentSession.timeRemaining % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const timer = document.getElementById('timer');
            if (timer) timer.textContent = display;
        }

        function pauseSession() {
            if (currentSession.isActive) {
                clearInterval(currentSession.interval);
                currentSession.isActive = false;
            }
        }

        function stopSession() {
            if (currentSession.interval) {
                clearInterval(currentSession.interval);
            }
            currentSession.isActive = false;
            currentSession.timeRemaining = 0;
        }

        function completeSession() {
            stopSession();
            alert('🧘 Session complete! Well done on your practice. ✨');
        }

        // Breathing Exercises
        function startBreathing(technique) {
            const guide = document.getElementById('breathing-guide');
            const circle = document.getElementById('breathing-circle');
            
            let phases, timings;
            
            switch(technique) {
                case '478':
                    phases = ['Inhale for 4...', 'Hold for 7...', 'Exhale for 8...'];
                    timings = [4000, 7000, 8000];
                    break;
                case 'box':
                    phases = ['Inhale for 4...', 'Hold for 4...', 'Exhale for 4...', 'Hold for 4...'];
                    timings = [4000, 4000, 4000, 4000];
                    break;
                case 'wim':
                    phases = ['Inhale deeply...', 'Exhale fully...'];
                    timings = [2000, 2000];
                    break;
            }
            
            let currentPhase = 0;
            
            function breathingCycle() {
                if (!currentSession.isActive) return;
                
                guide.textContent = phases[currentPhase];
                
                // Animate circle
                const circumference = 565.48;
                const progress = (currentPhase + 1) / phases.length;
                const offset = circumference - (progress * circumference);
                circle.style.strokeDashoffset = offset;
                
                setTimeout(() => {
                    currentPhase = (currentPhase + 1) % phases.length;
                    breathingCycle();
                }, timings[currentPhase]);
            }
            
            currentSession.isActive = true;
            breathingCycle();
        }

        // Chakra Functions
        function activateChakra(index) {
            const chakras = document.querySelectorAll('.chakra');
            chakras.forEach(c => c.classList.remove('active'));
            chakras[index].classList.add('active');
            
            const chakra = chakraData[index];
            document.getElementById('affirmation').textContent = 
                `Focus on your ${chakra.name} chakra. Visualize ${chakra.color} light.`;
        }

        function startChakraSession() {
            startTimer(20 * 60); // 20 minute session
            
            let currentChakra = 0;
            const chakraInterval = setInterval(() => {
                if (currentSession.isActive && currentChakra < chakraData.length) {
                    activateChakra(currentChakra);
                    currentChakra++;
                } else {
                    clearInterval(chakraInterval);
                }
            }, (20 * 60 * 1000) / 7); // Divide session time by 7 chakras
        }

        function cycleAffirmations() {
            let index = 0;
            setInterval(() => {
                const affirmationEl = document.getElementById('affirmation');
                if (affirmationEl) {
                    affirmationEl.textContent = affirmations[index];
                    index = (index + 1) % affirmations.length;
                }
            }, 5000);
        }

        // Close modal when clicking outside
        document.getElementById('session-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSession();
            }
        });

        // Handle escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeSession();
            }
        });

        // Performance tracking
        window.addEventListener('load', () => {
            console.log('🧘 Meditation & Mindfulness center loaded successfully');
            validateMeditationFunctions();
        });

        // Meditation Function Validation System
        function validateMeditationFunctions() {
            const requiredFunctions = [
                'startSession', 'closeSession', 'loadMindfulnessContent',
                'loadLovingKindnessContent', 'loadChakraContent', 'loadBreathworkContent',
                'startBodyScan', 'startWalkingMeditation', 'startMindfulBreathing'
            ];
            
            const missing = [];
            requiredFunctions.forEach(funcName => {
                if (typeof window[funcName] !== 'function') {
                    missing.push(funcName);
                }
            });
            
            if (missing.length > 0) {
                console.warn('⚠️ Meditation: Missing functions:', missing);
                return false;
            }
            
            console.log('✅ Meditation: All functions validated successfully');
            return true;
        }

        // Enhanced Error Handling for Meditation Operations
        function handleMeditationError(operation, error) {
            console.error(`🧘 Meditation Error in ${operation}:`, error);
            
            // Show peaceful notification
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="
                    position: fixed; top: 20px; right: 20px; z-index: 10000;
                    background: linear-gradient(135deg, #059669, #047857);
                    color: white; padding: 1rem; border-radius: 12px;
                    box-shadow: 0 10px 30px rgba(5, 150, 105, 0.3);
                    animation: slideInRight 0.5s ease;
                ">
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">🧘 Meditation Center</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">
                        Peace is restored. Your practice continues smoothly.
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // Prevent duplicate event listeners
        document.addEventListener('DOMContentLoaded', function() {
            if (window.meditationListenersInitialized) return;
            window.meditationListenersInitialized = true;
            
            console.log('🧘 Meditation enhanced listeners initialized');
        });
    </script>
</body>
</html>