<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enoch Calendar - Divine Temple</title>
    <!-- ... Styles are unchanged for brevity, use previous design ... -->
    <style>
        /* Use your previous style block here - unchanged for brevity. */
        /* ... All previous styles ... */
    </style>
</head>
<body>
    <div class="calendar-container">
        <button class="back-btn" onclick="window.parent.postMessage('back', '*')">
            ‚Üê Back to Temple
        </button>
        <div class="calendar-header">
            <div style="font-size: 4rem; margin-bottom: 1rem; animation: lunarGlow 4s ease-in-out infinite;">üìÖ</div>
            <h1 class="calendar-title">Enoch Calendar</h1>
            <p class="calendar-subtitle">Divine timing according to the sacred Enochian 364-day solar calendar</p>
        </div>

        <!-- Enhanced Calendar Interface: Enochian -->
        <div class="calendar-main-interface">
            <!-- Calendar View Panel -->
            <div class="calendar-view-panel">
                <!-- Calendar Navigation -->
                <div class="calendar-nav">
                    <button class="nav-btn" onclick="previousMonth()">‚Üê Previous Month</button>
                    <div class="current-month" id="current-month"></div>
                    <button class="nav-btn" onclick="nextMonth()">Next Month ‚Üí</button>
                </div>

                <!-- Calendar Grid -->
                <div class="calendar-grid" id="calendar-grid">
                    <!-- Calendar headers -->
                    <div class="calendar-day-header">Day 1</div>
                    <div class="calendar-day-header">Day 2</div>
                    <div class="calendar-day-header">Day 3</div>
                    <div class="calendar-day-header">Day 4</div>
                    <div class="calendar-day-header">Day 5</div>
                    <div class="calendar-day-header">Day 6</div>
                    <div class="calendar-day-header">Day 7</div>
                    <!-- Calendar days will be generated by JavaScript -->
                </div>

                <!-- Lunar Phase Display -->
                <div class="lunar-panel">
                    <h4 class="lunar-title">üåô Symbolic Lunar Phase</h4>
                    <div class="lunar-display" id="lunar-display">
                        <div class="moon-phase" id="moon-phase">üåï</div>
                        <div class="lunar-info">
                            <div class="phase-name" id="phase-name">Renewal</div>
                            <div class="phase-energy" id="phase-energy">
                                Every season brings renewal. Each quarter is marked by divine alignment as the Enochian calendar resets the appointed times.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Meditation Scheduler -->
                <div class="scheduler-panel">
                    <h4 class="sidebar-title">‚è∞ Schedule Sacred Time</h4>
                    <div class="scheduler-form">
                        <div class="form-group">
                            <label class="form-label">Practice Type</label>
                            <select class="form-input" id="practice-type">
                                <option value="meditation">Meditation</option>
                                <option value="prayer">Prayer</option>
                                <option value="gratitude">Gratitude Practice</option>
                                <option value="reflection">Daily Reflection</option>
                                <option value="study">Sacred Study</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Month</label>
                            <select class="form-input" id="practice-month"></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Day (1-30 or Quarter Day)</label>
                            <select class="form-input" id="practice-day"></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Weekday (1-7)</label>
                            <select class="form-input" id="practice-weekday"></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Duration (minutes)</label>
                            <input type="number" class="form-input" id="practice-duration" placeholder="20" min="5" max="120">
                        </div>
                        <button class="schedule-btn" onclick="schedulePractice()">üéØ Schedule Practice</button>
                    </div>
                </div>
            </div>

            <!-- Calendar Sidebar: unchanged, events logic will be Enochian -->
            <div class="calendar-sidebar">
                <div class="sidebar-section">
                    <h4 class="sidebar-title">üåü Today's Enochian Events</h4>
                    <div class="event-list" id="todays-events"></div>
                </div>
                <div class="sidebar-section">
                    <h4 class="sidebar-title">üé≠ Upcoming Divine Quarters</h4>
                    <div class="event-list" id="upcoming-holidays"></div>
                </div>
                <div class="sidebar-section">
                    <h4 class="sidebar-title">üìä Your Sacred Journey</h4>
                    <div class="calendar-stats">
                        <!-- Unchanged stat blocks -->
                        <div class="stat-card"><div class="stat-number" id="meditation-sessions">23</div><div class="stat-label">Meditation Sessions</div></div>
                        <div class="stat-card"><div class="stat-number" id="prayer-days">47</div><div class="stat-label">Prayer Days</div></div>
                        <div class="stat-card"><div class="stat-number" id="reflection-entries">31</div><div class="stat-label">Reflection Entries</div></div>
                        <div class="stat-card"><div class="stat-number" id="sacred-celebrations">12</div><div class="stat-label">Sacred Celebrations</div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Astrological Events Panel -->
        <div class="astro-panel">
            <h3 class="astro-title">‚ú® Enochian Quarter Days & Celestial Influences</h3>
            <div class="astro-events" id="astro-events"></div>
        </div>
    </div>

    <!-- Calendar Modal -->
    <div id="calendar-modal" class="calendar-modal-overlay">
        <div class="calendar-modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Day Details</h2>
                <button class="modal-close" onclick="closeCalendarModal()">√ó</button>
            </div>
            <div class="modal-content" id="modal-content"></div>
        </div>
    </div>

<script>
const ENOCH_MONTHS = [
    "Month 1", "Month 2", "Month 3", "Month 4", "Month 5", "Month 6",
    "Month 7", "Month 8", "Month 9", "Month 10", "Month 11", "Month 12"
];
const ENOCH_WEEKDAYS = [
    "Day 1", "Day 2", "Day 3", "Day 4", "Day 5", "Day 6", "Day 7"
];
const ENOCH_SEASON_MARKERS = [
    { month: 3, day: 31, name: "Spring Quarter Day" },
    { month: 6, day: 31, name: "Summer Quarter Day" },
    { month: 9, day: 31, name: "Autumn Quarter Day" },
    { month: 12, day: 31, name: "Winter Quarter Day" }
];

class EnochCalendarSystem {
    constructor() {
        // Enoch year starts at month=1, day=1, weekday=1
        this.todayIndex = this.getEnochDayIndexFromNow();
        this.viewMonth = this.getMonthFromIndex(this.todayIndex);
        this.viewYear = this.getYearFromIndex(this.todayIndex);

        this.data = this.loadData();
        this.init();
    }

    init() {
        this.generateCalendar();
        this.updateLunarPhase();
        this.loadTodaysEvents();
        this.loadUpcomingHolidays();
        this.loadAstrologicalEvents();
        this.updateStats();
        this.setupPerformanceMonitoring();
        this.populateSchedulerFields();
        console.log('üìÖ Enoch Calendar System initialized');
    }

    // Data: use localStorage but you could use server
    loadData() {
        const defaultData = {
            meditation: { sessions: 23, totalMinutes: 1840 },
            prayer: { days: 47, sessions: 156 },
            reflection: { entries: 31, insights: 87 },
            celebrations: { attended: 12, created: 5 },
            scheduledPractices: [],
            customEvents: [],
            progress: { level: 6, exp: 1450, nextLevel: 2000 }
        };
        try {
            const saved = localStorage.getItem('enoch-calendar-data');
            return saved ? { ...defaultData, ...JSON.parse(saved) } : defaultData;
        } catch (error) {
            console.warn('Error loading calendar data, using defaults:', error);
            return defaultData;
        }
    }

    saveData() {
        try {
            localStorage.setItem('enoch-calendar-data', JSON.stringify(this.data));
        } catch (error) {
            console.error('Error saving calendar data:', error);
        }
    }

    // ------ Core Enoch Calendar Logic -------
    getEnochDayIndexFromNow() {
        // Always starts at "year 1, day 1" on 1st Enochian day. Use a fixed reference date
        // For demo, treat Nov 04, 2025 as Year 1, Month 1, Day 1 of Enochian (modify for your reference)
        // If you want to preserve the mapping, use: let startDate = Date.UTC(2025,10,4)
        // We'll map it so Nov 4, 2025 = Enochian Year 1 Day 1, month 1, weekday 1
        let startDate = new Date(Date.UTC(2025, 10, 4)); // 2025-11-04
        let now = new Date();
        let daysDiff = Math.floor((now.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24));
        if(daysDiff < 0) daysDiff = 0;
        return daysDiff % 364;
    }

    getYearFromIndex(idx) {
        // Index is 0-based, returns which Enochian year this is since start.
        let startDate = new Date(Date.UTC(2025, 10, 4));
        let now = new Date();
        let daysDiff = Math.floor((now.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24));
        return Math.floor(daysDiff / 364) + 1;
    }

    getMonthFromIndex(idx) {
        // idx in 0..363 maps to month (1..12)
        return Math.floor(idx / 30) + 1;
    }

    getDayInMonthFromIndex(idx) {
        // Enochian: months have 30 days, plus quarter days at end (for month 3,6,9,12 day 31)
        let day = (idx % 30) + 1;
        return day;
    }

    getWeekdayFromIndex(idx) {
        // 52 weeks, 7 days (plus quarter markers, which can be shown separately)
        return ((idx % 7) + 1);
    }

    generateCalendar() {
        performance.mark('calendar-generate-start');
        const grid = document.getElementById('calendar-grid');
        const monthDisplay = document.getElementById('current-month');
        // Clear existing calendar days
        grid.querySelectorAll('.calendar-day').forEach(day => day.remove());

        // Show Enoch Month + Year
        monthDisplay.textContent = `${ENOCH_MONTHS[this.viewMonth-1]} (Year ${this.viewYear})`;

        // Draw 30 days plus quarter day if needed
        let month = this.viewMonth;
        let startGlobalIndex = (month-1)*30;
        for(let i=0; i<30; i++) {
            let idx = startGlobalIndex + i;
            let day = i+1;
            let weekday = this.getWeekdayFromIndex(idx);
            let dayElement = this.createDayElement(month, day, weekday, idx);
            grid.appendChild(dayElement);
        }
        // Quarter day?
        let marker = ENOCH_SEASON_MARKERS.find(m=>m.month===month);
        if(marker) {
            let quarterElement = this.createQuarterDayElement(marker, startGlobalIndex+30);
            grid.appendChild(quarterElement);
        }
        performance.mark('calendar-generate-end');
        performance.measure('calendar-generate', 'calendar-generate-start', 'calendar-generate-end');
    }

    createDayElement(month, day, weekday, globalDayIdx) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        dayElement.onclick = () => this.openDayDetails(month, day, weekday, globalDayIdx, false);
        let events = this.getEventsForDate(month, day, false);
        if (events.length > 0) dayElement.classList.add('has-events');
        dayElement.innerHTML = `
            <div class="day-number">${day}</div>
            <div class="day-lunar">${this.getSymbolicLunarPhase(month, day)}</div>
            <div class="day-events">
                ${events.slice(0, 3).map(event => `<span class="event-dot event-${event.type}"></span>`).join('')}
            </div>
        `;
        return dayElement;
    }

    createQuarterDayElement(marker, globalDayIdx) {
        const quarterElement = document.createElement('div');
        quarterElement.className = 'calendar-day has-events';
        quarterElement.onclick = () => this.openDayDetails(marker.month, marker.day, null, globalDayIdx, true);
        let events = this.getEventsForDate(marker.month, marker.day, true);
        quarterElement.innerHTML = `
            <div class="day-number" style="color:var(--accent-gold);font-weight:700">Quarter Day</div>
            <div class="day-lunar">${marker.name}</div>
            <div class="day-events">
                ${events.slice(0, 3).map(event => `<span class="event-dot event-sacred"></span>`).join('')}
            </div>
        `;
        return quarterElement;
    }

    getEventsForDate(month, day, isQuarterDay=false) {
        const events = [];
        // Sacred Quarters
        if (isQuarterDay) {
            let marker = ENOCH_SEASON_MARKERS.find(m=>m.month===month && m.day===day);
            if (marker) events.push({ type: 'sacred', title: marker.name, description: 'Season marker for divine times'});
        }
        // Scheduled practices
        const practices = this.data.scheduledPractices.filter(p => p.month==month && p.day==day && p.isQuarterDay==isQuarterDay);
        practices.forEach(practice => {
            events.push({type: 'meditation', title: practice.type, description: `${practice.duration} minutes`});
        });
        return events;
    }

    updateLunarPhase() {
        const moonPhase = document.getElementById('moon-phase');
        const phaseName = document.getElementById('phase-name');
        const phaseEnergy = document.getElementById('phase-energy');
        moonPhase.textContent = 'üåï';
        phaseName.textContent = 'Renewal';
        phaseEnergy.textContent = 'Every season brings renewal and divine alignment as the Enochian calendar resets the appointed times.';
    }

    getSymbolicLunarPhase(month, day) {
        // Simple symbolic alternate: Each quarter month is "Full Moon" (months 3,6,9,12, day 31) else Waxing/Waning alternately
        if (ENOCH_SEASON_MARKERS.find(m=>m.month==month && m.day==day)) return 'üåï';
        if (day <= 15) return 'üåí';
        else return 'üåò';
    }

    // Sidebar Events
    loadTodaysEvents() {
        const container = document.getElementById('todays-events');
        let idx = this.todayIndex;
        let month = this.getMonthFromIndex(idx);
        let day = this.getDayInMonthFromIndex(idx);
        let isQuarterDay = ENOCH_SEASON_MARKERS.some(m=>m.month==month && m.day==day);
        let events = this.getEventsForDate(month, day, isQuarterDay);
        if (events.length === 0) {
            container.innerHTML = `<div class="event-item"><div class="event-title">No sacred events today</div><div class="event-description">A day for reflection and personal alignment.</div></div>`;
            return;
        }
        container.innerHTML = events.map(event => `<div class="event-item"><div class="event-title">${event.title}</div><div class="event-description">${event.description}</div></div>`).join('');
    }

    loadUpcomingHolidays() {
        // Show next sacred quarters
        const container = document.getElementById('upcoming-holidays');
        let idx = this.todayIndex;
        let year = this.getYearFromIndex(idx);
        let remaining = ENOCH_SEASON_MARKERS.filter(m=>
            ((m.month-1)*30+30) > idx
        ).map(m=>({
            date: `Quarter Day: ${ENOCH_MONTHS[m.month-1]}, Day 31, Year ${year}`,
            name: m.name,
            description: 'Season marker. Special day for divine celebration and alignment.'
        }));
        container.innerHTML = remaining.map(holiday=>
            `<div class="event-item">
                <div class="event-date">${holiday.date}</div>
                <div class="event-title">${holiday.name}</div>
                <div class="event-description">${holiday.description}</div>
            </div>`
        ).join('');
    }

    loadAstrologicalEvents() {
        // For Enoch, just show quarter days as celestial marker events
        const container = document.getElementById('astro-events');
        container.innerHTML = ENOCH_SEASON_MARKERS.map(marker=>
            `<div class="astro-event">
                <div class="astro-date">${ENOCH_MONTHS[marker.month-1]} Day 31</div>
                <div class="astro-name">${marker.name}</div>
                <div class="astro-influence">Sacred season marker for spiritual renewal and cosmic alignment.</div>
            </div>`
        ).join('');
    }

    updateStats() {
        const stats = {
            'meditation-sessions': this.data.meditation.sessions,
            'prayer-days': this.data.prayer.days,
            'reflection-entries': this.data.reflection.entries,
            'sacred-celebrations': this.data.celebrations.attended
        };

        Object.entries(stats).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                this.animateNumber(element, value);
            }
        });
    }

    animateNumber(element, targetValue) {
        const startValue = parseInt(element.textContent) || 0;
        const duration = 1000;
        const startTime = performance.now();
        const animate = (currentTime) => {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const easeOutQuart = 1 - Math.pow(1 - progress, 4);
            const currentValue = Math.round(startValue + (targetValue - startValue) * easeOutQuart);
            element.textContent = currentValue;
            if (progress < 1) requestAnimationFrame(animate);
        };
        requestAnimationFrame(animate);
    }

    setupPerformanceMonitoring() {
        const observer = new PerformanceObserver((list) => {
            for (const entry of list.getEntries()) {
                if (entry.entryType === 'measure') {
                    console.log(`üìä ${entry.name}: ${entry.duration.toFixed(2)}ms`);
                }
            }
        });
        observer.observe({ entryTypes: ['measure'] });
    }

    // Navigation
    previousMonth() {
        this.viewMonth = this.viewMonth===1 ? 12 : this.viewMonth-1;
        this.generateCalendar();
    }
    nextMonth() {
        this.viewMonth = this.viewMonth===12 ? 1 : this.viewMonth+1;
        this.generateCalendar();
    }

    // Modal details
    openDayDetails(month, day, weekday, idx, isQuarterDay) {
        const events = this.getEventsForDate(month, day, isQuarterDay);
        const lunarPhase = this.getSymbolicLunarPhase(month, day);
        let content = `
            <div style="text-align:center;margin-bottom:2rem;">
                <h3 style="color: var(--accent-cyan); font-size: 1.8rem; margin-bottom: 1rem;">
                    ${ENOCH_MONTHS[month-1]} Day ${day}${isQuarterDay ? ' (Quarter Day)' : ''}, Year ${this.viewYear}
                </h3>
                <div style="font-size: 3rem; margin-bottom: 1rem;">${lunarPhase}</div>
            </div>
            <div style="margin-bottom:2rem;">
                <h4 style="color:var(--accent-gold);margin-bottom:1rem;">Sacred Events</h4>
                ${events.length>0 ?
                    events.map(event=>
                        `<div style="background:rgba(255,255,255,0.05);padding:1rem;border-radius:10px;margin-bottom:0.5rem;">
                            <div style="font-weight:600;margin-bottom:0.3rem;">${event.title}</div>
                            <div style="color:rgba(255,255,255,0.8);font-size:0.9rem;">${event.description}</div>
                        </div>`).join('')
                    :
                    '<p style="color:rgba(255,255,255,0.7);">No special events on this day.</p>'
                }
            </div>
            <div style="text-align:center;">
                <button class="schedule-btn" onclick="quickSchedule('${month}','${day}','${isQuarterDay}')">‚è∞ Schedule Practice</button>
            </div>
        `;
        this.openCalendarModal(`${ENOCH_MONTHS[month-1]} Day ${day}`, content);
    }

    openCalendarModal(title, content) {
        const modal = document.getElementById('calendar-modal');
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-content').innerHTML = content;
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    updateProgress(category, points = 10) {
        this.data.progress.exp += points;
        if (this.data.progress.exp >= this.data.progress.nextLevel) {
            this.data.progress.level++;
            this.data.progress.exp = 0;
            this.data.progress.nextLevel = Math.floor(this.data.progress.nextLevel * 1.2);
            this.showLevelUp();
        }
        this.saveData();
    }

    showLevelUp() {
        if (typeof window.showAchievement === 'function') {
            window.showAchievement('Level Up!', `You've reached Calendar Level ${this.data.progress.level}!`, 'level-up');
        }
    }

    // Scheduler fields
    populateSchedulerFields() {
        let monthSel = document.getElementById('practice-month');
        monthSel.innerHTML = ENOCH_MONTHS.map((m,i)=>`<option value="${i+1}">${m}</option>`).join('');
        let daySel = document.getElementById('practice-day');
        let weekdaySel = document.getElementById('practice-weekday');
        daySel.innerHTML = '';
        for(let i=1;i<=30;i++) daySel.innerHTML += `<option value="${i}">Day ${i}</option>`;
        // Add Quarter Day option at end of 3,6,9,12
        ['3','6','9','12'].forEach(m=>{
            if(parseInt(monthSel.value)===parseInt(m)) daySel.innerHTML += `<option value="31">Quarter Day</option>`;
        });
        weekdaySel.innerHTML = ENOCH_WEEKDAYS.map((w,i)=>`<option value="${i+1}">${w}</option>`).join('');
    }
}

// System init
let calendarSystem;
document.addEventListener('DOMContentLoaded', () => {
    calendarSystem = new EnochCalendarSystem();
});

function previousMonth() { calendarSystem.previousMonth(); }
function nextMonth() { calendarSystem.nextMonth(); }
function schedulePractice() {
    const type = document.getElementById('practice-type').value;
    const month = parseInt(document.getElementById('practice-month').value);
    const day = parseInt(document.getElementById('practice-day').value);
    const weekday = parseInt(document.getElementById('practice-weekday').value);
    const duration = document.getElementById('practice-duration').value;
    if (!month || !day || !duration) {
        if (typeof window.showNotification === 'function') {
            window.showNotification('Please fill in all fields', 'error');
        }
        return;
    }
    const isQuarterDay = day===31;
    const practice = {
        type, month, day, weekday, duration: parseInt(duration),
        isQuarterDay, id: Date.now(), created: new Date().toISOString()
    };
    calendarSystem.data.scheduledPractices.push(practice);
    calendarSystem.saveData();
    calendarSystem.generateCalendar();
    calendarSystem.updateProgress('scheduling', 15);
    document.getElementById('practice-duration').value = '';
    if (typeof window.showNotification === 'function') {
        window.showNotification(`${type} scheduled successfully! üéØ`, 'success');
    }
}
function quickSchedule(month, day, isQuarterDay) {
    document.getElementById('practice-month').value = month;
    document.getElementById('practice-day').value = day;
    closeCalendarModal();
    document.querySelector('.scheduler-panel').scrollIntoView({behavior:'smooth',block:'center'});
}
function closeCalendarModal() {
    const modal = document.getElementById('calendar-modal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}
document.addEventListener('click', (e) => {
    const modal = document.getElementById('calendar-modal');
    if (e.target === modal) closeCalendarModal();
});
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeCalendarModal();
    if (e.key === 'ArrowLeft' && e.ctrlKey) previousMonth();
    if (e.key === 'ArrowRight' && e.ctrlKey) nextMonth();
});
window.addEventListener('load', () => {
    setTimeout(() => {
        if (performance.getEntriesByType) {
            const navigationEntries = performance.getEntriesByType('navigation');
            if (navigationEntries.length > 0) {
                const loadTime = navigationEntries[0].loadEventEnd - navigationEntries[0].loadEventStart;
                console.log(`üöÄ Enoch Calendar loaded in ${loadTime.toFixed(2)}ms`);
            }
        }
    }, 0);
});
</script>
</body>
</html>
