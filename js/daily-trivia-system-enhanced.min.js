class EnhancedDailyTriviaSystem{constructor(){this.currentUser=null,this.triviaData=null,this.currentQuestionIndex=0,this.score=0,this.correctAnswers=0,this.todaysQuestions=[],this.userAnswers=[],this.questionStartTime=null,this.timerInterval=null,this.timeRemaining=30,this.debugMode=!0,this.audioSystem=null,this.questionBank=[{category:"Chakras & Energy",difficulty:"easy",question:"What color is associated with the Root Chakra?",options:["Red","Orange","Yellow","Green"],correct:0,explanation:"The Root Chakra (Muladhara) is associated with red, representing grounding, survival, and connection to the earth."},{category:"Chakras & Energy",difficulty:"medium",question:"What is the Sanskrit name for the Heart Chakra?",options:["Manipura","Anahata","Vishuddha","Ajna"],correct:1,explanation:"Anahata is the Sanskrit name for the Heart Chakra, which governs love, compassion, and emotional balance."},{category:"Chakras & Energy",difficulty:"medium",question:"Which chakra is associated with personal power and self-esteem?",options:["Root","Solar Plexus","Sacral","Throat"],correct:1,explanation:"The Solar Plexus Chakra (Manipura) governs personal power, confidence, and self-esteem."},{category:"Chakras & Energy",difficulty:"hard",question:"How many main nadis (energy channels) are there in the subtle body according to yogic tradition?",options:["7","72","108","72,000"],correct:3,explanation:"According to yogic tradition, there are 72,000 nadis (energy channels) in the subtle body, with Ida, Pingala, and Sushumna being the three main ones."},{category:"Chakras & Energy",difficulty:"medium",question:"Which chakra is blocked when you experience fear and insecurity?",options:["Root Chakra","Heart Chakra","Crown Chakra","Third Eye"],correct:0,explanation:"The Root Chakra governs feelings of safety and security. When blocked, it can manifest as fear, anxiety, and insecurity."},{category:"Chakras & Energy",difficulty:"hard",question:"What is the bija (seed) mantra for the Third Eye Chakra?",options:["LAM","VAM","RAM","OM"],correct:3,explanation:"OM (or AUM) is the bija mantra for the Third Eye Chakra (Ajna), representing cosmic consciousness and intuition."},{category:"Tarot & Oracle",difficulty:"easy",question:"How many cards are in a traditional Tarot deck?",options:["52","64","78","88"],correct:2,explanation:"A traditional Tarot deck contains 78 cards: 22 Major Arcana and 56 Minor Arcana cards."},{category:"Tarot & Oracle",difficulty:"easy",question:"Which card represents new beginnings in Tarot?",options:["The Fool","The Magician","The World","The Star"],correct:0,explanation:"The Fool (numbered 0) represents new beginnings, innocence, and taking a leap of faith into the unknown."},{category:"Tarot & Oracle",difficulty:"medium",question:"What does the Death card typically symbolize in Tarot?",options:["Literal death","Transformation","Bad luck","Illness"],correct:1,explanation:"The Death card rarely means literal death; it symbolizes transformation, endings, and new beginnings."},{category:"Crystals & Gemstones",difficulty:"easy",question:'Which crystal is known as the "master healer"?',options:["Amethyst","Rose Quartz","Clear Quartz","Citrine"],correct:2,explanation:'Clear Quartz is called the "master healer" because it amplifies energy and can be programmed for any intention.'},{category:"Crystals & Gemstones",difficulty:"easy",question:"Which crystal is associated with love and the heart chakra?",options:["Amethyst","Rose Quartz","Citrine","Black Tourmaline"],correct:1,explanation:"Rose Quartz is the crystal of unconditional love, compassion, and emotional healing."},{category:"Crystals & Gemstones",difficulty:"easy",question:"Which crystal is associated with abundance and prosperity?",options:["Citrine","Turquoise","Jade","Carnelian"],correct:0,explanation:'Citrine is known as the "merchant\'s stone" and is associated with abundance, prosperity, and success.'},{category:"Meditation & Mindfulness",difficulty:"easy",question:"What is the practice of focusing on the present moment called?",options:["Mindfulness","Visualization","Affirmation","Channeling"],correct:0,explanation:"Mindfulness is the practice of bringing one's attention to the present moment with acceptance and without judgment."},{category:"Meditation & Mindfulness",difficulty:"medium",question:'In Buddhism, what is "samadhi"?',options:["Suffering","Meditation","Deep concentration","Enlightenment"],correct:2,explanation:"Samadhi is a state of deep concentration and meditative consciousness in Buddhist practice."},{category:"Meditation & Mindfulness",difficulty:"medium",question:"Which meditation technique involves repeating a word or phrase?",options:["Body scan","Mantra meditation","Walking meditation","Zen meditation"],correct:1,explanation:"Mantra meditation involves repeating a sacred word, phrase, or sound to focus the mind and elevate consciousness."},{category:"Mantras & Sound",difficulty:"easy",question:"What is the most commonly chanted mantra?",options:["So Hum","Om","Om Mani Padme Hum","Gayatri"],correct:1,explanation:"Om (Aum) is the most universal and commonly chanted mantra, representing the primordial sound of creation."},{category:"Mantras & Sound",difficulty:"medium",question:'What frequency is known as the "Love Frequency"?',options:["432 Hz","528 Hz","639 Hz","741 Hz"],correct:1,explanation:'528 Hz is known as the "Love Frequency" or "Miracle Tone" and is associated with DNA repair and transformation.'},{category:"Mantras & Sound",difficulty:"easy",question:'What does "mantra" mean in Sanskrit?',options:["Song","Prayer","Mind tool","Meditation"],correct:2,explanation:'Mantra comes from "man" (mind) and "tra" (tool/instrument), meaning a tool to focus and elevate the mind.'},{category:"Biblical Truth & Etymology",difficulty:"easy",question:'What does "Christ" actually mean?',options:["Jesus' last name",'A title meaning "anointed one" or "awakened consciousness"',"The name of a deity","A Greek god"],correct:1,explanation:'Christ comes from the Greek "Christos" (ŒßœÅŒπœÉœÑœåœÇ), translating the Hebrew "Mashiach" (Messiah), meaning "anointed one". It is a title, not a name - referring to one who has been anointed with divine purpose and awakened consciousness. The Christ is the divine consciousness that can dwell in any vessel aligned with divine will.'},{category:"Biblical Truth & Etymology",difficulty:"hard",question:'What is the original Hebrew name of the person called "Jesus"?',options:["Jesu","Iesous","Yeshua","Joshua"],correct:2,explanation:'His name was Yeshua (◊ô÷µ◊©◊Å◊ï÷º◊¢÷∑) in Hebrew, meaning "Yah saves" or "Salvation of Yah". "Jesus" comes from the Greek "Iesous" (·º∏Œ∑œÉŒø·ø¶œÇ), which was later Latinized to "Iesus" and eventually became "Jesus" in English. The name carries the divine name "Yah" within it, showing his purpose as a vessel of divine salvation.'},{category:"Biblical Truth & Etymology",difficulty:"hard",question:'Why is the "Virgin Mary" doctrine problematic from a Hebrew perspective?',options:["Mary was not a virgin",'The word "virgin" does not exist in Hebrew - the original word "almah" means "young woman"',"It contradicts Roman Catholic teachings","There is no problem with it"],correct:1,explanation:'The Hebrew word in Isaiah 7:14 is "almah" (◊¢÷∑◊ú÷∞◊û÷∏◊î) meaning "young woman" or "maiden" - NOT "betulah" (◊ë÷∞÷º◊™◊ï÷º◊ú÷∏◊î) which specifically means virgin. Greek translators used "parthenos" (virgin), creating a theological doctrine from a mistranslation. The prophecy was about a young woman giving birth, not a miraculous virgin birth.'},{category:"Biblical Truth & Etymology",difficulty:"medium",question:"Why is understanding Greek vs Hebrew important in biblical interpretation?",options:["Greek is more accurate than Hebrew","Hebrew carries the original cultural and linguistic context; Greek translations can introduce theological biases","Hebrew is the only language God understands","It is not important"],correct:1,explanation:'The Hebrew scriptures (Tanakh/Old Testament) contain the original context, idioms, and cultural meanings. When translated to Greek (Septuagint), then Latin (Vulgate), then English, layers of interpretation and theological bias were added. Understanding Hebrew etymology reveals the original intent, such as "almah" vs "virgin", "Yeshua" vs "Jesus", and countless other examples where meaning was altered to fit doctrinal narratives.'},{category:"Biblical Truth & Etymology",difficulty:"hard",question:'What is the significance of "El" in Hebrew names like Nazir El, Micha-El, Gabri-El?',options:['It means "angel"','It means "God" or "The Divine" - showing direct connection to Source',"It is a random suffix",'It means "servant"'],correct:1,explanation:'"El" (◊ê÷µ◊ú) is the ancient Hebrew name for God/The Divine, meaning "The Mighty One" or "The Most High". When attached to a name, it shows divine connection, purpose, or authority. Micha-el = "Who is like El?", Gabri-el = "Strength of El", Nazir-El = "One consecrated to El". These names declare divine alignment and sacred purpose.'},{category:"Biblical Truth & Etymology",difficulty:"medium",question:'What is a "Nazir" or "Nazarite" according to Hebrew tradition?',options:["Someone from Nazareth","One who takes a vow of separation/consecration to the Divine","A type of priest","A prophet"],correct:1,explanation:'A Nazir (◊†÷∏◊ñ÷¥◊ô◊®) is one who takes a vow of consecration and separation unto the Most High (Numbers 6). This includes abstaining from wine, not cutting hair, and avoiding death/impurity. Samson, Samuel, and John the Baptist were Nazarites. It represents complete dedication to divine purpose - being "set apart" for sacred work.'},{category:"Biblical Truth & Etymology",difficulty:"medium",question:'What does "Yah" (as in Hallelu-Yah) mean?',options:["It means praise","It is the shortened sacred name of the Divine (from YHWH)","It means joy","It is a random syllable"],correct:1,explanation:'Yah (◊ô÷∏◊î÷º) is the shortened form of the Tetragrammaton YHWH (◊ô◊î◊ï◊î) - the sacred name of the Divine. "HalleluYah" means "Praise Yah" (Praise the Divine). Many Hebrew names contain "Yah": Elijah (Eli-Yah = My God is Yah), Isaiah (Yesha-Yah = Salvation of Yah), showing their connection to the Most High.'},{category:"Biblical Truth & Etymology",difficulty:"easy",question:"What language did Yeshua (Jesus) speak?",options:["English","Greek","Aramaic and Hebrew","Latin"],correct:2,explanation:'Yeshua spoke Aramaic (the common language of first-century Judea) and Hebrew (the sacred language of scripture and temple). He did NOT speak Greek or Latin fluently. This is critical: the "New Testament" was written in Greek for a Gentile audience, meaning Yeshua\'s actual words were translated and filtered through Greek language, culture, and philosophy - potentially losing original Hebraic meaning and context.'},{category:"Biblical Truth & Etymology",difficulty:"medium",question:'What does "Israel" mean in Hebrew?',options:["The Jewish people","One who struggles/wrestles with God (Divine)","The promised land","A country in the Middle East"],correct:1,explanation:'Israel (◊ô÷¥◊©÷∞◊Ç◊®÷∏◊ê÷µ◊ú) comes from "Yisra" (to struggle/wrestle) + "El" (God), meaning "one who struggles with the Divine" or "God prevails". It was the name given to Jacob after wrestling with the divine messenger. Symbolically, Israel represents anyone who wrestles with divine truth, seeks divine understanding, and strives to align with higher consciousness - not limited to ethnicity or geography.'},{category:"Biblical Truth & Etymology",difficulty:"hard",question:"What is the Tetragrammaton and why is it significant?",options:["A geometric shape","The four-letter sacred name of the Divine: YHWH (◊ô◊î◊ï◊î)","The four gospels","A type of angel"],correct:1,explanation:'The Tetragrammaton is YHWH (◊ô◊î◊ï◊î) - the four-letter sacred name of the Divine, considered too holy to pronounce. It is often rendered as "Yahweh", "Yahuah", or "Jehovah" (incorrect). The letters Yod-Heh-Vav-Heh represent the eternal, self-existent nature of the Divine: "I AM that I AM" (Ehyeh Asher Ehyeh). This name contains the past, present, and future tenses of "to be" - revealing the timeless, infinite nature of the Creator.'},{category:"Biblical Truth & Etymology",difficulty:"hard",question:'What is the Hebrew word for "spirit" and what does it reveal?',options:["Nephesh - soul/life force","Ruach - wind/breath/spirit (feminine gender)","Neshama - divine soul","Kavod - glory"],correct:1,explanation:'Ruach (◊®◊ï÷º◊ó÷∑) means wind, breath, or spirit - and is FEMININE in Hebrew grammar. This reveals that the "Holy Spirit" (Ruach HaKodesh) carries divine feminine energy. Western theology masculinized the Trinity, but the Hebrew shows divine feminine presence. Spirit is the breath of life, the wind of change, the intuitive wisdom - all feminine expressions of the Divine.'},{category:"Biblical Truth & Etymology",difficulty:"medium",question:'What is the Hebrew concept of "Shekinah"?',options:["An angel","The feminine presence/dwelling of the Divine (God's presence on Earth)","A temple","A type of sacrifice"],correct:1,explanation:'Shekinah (◊©÷∞◊Å◊õ÷¥◊ô◊†÷∏◊î) means "dwelling" or "presence" - specifically the feminine aspect of the Divine that dwells among humanity. In Kabbalah, Shekinah represents the Divine Feminine, the immanent presence of God in the world (vs transcendent). She is the Holy Spirit, divine wisdom (Sophia), the compassionate mother aspect of the Most High. The Shekinah reveals that the Divine has both masculine and feminine expressions.'}],this.init()}log(e,t=null){this.debugMode&&console.log(`[TriviaEnhanced] ${e}`,t||"")}error(e,t=null){console.error(`[TriviaEnhanced ERROR] ${e}`,t||"")}async init(){this.log("üéØ Enhanced Daily Trivia System initializing...");try{await this.initAudioSystem(),this.updateLoadingMessage("Initializing trivia system..."),await this.waitForSystems(),this.log("Systems ready, checking auth state"),firebase.auth().onAuthStateChanged(async e=>{e?(this.log(`User authenticated: ${e.email}`),this.currentUser=e,this.audioSystem?.resumeAudioContext(),await this.loadTriviaData(),await this.checkTodayStatus(),setTimeout(()=>{this.audioSystem?.musicEnabled&&this.audioSystem.startBackgroundMusic()},1500)):(this.log("No user authenticated, redirecting to login"),window.location.href="../login.html")})}catch(e){this.error("Initialization failed",e),this.showError("Failed to initialize trivia system",e)}}async initAudioSystem(){this.log("üéµ Initializing audio system...");try{"undefined"!=typeof TriviaAudioSystem?(this.audioSystem=new TriviaAudioSystem,await this.audioSystem.init(),this.addSoundControls(),this.log("‚úÖ Audio system ready")):this.log("‚ö†Ô∏è Audio system not available")}catch(e){this.error("Audio system initialization failed",e)}}addSoundControls(){const e=document.getElementById("loadingState");if(e&&!document.getElementById("triviaAudioControls")){const t=document.createElement("div");if(t.id="triviaAudioControls",t.className="trivia-audio-controls",t.innerHTML='\n                <button id="triviaSoundToggle" class="audio-control-btn" title="Toggle Sound Effects">\n                    üîä\n                </button>\n                <button id="triviaMusicToggle" class="audio-control-btn" title="Toggle Background Music">\n                    üéµ\n                </button>\n            ',!document.getElementById("triviaAudioStyles")){const e=document.createElement("style");e.id="triviaAudioStyles",e.textContent="\n                    .trivia-audio-controls {\n                        position: fixed;\n                        top: 1rem;\n                        right: 1rem;\n                        display: flex;\n                        gap: 0.5rem;\n                        z-index: 1000;\n                    }\n                    \n                    .audio-control-btn {\n                        background: rgba(255, 255, 255, 0.1);\n                        border: 1px solid rgba(255, 255, 255, 0.2);\n                        border-radius: 50%;\n                        width: 45px;\n                        height: 45px;\n                        display: flex;\n                        align-items: center;\n                        justify-content: center;\n                        cursor: pointer;\n                        font-size: 1.3rem;\n                        transition: all 0.3s ease;\n                        color: white;\n                        backdrop-filter: blur(10px);\n                    }\n                    \n                    .audio-control-btn:hover {\n                        background: rgba(255, 255, 255, 0.2);\n                        transform: scale(1.1);\n                        box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);\n                    }\n                    \n                    .audio-control-btn.disabled {\n                        opacity: 0.5;\n                        filter: grayscale(100%);\n                    }\n                    \n                    .audio-control-btn.active {\n                        background: rgba(212, 175, 55, 0.2);\n                        border-color: var(--primary-gold);\n                        box-shadow: 0 0 10px rgba(212, 175, 55, 0.5);\n                    }\n                ",document.head.appendChild(e)}e.appendChild(t),document.getElementById("triviaSoundToggle")?.addEventListener("click",()=>{if(this.audioSystem){const e=this.audioSystem.toggleSound();this.updateSoundControlButton("triviaSoundToggle",e,"üîä","üîá")}}),document.getElementById("triviaMusicToggle")?.addEventListener("click",()=>{if(this.audioSystem){const e=this.audioSystem.toggleMusic();this.updateSoundControlButton("triviaMusicToggle",e,"üéµ","üé∂")}}),this.updateSoundControlButton("triviaSoundToggle",this.audioSystem?.soundEnabled,"üîä","üîá"),this.updateSoundControlButton("triviaMusicToggle",this.audioSystem?.musicEnabled,"üéµ","üé∂")}}updateSoundControlButton(e,t,i,a){const n=document.getElementById(e);n&&(n.textContent=t?i:a,n.classList.toggle("disabled",!t),n.classList.toggle("active",t))}updateLoadingMessage(e){const t=document.getElementById("loadingState");if(t){const i=t.querySelector(".loading-text")||t.querySelector("p")||t;i&&(i.textContent=e)}}async waitForSystems(){return this.log("Waiting for Firebase and Progress System..."),new Promise((e,t)=>{let i=0;const a=setInterval(()=>{i++;const n="undefined"!=typeof firebase&&firebase.auth,s=window.progressSystem||!0;n&&s?(clearInterval(a),this.log("‚úÖ All systems ready"),e()):i>=50&&(clearInterval(a),this.error("Systems timeout"),t(new Error("Systems timeout")))},100)})}async loadTriviaData(){this.log("Loading trivia data..."),this.updateLoadingMessage("Loading your progress...");try{const e=await firebase.firestore().collection("triviaProgress").doc(this.currentUser.uid).get();e.exists?(this.triviaData=e.data(),this.log("Trivia data loaded:",this.triviaData),this.validateTriviaData()):(this.log("No existing data, initializing new user"),await this.initializeNewUser()),this.updateStatsDisplay()}catch(e){this.error("Error loading trivia data",e),await this.initializeNewUser()}}async initializeNewUser(){this.triviaData={userId:this.currentUser.uid,totalQuizzes:0,perfectScores:0,totalXPEarned:0,currentStreak:0,longestStreak:0,lastCompletedDate:null,categoryStats:{},completedDates:[],achievements:[],settings:{soundEnabled:!0,musicEnabled:!0},createdAt:firebase.firestore.FieldValue.serverTimestamp(),lastUpdated:firebase.firestore.FieldValue.serverTimestamp()},await this.saveTriviaData(),this.log("New user initialized and saved")}validateTriviaData(){let e=!1;Object.entries({totalQuizzes:0,perfectScores:0,totalXPEarned:0,currentStreak:0,longestStreak:0,lastCompletedDate:null,categoryStats:{},completedDates:[],achievements:[],settings:{soundEnabled:!0,musicEnabled:!0}}).forEach(([t,i])=>{void 0===this.triviaData[t]&&(this.triviaData[t]=i,e=!0)}),e&&(this.log("Trivia data updated with missing fields"),this.saveTriviaData())}async saveTriviaData(){if(this.triviaData&&this.currentUser)try{this.triviaData.lastUpdated=firebase.firestore.FieldValue.serverTimestamp(),await firebase.firestore().collection("triviaProgress").doc(this.currentUser.uid).set(this.triviaData,{merge:!0});try{const e={...this.triviaData};e.lastUpdated=(new Date).toISOString(),localStorage.setItem(`triviaProgress_${this.currentUser.uid}`,JSON.stringify(e)),this.log("Trivia data saved to Firestore and localStorage")}catch(e){this.log("localStorage save failed (quota exceeded or disabled)",e)}this.log("Trivia data saved successfully")}catch(e){this.error("Error saving trivia data",e),setTimeout(async()=>{try{await firebase.firestore().collection("triviaProgress").doc(this.currentUser.uid).set(this.triviaData,{merge:!0}),this.log("Trivia data saved on retry")}catch(e){this.error("Failed to save trivia data on retry",e)}},2e3)}else this.log("Cannot save - no data or user")}updateStatsDisplay(){const e={totalQuizzes:this.triviaData?.totalQuizzes||0,currentStreak:this.triviaData?.currentStreak||0,perfectScores:this.triviaData?.perfectScores||0,totalXPEarned:this.triviaData?.totalXPEarned||0};Object.entries(e).forEach(([e,t])=>{const i=document.getElementById(e);i&&(i.textContent=t)}),this.log("Stats display updated")}async checkTodayStatus(){const e=(new Date).toISOString().split("T")[0];this.log(`Checking today's status. Today: ${e}, Last completed: ${this.triviaData?.lastCompletedDate}`);const t="true"===new URLSearchParams(window.location.search).get("reset");t&&this.triviaData&&(this.log("üîÑ Force reset detected - clearing completion status"),this.triviaData.lastCompletedDate=null,await this.saveTriviaData()),this.triviaData?.lastCompletedDate!==e||t?(this.log("Not completed today - generating new questions"),this.updateLoadingMessage("Generating today's questions..."),this.generateDailyQuestions(),this.startQuiz()):(this.log("Already completed today - showing completed message"),this.showCompletedMessage())}generateDailyQuestions(){const e=(new Date).toISOString().split("T")[0];this.log(`Generating questions for ${e}`);try{const t=this.hashCode(e);this.log(`Generated seed: ${t}`);const i=this.seededShuffle([...this.questionBank],t);this.log(`Shuffled ${i.length} questions`);const a=i.filter(e=>"easy"===e.difficulty),n=i.filter(e=>"medium"===e.difficulty),s=i.filter(e=>"hard"===e.difficulty);for(this.todaysQuestions=[a[0]||i[0],n[0]||i[1],s[0]||i[2]].filter(Boolean);this.todaysQuestions.length<3&&i.length>this.todaysQuestions.length;){const e=i[this.todaysQuestions.length];e&&!this.todaysQuestions.includes(e)&&this.todaysQuestions.push(e)}this.log("Today's questions generated:",this.todaysQuestions.map(e=>e.question))}catch(e){this.error("Error generating questions",e),this.todaysQuestions=this.questionBank.slice(0,3),this.log("Used fallback questions")}}hashCode(e){let t=0;for(let i=0;i<e.length;i++){t=(t<<5)-t+e.charCodeAt(i),t&=t}return Math.abs(t)}seededShuffle(e,t){const i=this.seededRandom(t);for(let t=e.length-1;t>0;t--){const a=Math.floor(i()*(t+1));[e[t],e[a]]=[e[a],e[t]]}return e}seededRandom(e){return function(){return(e=(9301*e+49297)%233280)/233280}}startQuiz(){if(this.log("Starting quiz..."),!this.todaysQuestions||0===this.todaysQuestions.length)return this.error("No questions available"),void this.showError("No questions available. Please try refreshing the page.");this.audioSystem?.playSound("questionReveal"),document.getElementById("loadingState").style.display="none",document.getElementById("quizCard").style.display="block",this.currentQuestionIndex=0,this.score=0,this.correctAnswers=0,this.userAnswers=[],this.displayQuestion()}displayQuestion(){if(this.currentQuestionIndex>=this.todaysQuestions.length)return void this.error("Question index out of range");const e=this.todaysQuestions[this.currentQuestionIndex],t=this.currentQuestionIndex+1;this.log(`Displaying question ${t}: ${e.question}`),this.audioSystem?.playSound("questionReveal"),document.getElementById("questionNumber").textContent=`Question ${t}/3`,document.getElementById("difficultyBadge").textContent=e.difficulty.toUpperCase(),document.getElementById("difficultyBadge").className=`difficulty-badge difficulty-${e.difficulty}`;const i=document.getElementById("categoryBadge"),a=document.getElementById("questionText");i&&(i.textContent=e.category),a&&(a.textContent=e.question);const n=document.getElementById("explanationBox"),s=document.getElementById("nextBtn");n&&n.classList.remove("show"),s&&s.classList.remove("show");const o=document.getElementById("answerOptions");o&&(o.innerHTML="",e.options.forEach((e,t)=>{const i=document.createElement("button");i.className="answer-btn",i.innerHTML=`<span>${e}</span>`,i.addEventListener("mouseenter",()=>{this.audioSystem?.playSound("hover")}),i.addEventListener("click",()=>{this.audioSystem?.playSound("click"),this.selectAnswer(t)}),o.appendChild(i)})),this.startTimer(),this.questionStartTime=Date.now()}startTimer(){this.timeRemaining=30;const e=document.getElementById("timerFill");e&&(e.style.width="100%",e.classList.remove("warning")),this.timerInterval&&clearInterval(this.timerInterval),this.timerInterval=setInterval(()=>{if(this.timeRemaining--,e){const t=this.timeRemaining/30*100;e.style.width=t+"%",10===this.timeRemaining?(e.classList.add("warning"),this.audioSystem?.playSound("timerWarning")):5===this.timeRemaining&&this.audioSystem?.playSound("timerCritical")}this.timeRemaining<=0&&(clearInterval(this.timerInterval),this.selectAnswer(-1))},1e3)}selectAnswer(e){clearInterval(this.timerInterval);const t=this.todaysQuestions[this.currentQuestionIndex],i=document.querySelectorAll(".answer-btn"),a=e===t.correct,n=((Date.now()-this.questionStartTime)/1e3).toFixed(1);this.log(`Answer selected: ${e}, Correct: ${t.correct}, Is Correct: ${a}`),-1===e?this.audioSystem?.playSound("wrongAnswer"):a?this.audioSystem?.playSound("correctAnswer"):this.audioSystem?.playSound("wrongAnswer");let s=0;if(a&&n<10&&(s=Math.floor(1.5*(10-n))),i.forEach(e=>e.classList.add("disabled")),e>=0&&(i[e].classList.add(a?"correct":"incorrect"),a&&this.createEnhancedParticles(i[e])),i[t.correct].classList.add("correct"),a){this.correctAnswers++;const e=this.getXPForDifficulty(t.difficulty)+s;this.score+=e}this.userAnswers.push({question:t.question,selected:e>=0?t.options[e]:"Time's up",correct:t.options[t.correct],isCorrect:a,timeSpent:n,speedBonus:s});const o=document.getElementById("explanationIcon"),r=document.getElementById("explanationText"),l=document.getElementById("explanationBox");o&&(o.textContent=a?"‚ú®":"üí°"),r&&(r.textContent=t.explanation),l&&l.classList.add("show");const c=document.getElementById("nextBtn");c&&(c.textContent=this.currentQuestionIndex<2?"Next Question ‚Üí":"See Results üéâ",c.classList.add("show"),c.onclick=()=>{this.audioSystem?.playSound("click"),this.nextQuestion()})}getXPForDifficulty(e){return{easy:10,medium:20,hard:30}[e]||10}nextQuestion(){this.currentQuestionIndex++,this.currentQuestionIndex<3?this.displayQuestion():this.showResults()}async showResults(){this.log("Showing results..."),document.getElementById("quizCard").style.display="none",document.getElementById("resultsCard").classList.add("show"),3===this.correctAnswers?this.audioSystem?.playSound("perfectScore"):this.audioSystem?.playSound("victory");let e=0;3===this.correctAnswers&&(e=20,this.score+=e,this.triviaData.perfectScores++);const t={correctCount:this.correctAnswers,totalCount:"3",totalXP:this.score};Object.entries(t).forEach(([e,t])=>{const i=document.getElementById(e);i&&(i.textContent=t)});const i=document.getElementById("resultsIcon"),a=document.getElementById("resultsTitle");if(i&&a&&(3===this.correctAnswers?(i.textContent="üèÜ",a.textContent="Perfect Score!"):2===this.correctAnswers?(i.textContent="‚≠ê",a.textContent="Great Job!"):1===this.correctAnswers?(i.textContent="üìö",a.textContent="Keep Learning!"):(i.textContent="üí™",a.textContent="Try Again Tomorrow!")),this.showXPBreakdown(e),await this.updateStreak(),await this.saveProgress(),window.progressSystem)try{await window.progressSystem.awardXP(this.score,`Daily Trivia (${this.correctAnswers}/5 correct)`,"daily-trivia"),this.log("XP awarded to progress system")}catch(e){this.error("Error awarding XP",e)}this.checkAchievements()}showXPBreakdown(e){const t=document.getElementById("xpBreakdown");if(!t)return;if(t.innerHTML="",this.userAnswers.forEach((e,i)=>{const a=this.todaysQuestions[i],n=this.getXPForDifficulty(a.difficulty);if(e.isCorrect){const s=document.createElement("div");s.className="xp-breakdown-item",s.innerHTML=`\n                    <span>Question ${i+1} (${a.difficulty})</span>\n                    <span>+${n} XP${e.speedBonus>0?` (+${e.speedBonus} speed)`:""}</span>\n                `,t.appendChild(s)}}),e>0){const i=document.createElement("div");i.className="xp-breakdown-item",i.innerHTML=`<span>Perfect Score Bonus üèÜ</span><span>+${e} XP</span>`,t.appendChild(i)}const i=document.createElement("div");i.className="xp-breakdown-item",i.innerHTML=`<span>Total</span><span>+${this.score} XP</span>`,t.appendChild(i)}async updateStreak(){const e=(new Date).toISOString().split("T")[0],t=this.triviaData.lastCompletedDate;if(t){const i=new Date(t),a=new Date(e),n=Math.floor((a-i)/864e5);if(1===n){this.triviaData.currentStreak++,this.log(`Streak continues! Now ${this.triviaData.currentStreak} days`),this.triviaData.currentStreak>this.triviaData.longestStreak&&(this.triviaData.longestStreak=this.triviaData.currentStreak),this.triviaData.currentStreak%5==0&&this.audioSystem?.playSound("streak");const e=document.getElementById("streakMessage");e&&(e.textContent=`üî• ${this.triviaData.currentStreak} Day Streak! Keep it up!`)}else n>1&&(this.triviaData.currentStreak=1,this.log("Streak broken, reset to 1"))}else this.triviaData.currentStreak=1,this.log("First time - streak set to 1")}async saveProgress(){const e=(new Date).toISOString().split("T")[0];this.triviaData.totalQuizzes++,this.triviaData.totalXPEarned+=this.score,this.triviaData.lastCompletedDate=e,this.triviaData.completedDates||(this.triviaData.completedDates=[]),this.triviaData.completedDates.push(e),this.todaysQuestions.forEach((e,t)=>{this.triviaData.categoryStats||(this.triviaData.categoryStats={}),this.triviaData.categoryStats[e.category]||(this.triviaData.categoryStats[e.category]={correct:0,total:0}),this.triviaData.categoryStats[e.category].total++,this.userAnswers[t].isCorrect&&this.triviaData.categoryStats[e.category].correct++}),await this.saveTriviaData(),this.updateStatsDisplay(),this.log("Progress saved")}checkAchievements(){const e=[];if(1===this.triviaData.totalQuizzes&&(e.push("üéØ First Steps - Completed your first trivia!"),this.audioSystem?.playSound("achievement")),3===this.correctAnswers&&1===this.triviaData.perfectScores&&(e.push("üèÜ Perfect Scholar - First perfect score!"),this.audioSystem?.playSound("achievement")),7===this.triviaData.currentStreak&&(e.push("üî• Dedicated Seeker - 7 day streak!"),this.audioSystem?.playSound("achievement")),30===this.triviaData.currentStreak&&(e.push("‚≠ê Trivia Master - 30 day streak!"),this.audioSystem?.playSound("achievement")),10===this.triviaData.perfectScores&&(e.push("üëë Trivia Legend - 10 perfect scores!"),this.audioSystem?.playSound("achievement")),e.length>0){const t=document.getElementById("achievementMessage");t&&(t.innerHTML=e.join("<br>"))}}createEnhancedParticles(e){if(!e)return;const t=e.getBoundingClientRect(),i=t.left+t.width/2,a=t.top+t.height/2;for(let e=0;e<20;e++){const t=document.createElement("div");t.className="trivia-particle",t.style.left=i+"px",t.style.top=a+"px";const n=["#D4AF37","#FFD700","#FFA500","#FF6B35"],s=n[Math.floor(Math.random()*n.length)];t.style.background=s,t.style.boxShadow=`0 0 10px ${s}`;const o=2*Math.PI*e/20,r=100+100*Math.random(),l=Math.cos(o)*r,c=Math.sin(o)*r;t.style.setProperty("--tx",l+"px"),t.style.setProperty("--ty",c+"px"),t.style.width="8px",t.style.height="8px",t.style.borderRadius="50%",t.style.position="fixed",t.style.pointerEvents="none",t.style.zIndex="9999",t.style.animation="triviaParticle 2s ease-out forwards",document.body.appendChild(t),setTimeout(()=>t.remove(),2e3)}}showCompletedMessage(){this.log("Showing completed message"),document.getElementById("loadingState").style.display="none",document.getElementById("completedMessage").style.display="block";const e=new Date,t=new Date(e);t.setDate(t.getDate()+1),t.setHours(0,0,0,0);const i=t-e,a=Math.floor(i/36e5),n=Math.floor(i%36e5/6e4),s=document.querySelector(".time-remaining");if(s&&(s.textContent=`Come back in ${a}h ${n}m for new questions`),this.debugMode){const e=document.getElementById("completedMessage");if(e&&!e.querySelector(".debug-reset-btn")){const t=document.createElement("button");t.className="debug-reset-btn",t.textContent="üîÑ Reset (Debug)",t.style.cssText="\n                    margin-top: 1rem;\n                    background: var(--accent-orange);\n                    color: black;\n                    border: none;\n                    padding: 0.5rem 1rem;\n                    border-radius: 20px;\n                    cursor: pointer;\n                    font-weight: 600;\n                ",t.onclick=()=>{this.audioSystem?.playSound("click"),window.location.href=window.location.pathname+"?reset=true"},e.appendChild(t)}}}showError(e,t=null){this.error(e,t);const i=document.getElementById("loadingState");i&&(i.innerHTML=`\n                <div style="text-align: center; padding: 2rem;">\n                    <h3 style="color: #F43F5E;">‚ùå Error</h3>\n                    <p>${e}</p>\n                    ${t?`<div style="margin-top: 1rem; padding: 1rem; background: rgba(244, 63, 94, 0.1); border-radius: 8px; font-family: monospace; font-size: 0.8rem;">${t.message||t}</div>`:""}\n                    <button onclick="location.reload()" style="margin-top: 1rem; background: var(--primary-gold); color: black; border: none; padding: 0.8rem 2rem; border-radius: 25px; cursor: pointer; font-weight: 600;">\n                        Try Again\n                    </button>\n                </div>\n            `)}destroy(){this.log("üéØ Cleaning up Enhanced Trivia System..."),this.timerInterval&&clearInterval(this.timerInterval),this.audioSystem&&this.audioSystem.destroy()}}if(!document.getElementById("triviaParticleStyles")){const e=document.createElement("style");e.id="triviaParticleStyles",e.textContent="\n        @keyframes triviaParticle {\n            0% {\n                transform: translate(0, 0) scale(1);\n                opacity: 1;\n            }\n            50% {\n                transform: translate(calc(var(--tx) * 0.5), calc(var(--ty) * 0.5)) scale(1.2);\n                opacity: 0.8;\n            }\n            100% {\n                transform: translate(var(--tx), var(--ty)) scale(0);\n                opacity: 0;\n            }\n        }\n    ",document.head.appendChild(e)}function shareResults(){const e=window.enhancedTriviaSystem;if(!e)return;e.audioSystem?.playSound("click");const t=`üéØ Daily Spiritual Trivia\n\nScore: ${e.correctAnswers}/5\nüî• ${e.triviaData?.currentStreak||0} Day Streak\n\nJoin me on the spiritual journey! üåü`;navigator.share?navigator.share({title:"Daily Spiritual Trivia Results",text:t,url:window.location.href}).catch(e=>console.log("Error sharing:",e)):navigator.clipboard.writeText(t).then(()=>{alert("Results copied to clipboard!")})}function viewLeaderboard(){window.enhancedTriviaSystem&&window.enhancedTriviaSystem.audioSystem?.playSound("click"),alert("Leaderboard coming soon!")}document.addEventListener("DOMContentLoaded",()=>{console.log("üéØ Initializing Enhanced Daily Trivia System..."),window.enhancedTriviaSystem=new EnhancedDailyTriviaSystem}),window.addEventListener("beforeunload",()=>{window.enhancedTriviaSystem&&window.enhancedTriviaSystem.destroy()});