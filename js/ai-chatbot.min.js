class AIChatbot{constructor(){this.apiEndpoint=null,this.conversationHistory=this.loadConversationHistory(),this.systemPrompt=this.getSystemPrompt(),this.isTyping=!1,this.maxHistoryLength=20,this.init()}init(){console.log("ğŸ’¬ AI Chatbot initialized");localStorage.getItem("chatbot_greeted")||(this.addWelcomeMessage(),localStorage.setItem("chatbot_greeted","true"))}getSystemPrompt(){return"You are a wise and compassionate spiritual guide for Divine Temple, a platform for spiritual growth and enlightenment. Your purpose is to:\n\n1. Provide spiritual guidance and wisdom\n2. Answer questions about meditation, chakras, energy healing, and spiritual practices\n3. Offer encouragement and support on the spiritual journey\n4. Interpret oracle cards and spiritual symbols\n5. Share daily inspiration and affirmations\n6. Guide users through meditation practices\n7. Explain spiritual concepts in accessible ways\n\nYour personality:\n- Warm, compassionate, and non-judgmental\n- Wise but not preachy\n- Encouraging and supportive\n- Respectful of all spiritual traditions\n- Clear and accessible in explanations\n- Patient and understanding\n\nGuidelines:\n- Keep responses concise (2-4 paragraphs)\n- Use simple, accessible language\n- Avoid being dogmatic or prescriptive\n- Respect user's beliefs and experiences\n- Offer practical guidance when appropriate\n- Use emojis sparingly and meaningfully ğŸ™âœ¨\n- End responses with a thoughtful question when appropriate\n\nRemember: You are a spiritual companion, not a medical or mental health professional. Suggest professional help when needed."}loadConversationHistory(){const n=localStorage.getItem("chatbot_conversation_history");return n?JSON.parse(n):[]}saveConversationHistory(){this.conversationHistory.length>this.maxHistoryLength&&(this.conversationHistory=this.conversationHistory.slice(-this.maxHistoryLength)),localStorage.setItem("chatbot_conversation_history",JSON.stringify(this.conversationHistory))}addWelcomeMessage(){const n={role:"assistant",content:"ğŸ™ Welcome to Divine Temple! I'm your spiritual guide and companion on this sacred journey.\n\nI'm here to:\nâ€¢ Answer your spiritual questions\nâ€¢ Guide you through meditation\nâ€¢ Offer daily wisdom and inspiration\nâ€¢ Help interpret oracle cards\nâ€¢ Provide support and encouragement\n\nWhat can I help you with today?",timestamp:Date.now()};this.conversationHistory.push(n),this.saveConversationHistory()}async sendMessage(n){if(!n||0===n.trim().length)return{success:!1,message:"Please enter a message"};const e={role:"user",content:n.trim(),timestamp:Date.now()};this.conversationHistory.push(e),this.saveConversationHistory();const t=this.conversationHistory.filter(n=>"user"===n.role).length;1===t&&window.progressSystem&&window.progressSystem.awardXP(10,"Started conversation with AI guide","chatbot");try{const e=await this.getAIResponse(n);if(e.success){const n={role:"assistant",content:e.message,timestamp:Date.now()};return this.conversationHistory.push(n),this.saveConversationHistory(),10===t&&window.progressSystem?window.progressSystem.awardXP(50,"10 conversations with AI guide! ğŸ¤–","chatbot"):50===t&&window.progressSystem&&window.progressSystem.awardXP(100,"50 conversations! Wisdom seeker! ğŸ§ ","chatbot"),{success:!0,message:e.message}}return e}catch(n){console.error("Error getting AI response:",n);const e={role:"assistant",content:"I apologize, but I'm having trouble connecting right now. Please try again in a moment. ğŸ™",timestamp:Date.now()};return this.conversationHistory.push(e),this.saveConversationHistory(),{success:!1,message:e.content}}}async getAIResponse(n){if(!firebase.auth().currentUser)return{success:!1,message:"Please log in to chat with our AI spiritual guide. ğŸ”âœ¨"};try{const e=this.conversationHistory.slice(-8).map(n=>({role:n.role,content:n.content})),t=firebase.functions().httpsCallable("chatWithAI"),a=await t({message:n,conversationHistory:e});return a.data.success?{success:!0,message:a.data.message,tokensUsed:a.data.tokensUsed}:{success:!1,message:a.data.message}}catch(e){return console.error("OpenAI API error:",e),this.getFallbackResponse(n)}}getFallbackResponse(n){const e=n.toLowerCase();return e.includes("meditat")?{success:!0,message:"Meditation is a beautiful practice! ğŸ§˜\n\nHere's a simple technique to start:\n\n1. Find a quiet space and sit comfortably\n2. Close your eyes and take three deep breaths\n3. Focus on your breath flowing in and out\n4. When thoughts arise, gently return to your breath\n5. Start with 5-10 minutes daily\n\nWould you like guidance on a specific meditation technique?"}:e.includes("chakra")?{success:!0,message:"The chakra system is a powerful framework for understanding energy! ğŸŒˆ\n\nThere are seven main chakras:\nâ€¢ Root (Muladhara) - Grounding\nâ€¢ Sacral (Svadhisthana) - Creativity\nâ€¢ Solar Plexus (Manipura) - Power\nâ€¢ Heart (Anahata) - Love\nâ€¢ Throat (Vishuddha) - Communication\nâ€¢ Third Eye (Ajna) - Intuition\nâ€¢ Crown (Sahasrara) - Consciousness\n\nWhich chakra would you like to learn more about?"}:e.includes("oracle")||e.includes("tarot")||e.includes("card")?{success:!0,message:"Oracle and tarot cards are wonderful tools for spiritual insight! âœ¨\n\nThey work by:\nâ€¢ Tapping into your intuition\nâ€¢ Reflecting your subconscious mind\nâ€¢ Offering guidance and perspective\nâ€¢ Sparking self-reflection\n\nWould you like to draw a card or learn about a specific spread?"}:e.includes("grateful")||e.includes("gratitude")||e.includes("affirm")?{success:!0,message:"Gratitude is a powerful spiritual practice! ğŸ™\n\nHere are three simple ways to cultivate it:\n\n1. Morning gratitude: List 3 things you're grateful for\n2. Gratitude journal: Write daily appreciations\n3. Gratitude meditation: Feel thankfulness in your heart\n\nWhat are you grateful for today?"}:e.includes("journey")||e.includes("path")||e.includes("start")?{success:!0,message:'Every spiritual journey is unique and sacred! âœ¨\n\nSome foundational practices:\nâ€¢ Daily meditation (even 5 minutes)\nâ€¢ Mindful breathing\nâ€¢ Journaling insights\nâ€¢ Spending time in nature\nâ€¢ Practicing gratitude\nâ€¢ Reading spiritual texts\n\nRemember: There\'s no "right" way. Trust your intuition and take it one step at a time.\n\nWhat aspect of spirituality calls to you most?'}:{success:!0,message:"Thank you for sharing that with me. ğŸ™\n\nI'm here to support you on your spiritual journey. Whether you're seeking guidance on meditation, chakras, oracle cards, or any spiritual practice, I'm happy to help.\n\nI can also offer:\nâ€¢ Daily inspiration and wisdom\nâ€¢ Meditation guidance\nâ€¢ Spiritual insights\nâ€¢ Encouragement and support\n\nWhat would you like to explore together?"}}getDailyInspiration(){const n=["The present moment is all you ever have. Be present, be awake, be here now. ğŸŒ…","Your soul knows the way. Trust your inner guidance and follow your light. âœ¨","Every breath is a gift. Every moment is an opportunity for awakening. ğŸ§˜","You are not a drop in the ocean. You are the entire ocean in a drop. ğŸŒŠ","The universe is not outside of you. Look inside yourself; everything you want, you already are. â­","Let go of what weighs you down. You are meant to soar. ğŸ•Šï¸","Your spiritual journey is unique and perfect for you. Honor your path. ğŸŒŸ","In stillness, wisdom speaks. In silence, truth reveals itself. ğŸ™","You are a divine being having a human experience. Remember your light. ğŸ’«","Gratitude transforms what we have into enough. Give thanks for this moment. ğŸŒ¸"];return n[Math.floor(Math.random()*n.length)]}clearHistory(){return this.conversationHistory=[],this.saveConversationHistory(),localStorage.removeItem("chatbot_greeted"),{success:!0,message:"Conversation history cleared"}}getConversationHistory(){return this.conversationHistory}openChatModal(){const n=document.createElement("div");n.className="chatbot-modal",n.id="chatbotModal",n.innerHTML=`\n            <div class="chatbot-modal-content">\n                <div class="chatbot-modal-header">\n                    <h2>ğŸ’¬ Spiritual Guide</h2>\n                    <div class="chatbot-header-actions">\n                        <button onclick="window.aiChatbot.clearHistory(); location.reload();" class="clear-btn" title="Clear History">\n                            ğŸ”„\n                        </button>\n                        <button onclick="document.getElementById('chatbotModal').remove()" class="modal-close">âœ•</button>\n                    </div>\n                </div>\n\n                <div class="chatbot-messages" id="chatbotMessages">\n                    ${this.renderMessages()}\n                </div>\n\n                <div class="chatbot-input-area">\n                    <input type="text" id="chatbotInput" placeholder="Ask me anything about spirituality..."\n                           class="chatbot-input" onkeypress="if(event.key==='Enter') window.aiChatbot.sendMessageFromUI()">\n                    <button onclick="window.aiChatbot.sendMessageFromUI()" class="chatbot-send-btn">\n                        ğŸ“¨ Send\n                    </button>\n                </div>\n\n                <div class="chatbot-quick-actions">\n                    <button onclick="window.aiChatbot.sendQuickMessage('How do I meditate?')" class="quick-action-btn">\n                        ğŸ§˜ Meditation Guide\n                    </button>\n                    <button onclick="window.aiChatbot.sendQuickMessage('Tell me about chakras')" class="quick-action-btn">\n                        ğŸŒˆ Chakras\n                    </button>\n                    <button onclick="window.aiChatbot.sendQuickMessage('Give me daily inspiration')" class="quick-action-btn">\n                        âœ¨ Daily Inspiration\n                    </button>\n                </div>\n            </div>\n        `,this.addChatbotStyles(),document.body.appendChild(n),setTimeout(()=>{const n=document.getElementById("chatbotMessages");n&&(n.scrollTop=n.scrollHeight),document.getElementById("chatbotInput")?.focus()},100)}renderMessages(){return 0===this.conversationHistory.length?'<p class="no-messages">Start a conversation with your spiritual guide!</p>':this.conversationHistory.map(n=>{const e=new Date(n.timestamp).toLocaleTimeString();return`\n                <div class="chat-message ${"user"===n.role?"user-message":"assistant-message"}">\n                    <div class="message-content">\n                        ${n.content.replace(/\n/g,"<br>")}\n                    </div>\n                    <div class="message-time">${e}</div>\n                </div>\n            `}).join("")}async sendMessageFromUI(){const n=document.getElementById("chatbotInput"),e=n.value.trim();if(!e)return;n.value="",this.addMessageToUI("user",e),this.showTypingIndicator();const t=await this.sendMessage(e);this.hideTypingIndicator(),t.success&&this.addMessageToUI("assistant",t.message)}async sendQuickMessage(n){const e=document.getElementById("chatbotInput");e&&(e.value=n,await this.sendMessageFromUI())}addMessageToUI(n,e){const t=document.getElementById("chatbotMessages");if(!t)return;const a=(new Date).toLocaleTimeString(),s="user"===n,o=document.createElement("div");o.className="chat-message "+(s?"user-message":"assistant-message"),o.innerHTML=`\n            <div class="message-content">\n                ${e.replace(/\n/g,"<br>")}\n            </div>\n            <div class="message-time">${a}</div>\n        `,t.appendChild(o),t.scrollTop=t.scrollHeight}showTypingIndicator(){const n=document.getElementById("chatbotMessages");if(!n)return;const e=document.createElement("div");e.className="typing-indicator",e.id="typingIndicator",e.innerHTML='\n            <div class="typing-dots">\n                <span></span>\n                <span></span>\n                <span></span>\n            </div>\n        ',n.appendChild(e),n.scrollTop=n.scrollHeight}hideTypingIndicator(){const n=document.getElementById("typingIndicator");n&&n.remove()}addChatbotStyles(){if(document.getElementById("chatbotStyles"))return;const n=document.createElement("style");n.id="chatbotStyles",n.textContent="\n            .chatbot-modal {\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0,0,0,0.8);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 10000;\n                animation: fadeIn 0.3s ease;\n            }\n\n            .chatbot-modal-content {\n                background: white;\n                border-radius: 20px;\n                width: 90%;\n                max-width: 700px;\n                height: 80vh;\n                max-height: 700px;\n                display: flex;\n                flex-direction: column;\n                overflow: hidden;\n            }\n\n            .chatbot-modal-header {\n                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                color: white;\n                padding: 20px 30px;\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n            }\n\n            .chatbot-modal-header h2 {\n                margin: 0;\n            }\n\n            .chatbot-header-actions {\n                display: flex;\n                gap: 10px;\n            }\n\n            .clear-btn, .modal-close {\n                background: rgba(255,255,255,0.2);\n                border: none;\n                color: white;\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                cursor: pointer;\n                font-size: 16px;\n                transition: background 0.2s;\n            }\n\n            .clear-btn:hover, .modal-close:hover {\n                background: rgba(255,255,255,0.3);\n            }\n\n            .chatbot-messages {\n                flex: 1;\n                overflow-y: auto;\n                padding: 20px;\n                background: #f9f9f9;\n            }\n\n            .no-messages {\n                text-align: center;\n                color: #999;\n                padding: 40px 20px;\n            }\n\n            .chat-message {\n                margin-bottom: 15px;\n                animation: slideIn 0.3s ease;\n            }\n\n            .user-message {\n                display: flex;\n                flex-direction: column;\n                align-items: flex-end;\n            }\n\n            .user-message .message-content {\n                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                color: white;\n                padding: 12px 16px;\n                border-radius: 18px 18px 0 18px;\n                max-width: 70%;\n                word-wrap: break-word;\n            }\n\n            .assistant-message {\n                display: flex;\n                flex-direction: column;\n                align-items: flex-start;\n            }\n\n            .assistant-message .message-content {\n                background: white;\n                color: #333;\n                padding: 12px 16px;\n                border-radius: 18px 18px 18px 0;\n                max-width: 70%;\n                word-wrap: break-word;\n                box-shadow: 0 2px 5px rgba(0,0,0,0.1);\n            }\n\n            .message-time {\n                font-size: 11px;\n                color: #999;\n                margin-top: 4px;\n                padding: 0 8px;\n            }\n\n            .typing-indicator {\n                display: flex;\n                align-items: center;\n                margin-bottom: 15px;\n            }\n\n            .typing-dots {\n                background: white;\n                padding: 12px 16px;\n                border-radius: 18px 18px 18px 0;\n                box-shadow: 0 2px 5px rgba(0,0,0,0.1);\n                display: flex;\n                gap: 4px;\n            }\n\n            .typing-dots span {\n                width: 8px;\n                height: 8px;\n                background: #667eea;\n                border-radius: 50%;\n                animation: typingDot 1.4s infinite;\n            }\n\n            .typing-dots span:nth-child(2) {\n                animation-delay: 0.2s;\n            }\n\n            .typing-dots span:nth-child(3) {\n                animation-delay: 0.4s;\n            }\n\n            @keyframes typingDot {\n                0%, 60%, 100% {\n                    opacity: 0.3;\n                    transform: scale(0.8);\n                }\n                30% {\n                    opacity: 1;\n                    transform: scale(1);\n                }\n            }\n\n            .chatbot-input-area {\n                display: flex;\n                gap: 10px;\n                padding: 20px;\n                background: white;\n                border-top: 1px solid #e0e0e0;\n            }\n\n            .chatbot-input {\n                flex: 1;\n                padding: 12px;\n                border: 2px solid #e0e0e0;\n                border-radius: 25px;\n                font-size: 15px;\n                outline: none;\n                transition: border-color 0.2s;\n            }\n\n            .chatbot-input:focus {\n                border-color: #667eea;\n            }\n\n            .chatbot-send-btn {\n                padding: 12px 24px;\n                border: none;\n                border-radius: 25px;\n                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                color: white;\n                font-weight: 600;\n                cursor: pointer;\n                transition: transform 0.2s;\n            }\n\n            .chatbot-send-btn:hover {\n                transform: scale(1.05);\n            }\n\n            .chatbot-quick-actions {\n                display: flex;\n                gap: 10px;\n                padding: 0 20px 20px 20px;\n                flex-wrap: wrap;\n            }\n\n            .quick-action-btn {\n                padding: 8px 16px;\n                border: 2px solid #667eea;\n                background: white;\n                color: #667eea;\n                border-radius: 20px;\n                cursor: pointer;\n                font-size: 13px;\n                font-weight: 600;\n                transition: all 0.2s;\n            }\n\n            .quick-action-btn:hover {\n                background: #667eea;\n                color: white;\n            }\n\n            @keyframes fadeIn {\n                from { opacity: 0; }\n                to { opacity: 1; }\n            }\n\n            @keyframes slideIn {\n                from {\n                    opacity: 0;\n                    transform: translateY(10px);\n                }\n                to {\n                    opacity: 1;\n                    transform: translateY(0);\n                }\n            }\n\n            @media (max-width: 768px) {\n                .chatbot-modal-content {\n                    width: 100%;\n                    height: 100vh;\n                    max-height: none;\n                    border-radius: 0;\n                }\n\n                .user-message .message-content,\n                .assistant-message .message-content {\n                    max-width: 85%;\n                }\n            }\n        ",document.head.appendChild(n)}getStats(){return{totalMessages:this.conversationHistory.filter(n=>"user"===n.role).length,totalConversations:this.conversationHistory.length,hasConversation:this.conversationHistory.length>0}}}"undefined"!=typeof window&&(window.aiChatbot=new AIChatbot,console.log("ğŸ’¬ AI Chatbot ready!"));