class ChakraMemoryGame{constructor(){this.currentUser=null,this.gameData=null,this.selectedMode=null,this.cards=[],this.flippedCards=[],this.matchedPairs=0,this.moves=0,this.startTime=null,this.timerInterval=null,this.isProcessing=!1,this.chakraCards=[{id:"root-symbol",chakra:"Root",type:"symbol",icon:"ðŸ”´",text:"Root Symbol",color:"#E53E3E",pair:"root-name"},{id:"root-name",chakra:"Root",type:"name",icon:"ðŸª¨",text:"Muladhara",color:"#E53E3E",pair:"root-symbol"},{id:"sacral-symbol",chakra:"Sacral",type:"symbol",icon:"ðŸŸ ",text:"Sacral Symbol",color:"#ED8936",pair:"sacral-name"},{id:"sacral-name",chakra:"Sacral",type:"name",icon:"ðŸ’§",text:"Svadhisthana",color:"#ED8936",pair:"sacral-symbol"},{id:"solar-symbol",chakra:"Solar Plexus",type:"symbol",icon:"ðŸŸ¡",text:"Solar Symbol",color:"#ECC94B",pair:"solar-name"},{id:"solar-name",chakra:"Solar Plexus",type:"name",icon:"ðŸ”¥",text:"Manipura",color:"#ECC94B",pair:"solar-symbol"},{id:"heart-symbol",chakra:"Heart",type:"symbol",icon:"ðŸŸ¢",text:"Heart Symbol",color:"#48BB78",pair:"heart-name"},{id:"heart-name",chakra:"Heart",type:"name",icon:"ðŸ’š",text:"Anahata",color:"#48BB78",pair:"heart-symbol"},{id:"throat-symbol",chakra:"Throat",type:"symbol",icon:"ðŸ”µ",text:"Throat Symbol",color:"#4299E1",pair:"throat-name"},{id:"throat-name",chakra:"Throat",type:"name",icon:"ðŸ—£ï¸",text:"Vishuddha",color:"#4299E1",pair:"throat-symbol"},{id:"thirdeye-symbol",chakra:"Third Eye",type:"symbol",icon:"ðŸŸ£",text:"Third Eye Symbol",color:"#667EEA",pair:"thirdeye-name"},{id:"thirdeye-name",chakra:"Third Eye",type:"name",icon:"ðŸ‘ï¸",text:"Ajna",color:"#667EEA",pair:"thirdeye-symbol"},{id:"crown-symbol",chakra:"Crown",type:"symbol",icon:"ðŸŸ£",text:"Crown Symbol",color:"#9F7AEA",pair:"crown-name"},{id:"crown-name",chakra:"Crown",type:"name",icon:"ðŸ‘‘",text:"Sahasrara",color:"#9F7AEA",pair:"crown-symbol"},{id:"root-element",chakra:"Root",type:"element",icon:"ðŸŒ",text:"Earth",color:"#E53E3E",pair:"root-location"},{id:"root-location",chakra:"Root",type:"location",icon:"ðŸ¦¶",text:"Base of Spine",color:"#E53E3E",pair:"root-element"},{id:"sacral-element",chakra:"Sacral",type:"element",icon:"ðŸŒŠ",text:"Water",color:"#ED8936",pair:"sacral-emotion"},{id:"sacral-emotion",chakra:"Sacral",type:"emotion",icon:"ðŸ˜Š",text:"Creativity",color:"#ED8936",pair:"sacral-element"},{id:"solar-element",chakra:"Solar Plexus",type:"element",icon:"ðŸ”¥",text:"Fire",color:"#ECC94B",pair:"solar-power"},{id:"solar-power",chakra:"Solar Plexus",type:"power",icon:"âš¡",text:"Personal Power",color:"#ECC94B",pair:"solar-element"},{id:"heart-element",chakra:"Heart",type:"element",icon:"ðŸ’¨",text:"Air",color:"#48BB78",pair:"heart-emotion"},{id:"heart-emotion",chakra:"Heart",type:"emotion",icon:"ðŸ’–",text:"Love",color:"#48BB78",pair:"heart-element"},{id:"throat-element",chakra:"Throat",type:"element",icon:"ðŸŒ¬ï¸",text:"Ether",color:"#4299E1",pair:"throat-function"},{id:"throat-function",chakra:"Throat",type:"function",icon:"ðŸŽ¤",text:"Communication",color:"#4299E1",pair:"throat-element"}],this.difficulties={easy:{pairs:4,minMoves:8,perfectMoves:10,baseXP:50,perfectXP:100,speedBonus:20},medium:{pairs:8,minMoves:16,perfectMoves:20,baseXP:100,perfectXP:200,speedBonus:50},hard:{pairs:12,minMoves:24,perfectMoves:30,baseXP:200,perfectXP:400,speedBonus:100}},this.init()}async init(){console.log("ðŸ§˜ Chakra Memory Game initializing..."),await this.waitForSystems(),firebase.auth().onAuthStateChanged(async e=>{e?(this.currentUser=e,await this.loadGameData(),this.updateBestTimes()):window.location.href="../login.html"})}async waitForSystems(){return new Promise(e=>{const t=setInterval(()=>{"undefined"!=typeof firebase&&window.progressSystem&&(clearInterval(t),e())},100)})}async loadGameData(){try{const e=await firebase.firestore().collection("chakraMemoryProgress").doc(this.currentUser.uid).get();e.exists?this.gameData=e.data():(this.gameData={userId:this.currentUser.uid,gamesPlayed:0,perfectGames:0,totalXPEarned:0,bestTimes:{easy:null,medium:null,hard:null},stats:{easy:{played:0,wins:0,totalMoves:0,totalTime:0},medium:{played:0,wins:0,totalMoves:0,totalTime:0},hard:{played:0,wins:0,totalMoves:0,totalTime:0}}},await this.saveGameData())}catch(e){console.error("Error loading game data:",e)}}async saveGameData(){try{await firebase.firestore().collection("chakraMemoryProgress").doc(this.currentUser.uid).set(this.gameData)}catch(e){console.error("Error saving game data:",e)}}updateBestTimes(){if(!this.gameData)return;const e=e=>{if(!e)return"--:--";const t=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`};document.getElementById("bestTimeEasy").textContent=e(this.gameData.bestTimes.easy),document.getElementById("bestTimeMedium").textContent=e(this.gameData.bestTimes.medium),document.getElementById("bestTimeHard").textContent=e(this.gameData.bestTimes.hard)}selectMode(e){this.selectedMode=e,document.querySelectorAll(".mode-btn").forEach(e=>{e.classList.remove("selected")}),document.querySelector(`[data-mode="${e}"]`).classList.add("selected");const t=document.querySelector(".start-game-btn");t.disabled=!1,t.textContent=`Start ${e.charAt(0).toUpperCase()+e.slice(1)} Game ðŸŽ®`}startGame(){if(!this.selectedMode)return;document.getElementById("modeSelection").style.display="none";document.getElementById("gameBoard").classList.add("active"),this.setupGame()}setupGame(){this.moves=0,this.matchedPairs=0,this.flippedCards=[],this.startTime=Date.now(),this.isProcessing=!1;const e=this.difficulties[this.selectedMode];this.cards=this.selectCards(e.pairs),this.shuffleCards(),document.getElementById("movesValue").textContent="0",document.getElementById("pairsValue").textContent=`0/${e.pairs}`,document.getElementById("timeValue").textContent="00:00",this.renderCards(),this.startTimer()}selectCards(e){const t=[...this.chakraCards].sort(()=>Math.random()-.5),a=[],s=new Set;for(let o=0;o<t.length&&a.length<2*e;o++){const e=t[o],r=this.chakraCards.find(t=>t.id===e.pair);r&&!s.has(e.chakra+e.type+e.pair)&&(a.push({...e,cardId:`card-${a.length}`}),a.push({...r,cardId:`card-${a.length}`}),s.add(e.chakra+e.type+e.pair),s.add(r.chakra+r.type+r.pair))}return a.slice(0,2*e)}shuffleCards(){for(let e=this.cards.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[this.cards[e],this.cards[t]]=[this.cards[t],this.cards[e]]}}renderCards(){const e=document.getElementById("cardsGrid");e.innerHTML="",e.className=`cards-grid ${this.selectedMode}`,this.cards.forEach(t=>{const a=this.createCardElement(t);e.appendChild(a)})}createCardElement(e){const t=document.createElement("div");return t.className="memory-card",t.dataset.cardId=e.cardId,t.dataset.pairId=e.pair,t.dataset.chakra=e.chakra,t.innerHTML=`\n            <div class="card-face card-front">\n                <div class="card-pattern"></div>\n            </div>\n            <div class="card-face card-back" style="border-color: ${e.color}">\n                <div class="card-icon">${e.icon}</div>\n                <div class="card-text" style="color: ${e.color}">${e.text}</div>\n            </div>\n        `,t.addEventListener("click",()=>this.flipCard(t,e)),t}flipCard(e,t){this.isProcessing||e.classList.contains("flipped")||e.classList.contains("matched")||this.flippedCards.length>=2||(e.classList.add("flipped"),this.flippedCards.push({element:e,data:t}),2===this.flippedCards.length&&(this.isProcessing=!0,this.moves++,document.getElementById("movesValue").textContent=this.moves,setTimeout(()=>{this.checkMatch()},500)))}checkMatch(){const[e,t]=this.flippedCards;if(e.data.pair===t.data.id){e.element.classList.add("matched"),t.element.classList.add("matched"),this.matchedPairs++;const a=this.difficulties[this.selectedMode];document.getElementById("pairsValue").textContent=`${this.matchedPairs}/${a.pairs}`,this.createParticles(e.element,e.data.color),this.createParticles(t.element,t.data.color),this.matchedPairs===a.pairs&&setTimeout(()=>this.gameComplete(),500)}else setTimeout(()=>{e.element.classList.remove("flipped"),t.element.classList.remove("flipped")},300);this.flippedCards=[],this.isProcessing=!1}startTimer(){this.timerInterval&&clearInterval(this.timerInterval),this.timerInterval=setInterval(()=>{const e=Math.floor((Date.now()-this.startTime)/1e3),t=Math.floor(e/60),a=e%60;document.getElementById("timeValue").textContent=`${t.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`},1e3)}async gameComplete(){clearInterval(this.timerInterval);const e=Math.floor((Date.now()-this.startTime)/1e3),t=this.difficulties[this.selectedMode];let a=1;this.moves<=t.perfectMoves?a=3:this.moves<=1.5*t.minMoves&&(a=2);let s=t.baseXP;const o=[`Base: ${t.baseXP} XP`];if(this.moves===t.minMoves){const e=t.perfectXP-t.baseXP;s=t.perfectXP,o.push(`Perfect Game: +${e} XP`)}const r={easy:120,medium:180,hard:240};if(e<r[this.selectedMode]){const a=Math.floor(t.speedBonus*(1-e/r[this.selectedMode]));s+=a,o.push(`Speed Bonus: +${a} XP`)}if(3===a){const e=50;s+=e,o.push(`3-Star Bonus: +${e} XP`)}this.gameData.gamesPlayed++,this.gameData.totalXPEarned+=s,this.moves===t.minMoves&&this.gameData.perfectGames++,this.gameData.stats[this.selectedMode].played++,this.gameData.stats[this.selectedMode].wins++,this.gameData.stats[this.selectedMode].totalMoves+=this.moves,this.gameData.stats[this.selectedMode].totalTime+=e;let i=!1;(!this.gameData.bestTimes[this.selectedMode]||e<this.gameData.bestTimes[this.selectedMode])&&(this.gameData.bestTimes[this.selectedMode]=e,i=!0),await this.saveGameData(),this.updateBestTimes(),window.progressSystem&&await window.progressSystem.awardXP(s,`Chakra Memory Match (${this.selectedMode})`,"chakra-memory"),this.showVictoryScreen(e,a,s,o,i)}showVictoryScreen(e,t,a,s,o){document.getElementById("gameBoard").classList.remove("active");const r=e%60,i=`${Math.floor(e/60).toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`;document.getElementById("finalTime").textContent=i,document.getElementById("finalMoves").textContent=this.moves,document.getElementById("finalStars").textContent="â­".repeat(t),document.getElementById("totalXP").textContent=a;document.getElementById("xpBreakdown").innerHTML=s.join("<br>"),document.getElementById("newRecordMsg").style.display=o?"block":"none",document.getElementById("victoryScreen").classList.add("show")}resetGame(){this.setupGame()}playAgain(){document.getElementById("victoryScreen").classList.remove("show"),this.setupGame()}backToMenu(){this.timerInterval&&clearInterval(this.timerInterval),document.getElementById("gameBoard").classList.remove("active"),document.getElementById("victoryScreen").classList.remove("show"),document.getElementById("modeSelection").style.display="block",this.selectedMode=null,document.querySelectorAll(".mode-btn").forEach(e=>{e.classList.remove("selected")});const e=document.querySelector(".start-game-btn");e.disabled=!0,e.textContent="Select a Difficulty to Start"}createParticles(e,t){const a=e.getBoundingClientRect(),s=a.left+a.width/2,o=a.top+a.height/2;for(let e=0;e<10;e++){const a=document.createElement("div");a.className="particle",a.style.left=s+"px",a.style.top=o+"px",a.style.background=t;const r=2*Math.PI*e/10,i=100+100*Math.random(),n=Math.cos(r)*i,c=Math.sin(r)*i;a.style.setProperty("--tx",n+"px"),a.style.setProperty("--ty",c+"px"),document.body.appendChild(a),setTimeout(()=>a.remove(),2e3)}}shareResults(){const e=document.getElementById("finalStars").textContent,t=document.getElementById("finalTime").textContent,a=document.getElementById("totalXP").textContent,s=`ðŸ§˜ Chakra Memory Match\n\nDifficulty: ${this.selectedMode.charAt(0).toUpperCase()+this.selectedMode.slice(1)}\nRating: ${e}\nTime: ${t}\nXP Earned: +${a}\n\nAlign your chakras in Divine Temple! ðŸŒŸ`;navigator.share?navigator.share({title:"Chakra Memory Match Results",text:s,url:window.location.href}).catch(e=>console.log("Error sharing:",e)):navigator.clipboard.writeText(s).then(()=>{alert("Results copied to clipboard!")})}}function selectMode(e){window.chakraGame.selectMode(e)}function startGame(){window.chakraGame.startGame()}function resetGame(){window.chakraGame.resetGame()}function playAgain(){window.chakraGame.playAgain()}function backToMenu(){window.chakraGame.backToMenu()}function shareResults(){window.chakraGame.shareResults()}document.addEventListener("DOMContentLoaded",()=>{window.chakraGame=new ChakraMemoryGame});