class PushNotificationSystem{constructor(){this.isSupported="serviceWorker"in navigator&&"PushManager"in window,this.permission=Notification.permission,this.registration=null,this.subscription=null,this.fcmToken=null,this.settings=this.loadSettings(),this.init()}async init(){console.log("üîî Push Notification System initialized"),this.isSupported?(await this.registerServiceWorker(),"granted"===this.permission&&await this.subscribeToPush(),this.setupEventListeners()):console.warn("Push notifications are not supported in this browser")}loadSettings(){const e=localStorage.getItem("push_notification_settings");return e?JSON.parse(e):{enabled:!1,achievements:!0,quests:!0,friends:!0,circles:!0,streaks:!0,leaderboards:!0,dailyReminder:!0,reminderTime:"09:00",dndEnabled:!1,dndStart:"22:00",dndEnd:"08:00"}}saveSettings(){localStorage.setItem("push_notification_settings",JSON.stringify(this.settings))}async registerServiceWorker(){try{return this.registration=await navigator.serviceWorker.register("/service-worker.js",{scope:"/"}),console.log("Service Worker registered:",this.registration),await navigator.serviceWorker.ready,this.registration}catch(e){return console.error("Service Worker registration failed:",e),null}}async requestPermission(){if(!this.isSupported)return{success:!1,message:"Push notifications not supported in this browser"};try{const e=await Notification.requestPermission();return this.permission=e,"granted"===e?(this.settings.enabled=!0,this.saveSettings(),await this.subscribeToPush(),window.progressSystem&&window.progressSystem.awardXP(20,"Enabled push notifications","settings"),{success:!0,message:"Push notifications enabled! üîî"}):"denied"===e?{success:!1,message:"Push notifications blocked. Please enable them in browser settings."}:{success:!1,message:"Push notification permission not granted"}}catch(e){return console.error("Error requesting notification permission:",e),{success:!1,message:"Failed to request permission"}}}async subscribeToPush(){if(this.registration||await this.registerServiceWorker(),!this.registration)return console.error("No service worker registration"),null;try{let e=await this.registration.pushManager.getSubscription();if(!e){const n="YOUR_VAPID_PUBLIC_KEY_HERE";e=await this.registration.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlBase64ToUint8Array(n)})}return this.subscription=e,"undefined"!=typeof firebase&&firebase.auth&&await this.sendSubscriptionToServer(e),console.log("Push subscription created:",e),e}catch(e){return console.error("Failed to subscribe to push notifications:",e),null}}async sendSubscriptionToServer(e){const n=firebase.auth().currentUser;if(n)try{const t=firebase.firestore();await t.collection("pushSubscriptions").doc(n.uid).set({userId:n.uid,subscription:JSON.parse(JSON.stringify(e)),createdAt:firebase.firestore.FieldValue.serverTimestamp(),settings:this.settings},{merge:!0}),console.log("Push subscription saved to server")}catch(e){console.error("Error saving push subscription:",e)}}async unsubscribeFromPush(){if(!this.subscription)return{success:!0};try{if(await this.subscription.unsubscribe(),this.subscription=null,this.settings.enabled=!1,this.saveSettings(),"undefined"!=typeof firebase&&firebase.auth){const e=firebase.auth().currentUser;if(e){const n=firebase.firestore();await n.collection("pushSubscriptions").doc(e.uid).delete()}}return{success:!0,message:"Push notifications disabled"}}catch(e){return console.error("Error unsubscribing from push:",e),{success:!1,message:"Failed to disable notifications"}}}urlBase64ToUint8Array(e){const n=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),t=window.atob(n),i=new Uint8Array(t.length);for(let e=0;e<t.length;++e)i[e]=t.charCodeAt(e);return i}setupEventListeners(){window.addEventListener("achievement-unlocked",e=>{this.settings.enabled&&this.settings.achievements&&!this.isDNDActive()&&this.showNotification({title:"Achievement Unlocked! üèÜ",body:`${e.detail.name}`,icon:"/img/achievement-icon.png",tag:"achievement",data:{type:"achievement",id:e.detail.id}})}),window.addEventListener("level-up",e=>{this.settings.enabled&&!this.isDNDActive()&&this.showNotification({title:"Level Up! üéâ",body:`Congratulations! You reached Level ${e.detail.level}!`,icon:"/img/level-up-icon.png",tag:"level-up",data:{type:"level-up",level:e.detail.level}})}),window.addEventListener("friend-activity-added",e=>{if(this.settings.enabled&&this.settings.friends&&!this.isDNDActive()){const n=e.detail;"achievement"===n.type&&this.showNotification({title:"Friend Activity üë•",body:`${n.userName} unlocked ${n.data.name}!`,icon:"/img/friend-icon.png",tag:"friend-activity",data:{type:"friend-activity",...n}})}})}async showNotification(e){if("granted"===this.permission)if(this.registration||await this.registerServiceWorker(),this.registration)try{const n={body:e.body,icon:e.icon||"/img/logo-192x192.png",badge:e.badge||"/img/badge-icon.png",tag:e.tag||"default",requireInteraction:e.requireInteraction||!1,silent:e.silent||!1,data:e.data||{},actions:e.actions||[]};await this.registration.showNotification(e.title,n),console.log("Notification shown:",e.title)}catch(e){console.error("Error showing notification:",e)}else console.error("No service worker registration for notifications");else console.log("Notification permission not granted")}async scheduleDailyReminder(){if(!this.settings.dailyReminder||!this.settings.enabled)return;const e=new Date,n=this.settings.reminderTime.split(":"),t=new Date(e.getFullYear(),e.getMonth(),e.getDate(),parseInt(n[0]),parseInt(n[1]));t<e&&t.setDate(t.getDate()+1);const i=t.getTime()-e.getTime();setTimeout(()=>{this.showNotification({title:"Daily Practice Reminder üßò",body:"Time for your spiritual practice! Complete your daily quests.",icon:"/img/daily-reminder-icon.png",tag:"daily-reminder",requireInteraction:!0,actions:[{action:"view-quests",title:"View Quests"},{action:"dismiss",title:"Later"}],data:{type:"daily-reminder"}}),this.scheduleDailyReminder()},i),console.log(`Daily reminder scheduled for ${t.toLocaleString()}`)}async scheduleStreakReminder(){if(!this.settings.streaks||!this.settings.enabled)return;const e=new Date,n=new Date(e.getFullYear(),e.getMonth(),e.getDate(),20,0);n<e&&n.setDate(n.getDate()+1);const t=n.getTime()-e.getTime();setTimeout(()=>{localStorage.getItem("last_active_date")!==(new Date).toISOString().split("T")[0]&&this.showNotification({title:"Streak Reminder üî•",body:"Don't break your streak! Complete at least one activity today.",icon:"/img/streak-icon.png",tag:"streak-reminder",requireInteraction:!0,data:{type:"streak-reminder"}}),this.scheduleStreakReminder()},t)}isDNDActive(){if(!this.settings.dndEnabled)return!1;const e=new Date,n=`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`,t=this.settings.dndStart,i=this.settings.dndEnd;return t>i?n>=t||n<=i:n>=t&&n<=i}updateSettings(e){if(this.settings={...this.settings,...e},this.saveSettings(),"undefined"!=typeof firebase&&firebase.auth){const e=firebase.auth().currentUser;if(e){firebase.firestore().collection("pushSubscriptions").doc(e.uid).update({settings:this.settings}).catch(e=>console.error("Error updating settings:",e))}}void 0===e.dailyReminder&&void 0===e.reminderTime||this.scheduleDailyReminder(),void 0!==e.streaks&&this.scheduleStreakReminder()}openSettingsModal(){const e=document.createElement("div");e.className="notification-settings-modal",e.id="notificationSettingsModal",e.innerHTML=`\n            <div class="notification-modal-content">\n                <div class="notification-modal-header">\n                    <h2>üîî Notification Settings</h2>\n                    <button onclick="document.getElementById('notificationSettingsModal').remove()" class="modal-close">‚úï</button>\n                </div>\n\n                <div class="notification-modal-body">\n                    ${this.isSupported?"":'\n                        <div class="notification-warning">\n                            ‚ö†Ô∏è Push notifications are not supported in this browser.\n                        </div>\n                    '}\n\n                    ${"denied"===this.permission?'\n                        <div class="notification-error">\n                            ‚ùå Push notifications are blocked. Please enable them in your browser settings.\n                        </div>\n                    ':""}\n\n                    <div class="notification-permission-section">\n                        <h3>üîî Enable Notifications</h3>\n                        <p>Get notified about achievements, quests, and friend activity.</p>\n\n                        ${"granted"===this.permission?'\n                            <div class="permission-status enabled">\n                                ‚úÖ Notifications Enabled\n                            </div>\n                            <button onclick="window.pushNotificationSystem.disableNotifications()" class="disable-btn">\n                                Disable Notifications\n                            </button>\n                        ':'\n                            <button onclick="window.pushNotificationSystem.enableNotifications()" class="enable-btn">\n                                Enable Push Notifications\n                            </button>\n                        '}\n                    </div>\n\n                    ${"granted"===this.permission?`\n                        <div class="notification-types">\n                            <h3>üìã Notification Types</h3>\n\n                            <label class="notification-toggle">\n                                <input type="checkbox" ${this.settings.achievements?"checked":""}\n                                       onchange="window.pushNotificationSystem.toggleSetting('achievements', this.checked)">\n                                <span class="toggle-slider"></span>\n                                <span class="toggle-label">üèÜ Achievement Unlocks</span>\n                            </label>\n\n                            <label class="notification-toggle">\n                                <input type="checkbox" ${this.settings.quests?"checked":""}\n                                       onchange="window.pushNotificationSystem.toggleSetting('quests', this.checked)">\n                                <span class="toggle-slider"></span>\n                                <span class="toggle-label">üìã Daily Quest Reminders</span>\n                            </label>\n\n                            <label class="notification-toggle">\n                                <input type="checkbox" ${this.settings.friends?"checked":""}\n                                       onchange="window.pushNotificationSystem.toggleSetting('friends', this.checked)">\n                                <span class="toggle-slider"></span>\n                                <span class="toggle-label">üë• Friend Activity</span>\n                            </label>\n\n                            <label class="notification-toggle">\n                                <input type="checkbox" ${this.settings.circles?"checked":""}\n                                       onchange="window.pushNotificationSystem.toggleSetting('circles', this.checked)">\n                                <span class="toggle-slider"></span>\n                                <span class="toggle-label">üè∞ Circle Messages</span>\n                            </label>\n\n                            <label class="notification-toggle">\n                                <input type="checkbox" ${this.settings.streaks?"checked":""}\n                                       onchange="window.pushNotificationSystem.toggleSetting('streaks', this.checked)">\n                                <span class="toggle-slider"></span>\n                                <span class="toggle-label">üî• Streak Reminders</span>\n                            </label>\n\n                            <label class="notification-toggle">\n                                <input type="checkbox" ${this.settings.leaderboards?"checked":""}\n                                       onchange="window.pushNotificationSystem.toggleSetting('leaderboards', this.checked)">\n                                <span class="toggle-slider"></span>\n                                <span class="toggle-label">üèÜ Leaderboard Updates</span>\n                            </label>\n                        </div>\n\n                        <div class="daily-reminder-section">\n                            <h3>‚è∞ Daily Reminder</h3>\n                            <label class="notification-toggle">\n                                <input type="checkbox" ${this.settings.dailyReminder?"checked":""}\n                                       onchange="window.pushNotificationSystem.toggleSetting('dailyReminder', this.checked)">\n                                <span class="toggle-slider"></span>\n                                <span class="toggle-label">Enable Daily Reminder</span>\n                            </label>\n\n                            ${this.settings.dailyReminder?`\n                                <div class="time-picker">\n                                    <label>Reminder Time:</label>\n                                    <input type="time" value="${this.settings.reminderTime}"\n                                           onchange="window.pushNotificationSystem.updateSettings({ reminderTime: this.value })"\n                                           class="time-input">\n                                </div>\n                            `:""}\n                        </div>\n\n                        <div class="dnd-section">\n                            <h3>üåô Do Not Disturb</h3>\n                            <label class="notification-toggle">\n                                <input type="checkbox" ${this.settings.dndEnabled?"checked":""}\n                                       onchange="window.pushNotificationSystem.toggleDND(this.checked)">\n                                <span class="toggle-slider"></span>\n                                <span class="toggle-label">Enable Do Not Disturb</span>\n                            </label>\n\n                            ${this.settings.dndEnabled?`\n                                <div class="dnd-times">\n                                    <div class="time-picker">\n                                        <label>From:</label>\n                                        <input type="time" value="${this.settings.dndStart}"\n                                               onchange="window.pushNotificationSystem.updateSettings({ dndStart: this.value })"\n                                               class="time-input">\n                                    </div>\n                                    <div class="time-picker">\n                                        <label>To:</label>\n                                        <input type="time" value="${this.settings.dndEnd}"\n                                               onchange="window.pushNotificationSystem.updateSettings({ dndEnd: this.value })"\n                                               class="time-input">\n                                    </div>\n                                </div>\n                            `:""}\n                        </div>\n\n                        <div class="test-notification-section">\n                            <button onclick="window.pushNotificationSystem.sendTestNotification()" class="test-btn">\n                                üîî Send Test Notification\n                            </button>\n                        </div>\n                    `:""}\n                </div>\n            </div>\n        `,this.addNotificationStyles(),document.body.appendChild(e)}async enableNotifications(){const e=await this.requestPermission();alert(e.message),e.success&&(document.getElementById("notificationSettingsModal").remove(),this.openSettingsModal(),this.scheduleDailyReminder(),this.scheduleStreakReminder())}async disableNotifications(){const e=await this.unsubscribeFromPush();alert(e.message),e.success&&(document.getElementById("notificationSettingsModal").remove(),this.openSettingsModal())}toggleSetting(e,n){this.updateSettings({[e]:n})}toggleDND(e){this.updateSettings({dndEnabled:e}),document.getElementById("notificationSettingsModal").remove(),this.openSettingsModal()}sendTestNotification(){this.showNotification({title:"Test Notification üîî",body:"If you can see this, notifications are working perfectly!",icon:"/img/logo-192x192.png",tag:"test",requireInteraction:!1,data:{type:"test"}})}addNotificationStyles(){if(document.getElementById("notificationSettingsStyles"))return;const e=document.createElement("style");e.id="notificationSettingsStyles",e.textContent='\n            .notification-settings-modal {\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0,0,0,0.8);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 10000;\n                animation: fadeIn 0.3s ease;\n            }\n\n            .notification-modal-content {\n                background: white;\n                border-radius: 20px;\n                width: 90%;\n                max-width: 600px;\n                max-height: 90vh;\n                overflow: hidden;\n                display: flex;\n                flex-direction: column;\n            }\n\n            .notification-modal-header {\n                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                color: white;\n                padding: 25px 30px;\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n            }\n\n            .notification-modal-header h2 {\n                margin: 0;\n            }\n\n            .modal-close {\n                background: rgba(255,255,255,0.2);\n                border: none;\n                color: white;\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                cursor: pointer;\n                font-size: 20px;\n            }\n\n            .notification-modal-body {\n                flex: 1;\n                overflow-y: auto;\n                padding: 30px;\n            }\n\n            .notification-modal-body > div {\n                margin-bottom: 30px;\n            }\n\n            .notification-modal-body h3 {\n                margin: 0 0 15px 0;\n                font-size: 18px;\n            }\n\n            .notification-warning, .notification-error {\n                padding: 15px;\n                border-radius: 10px;\n                margin-bottom: 20px;\n            }\n\n            .notification-warning {\n                background: #fff3cd;\n                border: 2px solid #ffc107;\n                color: #856404;\n            }\n\n            .notification-error {\n                background: #f8d7da;\n                border: 2px solid #dc3545;\n                color: #721c24;\n            }\n\n            .permission-status {\n                padding: 15px;\n                border-radius: 10px;\n                margin: 15px 0;\n                font-weight: 600;\n            }\n\n            .permission-status.enabled {\n                background: #d4edda;\n                border: 2px solid #28a745;\n                color: #155724;\n            }\n\n            .enable-btn, .disable-btn, .test-btn {\n                width: 100%;\n                padding: 14px;\n                border: none;\n                border-radius: 10px;\n                font-size: 16px;\n                font-weight: 600;\n                cursor: pointer;\n                transition: transform 0.2s;\n            }\n\n            .enable-btn {\n                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                color: white;\n            }\n\n            .disable-btn {\n                background: #f0f0f0;\n                color: #666;\n            }\n\n            .test-btn {\n                background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);\n                color: white;\n                margin-top: 20px;\n            }\n\n            .enable-btn:hover, .disable-btn:hover, .test-btn:hover {\n                transform: translateY(-2px);\n            }\n\n            .notification-toggle {\n                display: flex;\n                align-items: center;\n                padding: 15px;\n                background: #f9f9f9;\n                border-radius: 10px;\n                margin-bottom: 10px;\n                cursor: pointer;\n                transition: background 0.2s;\n            }\n\n            .notification-toggle:hover {\n                background: #f0f0f0;\n            }\n\n            .notification-toggle input[type="checkbox"] {\n                display: none;\n            }\n\n            .toggle-slider {\n                width: 50px;\n                height: 26px;\n                background: #ccc;\n                border-radius: 26px;\n                position: relative;\n                transition: background 0.2s;\n                margin-right: 15px;\n            }\n\n            .toggle-slider::before {\n                content: \'\';\n                position: absolute;\n                width: 22px;\n                height: 22px;\n                background: white;\n                border-radius: 50%;\n                top: 2px;\n                left: 2px;\n                transition: transform 0.2s;\n            }\n\n            .notification-toggle input[type="checkbox"]:checked + .toggle-slider {\n                background: #667eea;\n            }\n\n            .notification-toggle input[type="checkbox"]:checked + .toggle-slider::before {\n                transform: translateX(24px);\n            }\n\n            .toggle-label {\n                font-weight: 600;\n            }\n\n            .time-picker {\n                margin: 15px 0;\n                padding-left: 65px;\n            }\n\n            .time-picker label {\n                display: block;\n                margin-bottom: 5px;\n                font-weight: 600;\n                color: #666;\n                font-size: 14px;\n            }\n\n            .time-input {\n                padding: 10px;\n                border: 2px solid #e0e0e0;\n                border-radius: 8px;\n                font-size: 15px;\n                width: 150px;\n            }\n\n            .dnd-times {\n                display: flex;\n                gap: 20px;\n                padding-left: 65px;\n                margin-top: 15px;\n            }\n\n            @keyframes fadeIn {\n                from { opacity: 0; }\n                to { opacity: 1; }\n            }\n        ',document.head.appendChild(e)}}"undefined"!=typeof window&&(window.pushNotificationSystem=new PushNotificationSystem,console.log("üîî Push Notification System ready!"));