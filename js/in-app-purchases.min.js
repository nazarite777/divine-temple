class InAppPurchases{constructor(){this.stripePublicKey="pk_test_YOUR_STRIPE_PUBLIC_KEY",this.stripe=null,this.currentUser=null,this.purchaseHistory=this.loadPurchaseHistory(),this.subscription=this.loadSubscription(),this.init()}async init(){console.log("üí≥ In-App Purchases initialized"),await this.loadStripe(),this.checkSubscriptionStatus()}async loadStripe(){"undefined"!=typeof Stripe?(this.stripe=Stripe(this.stripePublicKey),console.log("Stripe loaded")):console.warn("Stripe.js not loaded. Add script tag to HTML.")}loadPurchaseHistory(){const n=localStorage.getItem("purchase_history");return n?JSON.parse(n):[]}savePurchaseHistory(){localStorage.setItem("purchase_history",JSON.stringify(this.purchaseHistory))}loadSubscription(){const n=localStorage.getItem("subscription_data");return n?JSON.parse(n):null}saveSubscription(){localStorage.setItem("subscription_data",JSON.stringify(this.subscription))}getSubscriptionTiers(){return[{id:"free",name:"Free",price:0,period:"forever",features:["Access to Enochian Calendar","Basic meditation guides","Limited content library","Community forums"],popular:!1},{id:"monthly",name:"Premium Monthly",price:9.99,period:"month",stripePriceId:"price_monthly_premium",features:["Everything in Free","Full content library access","Advanced meditation programs","Personalized AI recommendations","Download content offline","Remove ads","1-on-1 mentor matching","Priority support"],popular:!0,savings:null},{id:"yearly",name:"Premium Yearly",price:99.99,period:"year",stripePriceId:"price_yearly_premium",features:["Everything in Monthly","Save $20/year!","Exclusive yearly content","Early access to new features","Premium badge","Free spiritual gifts"],popular:!1,savings:"17% off"},{id:"lifetime",name:"Lifetime Access",price:299.99,period:"lifetime",stripePriceId:"price_lifetime_premium",features:["Everything in Yearly","One-time payment","Lifetime updates","Founder badge","VIP community access","Personal spiritual coach","Exclusive retreats & events"],popular:!1,savings:"Best Value"}]}getOneTimePurchases(){return[{id:"advanced_course_1",name:"Advanced Chakra Mastery Course",description:"Complete 8-week course for chakra mastery",price:49.99,stripePriceId:"price_chakra_course",type:"course",benefits:["8 weeks of guided instruction","Video lessons and exercises","Downloadable workbook","Certificate of completion","Lifetime access"]},{id:"oracle_deck_premium",name:"Premium Oracle Deck",description:"Unlock premium oracle card deck with 108 cards",price:29.99,stripePriceId:"price_premium_oracle",type:"feature",benefits:["108 premium oracle cards","Advanced spreads","Detailed interpretations","Exclusive artwork"]},{id:"meditation_library",name:"Complete Meditation Library",description:"100+ guided meditations for all levels",price:39.99,stripePriceId:"price_meditation_library",type:"content",benefits:["100+ guided meditations","All difficulty levels","Various durations (5-60 min)","Downloadable MP3s"]},{id:"ad_removal",name:"Remove Ads",description:"Permanent ad-free experience",price:4.99,stripePriceId:"price_ad_removal",type:"feature",benefits:["No ads ever","Cleaner interface","Faster loading","One-time payment"]}]}async purchaseSubscription(n){const e=this.getSubscriptionTiers().find(e=>e.id===n);if(!e||!e.stripePriceId)return{success:!1,message:"Invalid subscription tier"};if(!this.stripe)return{success:!1,message:"Stripe not initialized"};try{const t=await fetch("/api/create-checkout-session",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({priceId:e.stripePriceId,mode:"lifetime"===n?"payment":"subscription"})}),i=await t.json(),s=await this.stripe.redirectToCheckout({sessionId:i.id});return s.error?{success:!1,message:s.error.message}:{success:!0}}catch(n){return console.error("Error purchasing subscription:",n),{success:!1,message:"Payment failed"}}}async purchaseOneTime(n){const e=this.getOneTimePurchases().find(e=>e.id===n);if(!e)return{success:!1,message:"Product not found"};if(!this.stripe)return{success:!1,message:"Stripe not initialized"};try{const n=await fetch("/api/create-checkout-session",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({priceId:e.stripePriceId,mode:"payment"})}),t=await n.json(),i=await this.stripe.redirectToCheckout({sessionId:t.id});return i.error?{success:!1,message:i.error.message}:{success:!0}}catch(n){return console.error("Error purchasing product:",n),{success:!1,message:"Payment failed"}}}handleSuccessfulPurchase(n){const e={id:Date.now().toString(),productId:n.productId,type:n.type,amount:n.amount,currency:n.currency||"USD",status:"completed",purchasedAt:(new Date).toISOString(),stripeSessionId:n.sessionId};if(this.purchaseHistory.push(e),this.savePurchaseHistory(),"subscription"===n.type&&(this.subscription={tier:n.tier,status:"active",startedAt:(new Date).toISOString(),renewsAt:this.calculateRenewalDate(n.tier),cancelAtPeriodEnd:!1},this.saveSubscription()),this.unlockContent(n.productId),window.progressSystem){const e="subscription"===n.type?100:50;window.progressSystem.awardXP(e,`Purchased: ${n.productName}! üíé`,"purchases")}return this.showPurchaseSuccessMessage(e),{success:!0,purchase:e}}calculateRenewalDate(n){const e=new Date;if("monthly"===n)e.setMonth(e.getMonth()+1);else if("yearly"===n)e.setFullYear(e.getFullYear()+1);else if("lifetime"===n)return null;return e.toISOString()}unlockContent(n){const e=localStorage.getItem("unlocked_content")||"[]",t=JSON.parse(e);t.includes(n)||(t.push(n),localStorage.setItem("unlocked_content",JSON.stringify(t)))}isContentUnlocked(n){const e=localStorage.getItem("unlocked_content")||"[]";return JSON.parse(e).includes(n)}showPurchaseSuccessMessage(n){const e=document.createElement("div");e.className="purchase-success-message",e.innerHTML=`\n            <div class="purchase-success-content">\n                <div class="success-icon">üéâ</div>\n                <div class="success-text">\n                    <h4>Purchase Successful!</h4>\n                    <p>Thank you for your purchase</p>\n                    <p class="success-amount">$${n.amount}</p>\n                </div>\n            </div>\n        `,document.body.appendChild(e),setTimeout(()=>e.remove(),5e3)}checkSubscriptionStatus(){if(!this.subscription)return!1;if("lifetime"===this.subscription.tier)return!0;if(this.subscription.renewsAt){const n=new Date(this.subscription.renewsAt);if(new Date>n&&!this.subscription.cancelAtPeriodEnd)return this.subscription.status="expired",this.saveSubscription(),!1}return"active"===this.subscription.status}hasActiveSubscription(){return this.checkSubscriptionStatus()}async cancelSubscription(){if(!this.subscription||"lifetime"===this.subscription.tier)return{success:!1,message:"No active subscription to cancel"};try{const n=await fetch("/api/cancel-subscription",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscriptionId:this.subscription.stripeSubscriptionId})});return(await n.json()).success?(this.subscription.cancelAtPeriodEnd=!0,this.saveSubscription(),{success:!0,message:`Subscription will end on ${new Date(this.subscription.renewsAt).toLocaleDateString()}`}):{success:!1,message:"Failed to cancel subscription"}}catch(n){return console.error("Error canceling subscription:",n),{success:!1,message:"Failed to cancel subscription"}}}openSubscriptionModal(){const n=document.createElement("div");n.className="subscription-modal",n.id="subscriptionModal";const e=this.getSubscriptionTiers(),t=this.hasActiveSubscription();n.innerHTML=`\n            <div class="subscription-modal-content">\n                <div class="subscription-modal-header">\n                    <h2>üíé Choose Your Plan</h2>\n                    <button onclick="document.getElementById('subscriptionModal').remove()" class="modal-close">‚úï</button>\n                </div>\n\n                ${t?`\n                    <div class="current-subscription-banner">\n                        <div class="banner-icon">‚úì</div>\n                        <div class="banner-text">\n                            <strong>Current Plan: ${this.subscription.tier}</strong>\n                            <p>${"active"===this.subscription.status?"Active":"Expired"}</p>\n                        </div>\n                    </div>\n                `:""}\n\n                <div class="subscription-tiers">\n                    ${e.map(n=>this.renderSubscriptionTier(n)).join("")}\n                </div>\n\n                <div class="subscription-note">\n                    <p>‚úì Cancel anytime ‚Ä¢ Secure payment by Stripe ‚Ä¢ 30-day money-back guarantee</p>\n                </div>\n            </div>\n        `,this.addPurchaseStyles(),document.body.appendChild(n)}renderSubscriptionTier(n){const e=this.subscription&&this.subscription.tier===n.id;return`\n            <div class="tier-card ${n.popular?"popular":""} ${e?"current":""}">\n                ${n.popular?'<div class="popular-badge">Most Popular</div>':""}\n                ${n.savings?`<div class="savings-badge">${n.savings}</div>`:""}\n\n                <div class="tier-header">\n                    <h3>${n.name}</h3>\n                    <div class="tier-price">\n                        ${0===n.price?'\n                            <span class="price-amount">Free</span>\n                        ':`\n                            <span class="price-currency">$</span>\n                            <span class="price-amount">${n.price}</span>\n                            <span class="price-period">/${n.period}</span>\n                        `}\n                    </div>\n                </div>\n\n                <div class="tier-features">\n                    ${n.features.map(n=>`\n                        <div class="feature-item">‚úì ${n}</div>\n                    `).join("")}\n                </div>\n\n                <button onclick="window.inAppPurchases.purchaseSubscription('${n.id}')"\n                        class="tier-select-btn ${n.popular?"primary":""}${e?" disabled":""}"\n                        ${e?"disabled":""}>\n                    ${e||0===n.price?"Current Plan":"Subscribe"}\n                </button>\n            </div>\n        `}openStoreModal(){const n=document.createElement("div");n.className="store-modal",n.id="storeModal";const e=this.getOneTimePurchases();n.innerHTML=`\n            <div class="store-modal-content">\n                <div class="store-modal-header">\n                    <h2>üõçÔ∏è Divine Temple Store</h2>\n                    <button onclick="document.getElementById('storeModal').remove()" class="modal-close">‚úï</button>\n                </div>\n\n                <div class="store-products">\n                    ${e.map(n=>this.renderProduct(n)).join("")}\n                </div>\n            </div>\n        `,this.addPurchaseStyles(),document.body.appendChild(n)}renderProduct(n){const e=this.isContentUnlocked(n.id);return`\n            <div class="product-card ${e?"owned":""}">\n                <div class="product-header">\n                    <h3>${n.name}</h3>\n                    <div class="product-price">$${n.price}</div>\n                </div>\n\n                <p class="product-description">${n.description}</p>\n\n                <div class="product-benefits">\n                    ${n.benefits.map(n=>`\n                        <div class="benefit-item">‚úì ${n}</div>\n                    `).join("")}\n                </div>\n\n                <button onclick="window.inAppPurchases.purchaseOneTime('${n.id}')"\n                        class="product-buy-btn${e?" disabled":""}"\n                        ${e?"disabled":""}>\n                    ${e?"‚úì Owned":"Purchase"}\n                </button>\n            </div>\n        `}addPurchaseStyles(){if(document.getElementById("purchaseStyles"))return;const n=document.createElement("style");n.id="purchaseStyles",n.textContent="\n            .subscription-modal, .store-modal {\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0,0,0,0.8);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 10000;\n                animation: fadeIn 0.3s ease;\n                overflow-y: auto;\n                padding: 20px;\n            }\n\n            .subscription-modal-content, .store-modal-content {\n                background: white;\n                border-radius: 20px;\n                width: 100%;\n                max-width: 1200px;\n                overflow: hidden;\n            }\n\n            .subscription-modal-header, .store-modal-header {\n                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                color: white;\n                padding: 25px 30px;\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n            }\n\n            .subscription-modal-header h2, .store-modal-header h2 {\n                margin: 0;\n            }\n\n            .modal-close {\n                background: rgba(255,255,255,0.2);\n                border: none;\n                color: white;\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                cursor: pointer;\n                font-size: 20px;\n            }\n\n            .current-subscription-banner {\n                display: flex;\n                align-items: center;\n                gap: 15px;\n                padding: 20px 30px;\n                background: linear-gradient(135deg, #10b981 0%, #059669 100%);\n                color: white;\n            }\n\n            .banner-icon {\n                font-size: 40px;\n            }\n\n            .banner-text strong {\n                display: block;\n                margin-bottom: 5px;\n            }\n\n            .banner-text p {\n                margin: 0;\n                opacity: 0.95;\n            }\n\n            .subscription-tiers {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n                gap: 20px;\n                padding: 30px;\n            }\n\n            .tier-card {\n                background: white;\n                border: 2px solid #e0e0e0;\n                border-radius: 15px;\n                padding: 30px;\n                position: relative;\n                transition: all 0.2s;\n            }\n\n            .tier-card:hover {\n                border-color: #667eea;\n                box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);\n                transform: translateY(-5px);\n            }\n\n            .tier-card.popular {\n                border-color: #ffd700;\n                border-width: 3px;\n            }\n\n            .tier-card.current {\n                background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);\n            }\n\n            .popular-badge {\n                position: absolute;\n                top: -12px;\n                left: 50%;\n                transform: translateX(-50%);\n                background: #ffd700;\n                color: #333;\n                padding: 5px 15px;\n                border-radius: 20px;\n                font-weight: bold;\n                font-size: 12px;\n            }\n\n            .savings-badge {\n                position: absolute;\n                top: 20px;\n                right: 20px;\n                background: #10b981;\n                color: white;\n                padding: 5px 12px;\n                border-radius: 20px;\n                font-weight: bold;\n                font-size: 11px;\n            }\n\n            .tier-header {\n                text-align: center;\n                margin-bottom: 25px;\n            }\n\n            .tier-header h3 {\n                margin: 0 0 15px 0;\n                font-size: 24px;\n            }\n\n            .tier-price {\n                display: flex;\n                align-items: baseline;\n                justify-content: center;\n                gap: 2px;\n            }\n\n            .price-currency {\n                font-size: 24px;\n                color: #666;\n            }\n\n            .price-amount {\n                font-size: 48px;\n                font-weight: bold;\n                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                -webkit-background-clip: text;\n                -webkit-text-fill-color: transparent;\n            }\n\n            .price-period {\n                font-size: 16px;\n                color: #666;\n            }\n\n            .tier-features {\n                margin-bottom: 25px;\n            }\n\n            .feature-item {\n                padding: 10px 0;\n                border-bottom: 1px solid #f0f0f0;\n                font-size: 14px;\n            }\n\n            .feature-item:last-child {\n                border-bottom: none;\n            }\n\n            .tier-select-btn {\n                width: 100%;\n                padding: 14px;\n                border: none;\n                border-radius: 10px;\n                background: #f0f0f0;\n                color: #666;\n                font-weight: 600;\n                font-size: 16px;\n                cursor: pointer;\n                transition: all 0.2s;\n            }\n\n            .tier-select-btn.primary {\n                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                color: white;\n            }\n\n            .tier-select-btn:hover:not(.disabled) {\n                transform: translateY(-2px);\n            }\n\n            .tier-select-btn.disabled {\n                opacity: 0.5;\n                cursor: not-allowed;\n            }\n\n            .subscription-note {\n                padding: 20px 30px;\n                background: #f9f9f9;\n                text-align: center;\n            }\n\n            .subscription-note p {\n                margin: 0;\n                color: #666;\n                font-size: 14px;\n            }\n\n            .store-products {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));\n                gap: 20px;\n                padding: 30px;\n            }\n\n            .product-card {\n                background: white;\n                border: 2px solid #e0e0e0;\n                border-radius: 15px;\n                padding: 25px;\n                transition: all 0.2s;\n            }\n\n            .product-card:hover {\n                border-color: #667eea;\n                box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);\n            }\n\n            .product-card.owned {\n                background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(5, 150, 105, 0.05) 100%);\n            }\n\n            .product-header {\n                display: flex;\n                justify-content: space-between;\n                align-items: flex-start;\n                margin-bottom: 15px;\n            }\n\n            .product-header h3 {\n                margin: 0;\n                flex: 1;\n                font-size: 20px;\n            }\n\n            .product-price {\n                font-size: 24px;\n                font-weight: bold;\n                color: #667eea;\n            }\n\n            .product-description {\n                color: #666;\n                margin-bottom: 20px;\n            }\n\n            .product-benefits {\n                margin-bottom: 20px;\n            }\n\n            .benefit-item {\n                padding: 8px 0;\n                font-size: 13px;\n                color: #555;\n            }\n\n            .product-buy-btn {\n                width: 100%;\n                padding: 12px;\n                border: none;\n                border-radius: 10px;\n                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                color: white;\n                font-weight: 600;\n                font-size: 15px;\n                cursor: pointer;\n                transition: transform 0.2s;\n            }\n\n            .product-buy-btn:hover:not(.disabled) {\n                transform: translateY(-2px);\n            }\n\n            .product-buy-btn.disabled {\n                background: #10b981;\n                cursor: not-allowed;\n            }\n\n            .purchase-success-message {\n                position: fixed;\n                top: 80px;\n                right: 20px;\n                z-index: 10001;\n                background: linear-gradient(135deg, #10b981 0%, #059669 100%);\n                color: white;\n                padding: 20px;\n                border-radius: 15px;\n                box-shadow: 0 10px 30px rgba(0,0,0,0.3);\n                animation: slideInRight 0.5s ease;\n            }\n\n            .purchase-success-content {\n                display: flex;\n                gap: 15px;\n                align-items: center;\n            }\n\n            .success-icon {\n                font-size: 40px;\n            }\n\n            .success-text h4 {\n                margin: 0 0 5px 0;\n            }\n\n            .success-text p {\n                margin: 3px 0;\n            }\n\n            .success-amount {\n                font-weight: bold;\n                font-size: 18px;\n            }\n\n            @keyframes fadeIn {\n                from { opacity: 0; }\n                to { opacity: 1; }\n            }\n\n            @keyframes slideInRight {\n                from {\n                    transform: translateX(400px);\n                    opacity: 0;\n                }\n                to {\n                    transform: translateX(0);\n                    opacity: 1;\n                }\n            }\n\n            @media (max-width: 768px) {\n                .subscription-tiers, .store-products {\n                    grid-template-columns: 1fr;\n                }\n            }\n        ",document.head.appendChild(n)}getPurchaseStats(){return{totalPurchases:this.purchaseHistory.length,totalSpent:this.purchaseHistory.reduce((n,e)=>n+e.amount,0),hasSubscription:this.hasActiveSubscription(),subscriptionTier:this.subscription?.tier||"free",unlockedContent:JSON.parse(localStorage.getItem("unlocked_content")||"[]").length}}}"undefined"!=typeof window&&(window.inAppPurchases=new InAppPurchases,console.log("üí≥ In-App Purchases ready!"));