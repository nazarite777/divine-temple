class MemberChatSystem{constructor(){this.conversations=[],this.activeConversation=null,this.currentUser=null,this.useLocalStorage=!1,this.messageListeners=[],this.init()}async init(){console.log("üí¨ Member Chat System initialized"),"undefined"!=typeof firebase&&firebase.auth?(this.useLocalStorage=!1,await this.initFirebase()):(console.warn("Firebase not available. Chat will use local storage only."),this.useLocalStorage=!0)}async initFirebase(){try{firebase.auth().onAuthStateChanged(async e=>{e?(this.currentUser={uid:e.uid,email:e.email,displayName:e.displayName||e.email.split("@")[0]},await this.loadConversations()):(this.currentUser=null,this.conversations=[])})}catch(e){console.error("Firebase initialization error:",e),this.useLocalStorage=!0}}async loadConversations(){if(!this.useLocalStorage&&this.currentUser)try{firebase.firestore().collection("conversations").where("participants","array-contains",this.currentUser.uid).orderBy("lastMessageAt","desc").onSnapshot(e=>{this.conversations=[],e.forEach(e=>{this.conversations.push({id:e.id,...e.data()})}),this.renderConversationList()})}catch(e){console.error("Error loading conversations:",e)}}async searchMembers(e=""){if(this.useLocalStorage)return{success:!1,members:[]};try{const n=firebase.firestore(),t=await n.collection("users").limit(50).get();let s=[];if(t.forEach(e=>{const n=e.data();e.id!==this.currentUser.uid&&s.push({uid:e.id,displayName:n.displayName||n.email?.split("@")[0]||"User",email:n.email,spiritualPath:n.spiritualPath||"Seeker",photoURL:n.photoURL||null})}),e){const n=e.toLowerCase();s=s.filter(e=>e.displayName.toLowerCase().includes(n)||e.email&&e.email.toLowerCase().includes(n))}return{success:!0,members:s}}catch(e){return console.error("Error searching members:",e),{success:!1,members:[]}}}async getOrCreateConversation(e,n){if(this.useLocalStorage)return{success:!1,message:"Chat requires Firebase"};try{const t=firebase.firestore(),s=[this.currentUser.uid,e].sort().join("_"),a=t.collection("conversations").doc(s);return(await a.get()).exists||await a.set({participants:[this.currentUser.uid,e],participantNames:{[this.currentUser.uid]:this.currentUser.displayName,[e]:n},createdAt:firebase.firestore.FieldValue.serverTimestamp(),lastMessageAt:firebase.firestore.FieldValue.serverTimestamp(),lastMessage:"",unreadCount:{[this.currentUser.uid]:0,[e]:0}}),{success:!0,conversationId:s,otherUserId:e,otherUserName:n}}catch(e){return console.error("Error creating conversation:",e),{success:!1,message:"Failed to create conversation"}}}async sendMessage(e,n,t){if(this.useLocalStorage)return{success:!1,message:"Chat requires Firebase"};if(!t||!t.trim())return{success:!1,message:"Message cannot be empty"};try{const s=firebase.firestore(),a={conversationId:e,senderId:this.currentUser.uid,senderName:this.currentUser.displayName,receiverId:n,text:t.trim(),timestamp:firebase.firestore.FieldValue.serverTimestamp(),read:!1};await s.collection("directMessages").add(a);const r=s.collection("conversations").doc(e);return await r.update({lastMessage:t.trim().substring(0,100),lastMessageAt:firebase.firestore.FieldValue.serverTimestamp(),[`unreadCount.${n}`]:firebase.firestore.FieldValue.increment(1)}),window.progressSystem&&window.progressSystem.awardXP(3,"Sent a message","community"),{success:!0}}catch(e){return console.error("Error sending message:",e),{success:!1,message:"Failed to send message"}}}async markConversationAsRead(e){if(!this.useLocalStorage&&this.currentUser)try{const n=firebase.firestore(),t=n.collection("conversations").doc(e);await t.update({[`unreadCount.${this.currentUser.uid}`]:0});const s=await n.collection("directMessages").where("conversationId","==",e).where("receiverId","==",this.currentUser.uid).where("read","==",!1).get(),a=n.batch();s.forEach(e=>{a.update(e.ref,{read:!0})}),await a.commit()}catch(e){console.error("Error marking conversation as read:",e)}}setupMessageListener(e,n){if(this.useLocalStorage)return;const t=firebase.firestore();this.clearMessageListeners();const s=t.collection("directMessages").where("conversationId","==",e).orderBy("timestamp","asc").limit(100).onSnapshot(e=>{const t=[];e.forEach(e=>{t.push({id:e.id,...e.data()})}),this.renderMessages(n,t)});this.messageListeners.push(s)}clearMessageListeners(){this.messageListeners.forEach(e=>e()),this.messageListeners=[]}renderMessages(e,n){const t=document.getElementById(e);t&&(0!==n.length?(t.innerHTML=n.map(e=>{const n=e.senderId===this.currentUser?.uid,t=e.timestamp?new Date(e.timestamp.toDate()).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"";return`\n                <div class="chat-message ${n?"own-message":"other-message"}">\n                    <div class="message-bubble">\n                        ${n?"":`<div class="message-sender">${e.senderName}</div>`}\n                        <div class="message-text">${this.escapeHtml(e.text)}</div>\n                        <div class="message-time">${t}</div>\n                    </div>\n                </div>\n            `}).join(""),t.scrollTop=t.scrollHeight):t.innerHTML='\n                <div class="empty-chat">\n                    <div class="empty-chat-icon">üí¨</div>\n                    <p>No messages yet. Start the conversation!</p>\n                </div>\n            ')}renderConversationList(){const e=document.getElementById("conversationsList");e&&(0!==this.conversations.length?e.innerHTML=this.conversations.map(e=>{const n=e.participants.find(e=>e!==this.currentUser.uid),t=e.participantNames[n]||"Unknown",s=e.unreadCount?.[this.currentUser.uid]||0,a=e.lastMessageAt?this.formatTimestamp(e.lastMessageAt.toDate()):"";return`\n                <div class="conversation-item ${s>0?"unread":""}"\n                     onclick="window.memberChatSystem.openConversation('${e.id}', '${n}', '${this.escapeHtml(t)}')">\n                    <div class="conversation-avatar">\n                        ${t.charAt(0).toUpperCase()}\n                    </div>\n                    <div class="conversation-info">\n                        <div class="conversation-header">\n                            <strong>${this.escapeHtml(t)}</strong>\n                            <span class="conversation-time">${a}</span>\n                        </div>\n                        <div class="conversation-preview">\n                            ${this.escapeHtml(e.lastMessage||"Start a conversation...")}\n                        </div>\n                    </div>\n                    ${s>0?`<div class="unread-badge">${s}</div>`:""}\n                </div>\n            `}).join(""):e.innerHTML='\n                <div class="empty-conversations">\n                    <div class="empty-icon">üí¨</div>\n                    <p>No conversations yet</p>\n                    <p class="empty-hint">Search for members to start chatting!</p>\n                </div>\n            ')}async openConversation(e,n,t){this.activeConversation={conversationId:e,otherUserId:n,otherUserName:t},await this.markConversationAsRead(e);const s=document.getElementById("memberChatContainer");s&&(s.innerHTML=this.renderChatView(t),this.setupMessageListener(e,"messagesList"))}renderChatView(e){return`\n            <div class="chat-view">\n                <div class="chat-header">\n                    <button onclick="window.memberChatSystem.closeChatView()" class="back-btn">\n                        ‚Üê Back\n                    </button>\n                    <div class="chat-header-info">\n                        <div class="chat-avatar">${e.charAt(0).toUpperCase()}</div>\n                        <strong>${this.escapeHtml(e)}</strong>\n                    </div>\n                </div>\n\n                <div class="messages-container" id="messagesList">\n                    <p class="loading-text">Loading messages...</p>\n                </div>\n\n                <div class="message-input-area">\n                    <input type="text"\n                           id="messageInput"\n                           placeholder="Type your message..."\n                           class="message-input"\n                           onkeypress="if(event.key === 'Enter') window.memberChatSystem.sendCurrentMessage()">\n                    <button onclick="window.memberChatSystem.sendCurrentMessage()" class="send-message-btn">\n                        üì® Send\n                    </button>\n                </div>\n            </div>\n        `}async sendCurrentMessage(){const e=document.getElementById("messageInput");if(!e)return;const n=e.value.trim();if(!n||!this.activeConversation)return;const t=await this.sendMessage(this.activeConversation.conversationId,this.activeConversation.otherUserId,n);t.success?e.value="":alert(t.message||"Failed to send message")}closeChatView(){this.clearMessageListeners(),this.activeConversation=null;const e=document.getElementById("memberChatContainer");e&&(e.innerHTML=this.renderConversationsView())}renderConversationsView(){return'\n            <div class="conversations-view">\n                <div class="conversations-header">\n                    <h3>üí¨ Messages</h3>\n                    <button onclick="window.memberChatSystem.openMemberSearch()" class="new-message-btn">\n                        ‚úâÔ∏è New Message\n                    </button>\n                </div>\n                <div id="conversationsList" class="conversations-list">\n                    <p class="loading-text">Loading conversations...</p>\n                </div>\n            </div>\n        '}async openMemberSearch(){const e=document.createElement("div");e.className="member-search-modal",e.id="memberSearchModal",e.innerHTML='\n            <div class="member-search-content">\n                <div class="member-search-header">\n                    <h3>Start a Conversation</h3>\n                    <button onclick="document.getElementById(\'memberSearchModal\').remove()" class="modal-close">‚úï</button>\n                </div>\n\n                <div class="search-input-wrapper">\n                    <input type="text"\n                           id="memberSearchInput"\n                           placeholder="Search members by name or email..."\n                           class="member-search-input"\n                           oninput="window.memberChatSystem.searchMembersFromModal()">\n                </div>\n\n                <div id="memberSearchResults" class="member-search-results">\n                    <p class="loading-text">Loading members...</p>\n                </div>\n            </div>\n        ',document.body.appendChild(e),await this.loadMemberSearchResults()}async searchMembersFromModal(){const e=document.getElementById("memberSearchInput")?.value||"";await this.loadMemberSearchResults(e)}async loadMemberSearchResults(e=""){const n=await this.searchMembers(e),t=document.getElementById("memberSearchResults");t&&(0!==n.members.length?t.innerHTML=n.members.map(e=>`\n            <div class="member-result-item" onclick="window.memberChatSystem.startConversationWith('${e.uid}', '${this.escapeHtml(e.displayName)}')">\n                <div class="member-result-avatar">\n                    ${e.displayName.charAt(0).toUpperCase()}\n                </div>\n                <div class="member-result-info">\n                    <strong>${this.escapeHtml(e.displayName)}</strong>\n                    <div class="member-result-path">${e.spiritualPath}</div>\n                </div>\n            </div>\n        `).join(""):t.innerHTML='<p class="no-results">No members found</p>')}async startConversationWith(e,n){const t=document.getElementById("memberSearchModal");t&&t.remove();const s=await this.getOrCreateConversation(e,n);s.success?await this.openConversation(s.conversationId,e,n):alert(s.message||"Failed to start conversation")}openChatModal(){const e=document.createElement("div");e.className="member-chat-modal",e.id="memberChatModal",e.innerHTML=`\n            <div class="member-chat-modal-content">\n                <div class="member-chat-modal-header">\n                    <h2>üí¨ Member Chat</h2>\n                    <button onclick="document.getElementById('memberChatModal').remove(); window.memberChatSystem.clearMessageListeners();" class="modal-close">‚úï</button>\n                </div>\n\n                <div id="memberChatContainer" class="member-chat-container">\n                    ${this.renderConversationsView()}\n                </div>\n            </div>\n        `,this.addChatStyles(),document.body.appendChild(e),setTimeout(()=>this.renderConversationList(),100)}formatTimestamp(e){const n=new Date-e,t=Math.floor(n/1e3),s=Math.floor(t/60),a=Math.floor(s/60),r=Math.floor(a/24);return r>7?e.toLocaleDateString():r>0?`${r}d ago`:a>0?`${a}h ago`:s>0?`${s}m ago`:"Just now"}escapeHtml(e){const n=document.createElement("div");return n.textContent=e,n.innerHTML}addChatStyles(){if(document.getElementById("memberChatStyles"))return;const e=document.createElement("style");e.id="memberChatStyles",e.textContent="\n            .member-chat-modal, .member-search-modal {\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0,0,0,0.8);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 10000;\n                animation: fadeIn 0.3s ease;\n            }\n\n            .member-chat-modal-content {\n                background: white;\n                border-radius: 20px;\n                width: 90%;\n                max-width: 800px;\n                height: 80vh;\n                max-height: 700px;\n                overflow: hidden;\n                display: flex;\n                flex-direction: column;\n                animation: slideUp 0.3s ease;\n            }\n\n            .member-search-content {\n                background: white;\n                border-radius: 20px;\n                width: 90%;\n                max-width: 500px;\n                max-height: 600px;\n                overflow: hidden;\n                display: flex;\n                flex-direction: column;\n                animation: slideUp 0.3s ease;\n            }\n\n            .member-chat-modal-header, .member-search-header {\n                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                color: white;\n                padding: 20px 25px;\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n            }\n\n            .member-chat-modal-header h2, .member-search-header h3 {\n                margin: 0;\n            }\n\n            .modal-close {\n                background: rgba(255,255,255,0.2);\n                border: none;\n                color: white;\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                cursor: pointer;\n                font-size: 20px;\n            }\n\n            .member-chat-container {\n                flex: 1;\n                overflow: hidden;\n                display: flex;\n                flex-direction: column;\n            }\n\n            .conversations-view {\n                flex: 1;\n                display: flex;\n                flex-direction: column;\n                overflow: hidden;\n            }\n\n            .conversations-header {\n                padding: 20px;\n                border-bottom: 2px solid #e0e0e0;\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n            }\n\n            .conversations-header h3 {\n                margin: 0;\n            }\n\n            .new-message-btn {\n                padding: 8px 16px;\n                border: none;\n                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                color: white;\n                border-radius: 8px;\n                cursor: pointer;\n                font-weight: 600;\n                transition: transform 0.2s;\n            }\n\n            .new-message-btn:hover {\n                transform: translateY(-2px);\n            }\n\n            .conversations-list {\n                flex: 1;\n                overflow-y: auto;\n                padding: 10px;\n            }\n\n            .conversation-item {\n                display: flex;\n                align-items: center;\n                gap: 15px;\n                padding: 15px;\n                border-radius: 10px;\n                cursor: pointer;\n                transition: all 0.2s;\n                margin-bottom: 8px;\n            }\n\n            .conversation-item:hover {\n                background: #f5f5f5;\n            }\n\n            .conversation-item.unread {\n                background: #f0f4ff;\n            }\n\n            .conversation-avatar {\n                width: 48px;\n                height: 48px;\n                border-radius: 50%;\n                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                color: white;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 20px;\n                font-weight: bold;\n                flex-shrink: 0;\n            }\n\n            .conversation-info {\n                flex: 1;\n                min-width: 0;\n            }\n\n            .conversation-header {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                margin-bottom: 5px;\n            }\n\n            .conversation-time {\n                font-size: 12px;\n                color: #999;\n            }\n\n            .conversation-preview {\n                color: #666;\n                font-size: 14px;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n            }\n\n            .unread-badge {\n                background: #667eea;\n                color: white;\n                border-radius: 12px;\n                padding: 4px 8px;\n                font-size: 12px;\n                font-weight: bold;\n                min-width: 20px;\n                text-align: center;\n            }\n\n            .chat-view {\n                flex: 1;\n                display: flex;\n                flex-direction: column;\n                overflow: hidden;\n            }\n\n            .chat-header {\n                padding: 15px 20px;\n                border-bottom: 2px solid #e0e0e0;\n                display: flex;\n                align-items: center;\n                gap: 15px;\n                background: #f9f9f9;\n            }\n\n            .back-btn {\n                padding: 8px 16px;\n                border: 2px solid #e0e0e0;\n                background: white;\n                border-radius: 8px;\n                cursor: pointer;\n                font-weight: 600;\n            }\n\n            .chat-header-info {\n                display: flex;\n                align-items: center;\n                gap: 12px;\n            }\n\n            .chat-avatar {\n                width: 40px;\n                height: 40px;\n                border-radius: 50%;\n                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                color: white;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 18px;\n                font-weight: bold;\n            }\n\n            .messages-container {\n                flex: 1;\n                overflow-y: auto;\n                padding: 20px;\n                background: #f9f9f9;\n            }\n\n            .chat-message {\n                margin-bottom: 15px;\n                display: flex;\n            }\n\n            .chat-message.own-message {\n                justify-content: flex-end;\n            }\n\n            .message-bubble {\n                max-width: 70%;\n                padding: 12px 16px;\n                border-radius: 12px;\n            }\n\n            .own-message .message-bubble {\n                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                color: white;\n                border-bottom-right-radius: 4px;\n            }\n\n            .other-message .message-bubble {\n                background: white;\n                border: 1px solid #e0e0e0;\n                border-bottom-left-radius: 4px;\n            }\n\n            .message-sender {\n                font-size: 12px;\n                font-weight: 600;\n                margin-bottom: 4px;\n                color: #667eea;\n            }\n\n            .message-text {\n                line-height: 1.5;\n                word-wrap: break-word;\n            }\n\n            .message-time {\n                font-size: 11px;\n                margin-top: 6px;\n                opacity: 0.7;\n            }\n\n            .message-input-area {\n                padding: 15px 20px;\n                border-top: 2px solid #e0e0e0;\n                display: flex;\n                gap: 10px;\n                background: white;\n            }\n\n            .message-input {\n                flex: 1;\n                padding: 12px;\n                border: 2px solid #e0e0e0;\n                border-radius: 10px;\n                font-size: 15px;\n            }\n\n            .send-message-btn {\n                padding: 12px 24px;\n                border: none;\n                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                color: white;\n                border-radius: 10px;\n                cursor: pointer;\n                font-weight: 600;\n                transition: transform 0.2s;\n            }\n\n            .send-message-btn:hover {\n                transform: translateY(-2px);\n            }\n\n            .search-input-wrapper {\n                padding: 20px;\n                border-bottom: 2px solid #e0e0e0;\n            }\n\n            .member-search-input {\n                width: 100%;\n                padding: 12px;\n                border: 2px solid #e0e0e0;\n                border-radius: 10px;\n                font-size: 15px;\n            }\n\n            .member-search-results {\n                flex: 1;\n                overflow-y: auto;\n                padding: 10px;\n            }\n\n            .member-result-item {\n                display: flex;\n                align-items: center;\n                gap: 15px;\n                padding: 15px;\n                border-radius: 10px;\n                cursor: pointer;\n                transition: all 0.2s;\n                margin-bottom: 8px;\n            }\n\n            .member-result-item:hover {\n                background: #f5f5f5;\n            }\n\n            .member-result-avatar {\n                width: 48px;\n                height: 48px;\n                border-radius: 50%;\n                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                color: white;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 20px;\n                font-weight: bold;\n            }\n\n            .member-result-info strong {\n                display: block;\n                margin-bottom: 4px;\n            }\n\n            .member-result-path {\n                font-size: 13px;\n                color: #666;\n            }\n\n            .empty-conversations, .empty-chat {\n                text-align: center;\n                padding: 60px 20px;\n                color: #999;\n            }\n\n            .empty-icon, .empty-chat-icon {\n                font-size: 64px;\n                margin-bottom: 15px;\n            }\n\n            .empty-hint {\n                font-size: 13px;\n                margin-top: 8px;\n            }\n\n            .loading-text, .no-results {\n                text-align: center;\n                padding: 40px;\n                color: #999;\n            }\n\n            @keyframes fadeIn {\n                from { opacity: 0; }\n                to { opacity: 1; }\n            }\n\n            @keyframes slideUp {\n                from {\n                    transform: translateY(50px);\n                    opacity: 0;\n                }\n                to {\n                    transform: translateY(0);\n                    opacity: 1;\n                }\n            }\n        ",document.head.appendChild(e)}}"undefined"!=typeof window&&(window.memberChatSystem=new MemberChatSystem,console.log("üí¨ Member Chat System ready!"));