class UniversalProgressSystem{constructor(){this.currentUser=null,this.userData=null,this.listeners=new Map,this.defaultUserData={userId:null,displayName:"",joinDate:null,lastActive:null,totalXP:0,level:1,currentLevelXP:0,nextLevelXP:100,spiritualRank:"Seeker",streaks:{daily:{count:0,lastDate:null,longestStreak:0},weekly:{count:0,lastWeek:null},monthly:{count:0,lastMonth:null}},sections:{"oracle-divination":{visits:0,xp:0,lastVisit:null,activities:[]},"spiritual-practices":{visits:0,xp:0,lastVisit:null,activities:[]},"meditation-mindfulness":{visits:0,xp:0,lastVisit:null,activities:[]},"energy-healing":{visits:0,xp:0,lastVisit:null,activities:[]},"sacred-arts-sound":{visits:0,xp:0,lastVisit:null,activities:[]},"devotion-growth":{visits:0,xp:0,lastVisit:null,activities:[]},"sacred-knowledge":{visits:0,xp:0,lastVisit:null,activities:[]},community:{visits:0,xp:0,lastVisit:null,activities:[]},calendar:{visits:0,xp:0,lastVisit:null,activities:[]},"chakras-auras":{visits:0,xp:0,lastVisit:null,activities:[]},"crystals-elements":{visits:0,xp:0,lastVisit:null,activities:[]},"spiritual-music":{visits:0,xp:0,lastVisit:null,activities:[]},"sacred-books":{visits:0,xp:0,lastVisit:null,activities:[]},"videos-media":{visits:0,xp:0,lastVisit:null,activities:[]}},stats:{meditations:0,meditationMinutes:0,oracleReadings:0,journalEntries:0,booksRead:0,videosWatched:0,chakraBalancingSessions:0,practicesCompleted:0,communityPosts:0,daysActive:0},achievements:[],favorites:[],preferences:{theme:"sacred",notifications:!0,soundEnabled:!0,autoPlayAudio:!1}},this.init()}async init(){console.log("ðŸŒŸ Universal Progress System initializing..."),"undefined"!=typeof firebase?firebase.auth().onAuthStateChanged(async t=>{t?(this.currentUser=t,await this.loadUserData(),await this.checkDailyStreak(),this.notifyListeners("userLoaded",this.userData),console.log("âœ… Progress system loaded for:",t.email)):(console.log("âš ï¸ No user logged in"),this.userData=null,this.notifyListeners("userLoggedOut"))}):console.error("âŒ Firebase not loaded")}async loadUserData(){if(this.currentUser)try{const t=await firebase.firestore().collection("universalProgress").doc(this.currentUser.uid).get();t.exists?(this.userData=t.data(),this.userData={...this.defaultUserData,...this.userData}):(this.userData={...this.defaultUserData,userId:this.currentUser.uid,displayName:this.currentUser.displayName||this.currentUser.email,joinDate:(new Date).toISOString(),lastActive:(new Date).toISOString()},await this.saveUserData(),console.log("ðŸŽ‰ New user profile created!"))}catch(t){console.error("âŒ Error loading user data:",t),this.userData={...this.defaultUserData}}}async saveUserData(){if(this.currentUser&&this.userData)try{this.userData.lastActive=(new Date).toISOString(),await firebase.firestore().collection("universalProgress").doc(this.currentUser.uid).set(this.userData,{merge:!0})}catch(t){console.error("âŒ Error saving user data:",t)}}async awardXP(t,e="",s=null){if(!this.userData)return;const a=this.userData.level;let i=t;if(window.rewardShop&&window.rewardShop.isInitialized){const e=window.rewardShop.getActiveBoosterMultiplier();e>1&&(i=Math.floor(t*e),console.log(`âš¡ XP Booster active! ${t} â†’ ${i} XP (${e}x)`))}for(this.userData.totalXP+=i,this.userData.currentLevelXP+=i,s&&this.userData.sections[s]&&(this.userData.sections[s].xp+=i);this.userData.currentLevelXP>=this.userData.nextLevelXP;)this.userData.currentLevelXP-=this.userData.nextLevelXP,this.userData.level++,this.userData.nextLevelXP=this.calculateNextLevelXP(this.userData.level),this.updateSpiritualRank(),this.notifyListeners("levelUp",{newLevel:this.userData.level,rank:this.userData.spiritualRank}),console.log(`ðŸŽ‰ LEVEL UP! Now level ${this.userData.level} - ${this.userData.spiritualRank}`);return await this.saveUserData(),this.notifyListeners("xpAwarded",{amount:t,reason:e,section:s,totalXP:this.userData.totalXP,level:this.userData.level,leveledUp:this.userData.level>a}),this.userData.level>a}calculateNextLevelXP(t){return Math.floor(100*Math.pow(t,1.5))}updateSpiritualRank(){const t=this.userData.level,e=[{min:1,max:5,name:"Seeker",icon:"ðŸ”"},{min:6,max:10,name:"Apprentice",icon:"ðŸ“¿"},{min:11,max:20,name:"Practitioner",icon:"ðŸ§˜"},{min:21,max:30,name:"Adept",icon:"âœ¨"},{min:31,max:40,name:"Mystic",icon:"ðŸ”®"},{min:41,max:50,name:"Sage",icon:"ðŸ“š"},{min:51,max:60,name:"Master",icon:"ðŸŒŸ"},{min:61,max:70,name:"Guru",icon:"ðŸ•‰ï¸"},{min:71,max:80,name:"Enlightened",icon:"ðŸ’«"},{min:81,max:100,name:"Ascended",icon:"ðŸ‘‘"}].find(e=>t>=e.min&&t<=e.max);e&&(this.userData.spiritualRank=e.name,this.userData.spiritualRankIcon=e.icon)}async checkDailyStreak(){if(!this.userData)return;const t=(new Date).toISOString().split("T")[0],e=this.userData.streaks.daily.lastDate;if(e){if(e===t)return;{const s=new Date(e),a=new Date(t);if(1===Math.floor((a-s)/864e5)){this.userData.streaks.daily.count++,this.userData.streaks.daily.lastDate=t,this.userData.streaks.daily.count>this.userData.streaks.daily.longestStreak&&(this.userData.streaks.daily.longestStreak=this.userData.streaks.daily.count);const e=Math.min(10*this.userData.streaks.daily.count,200);await this.awardXP(e,`${this.userData.streaks.daily.count} day streak!`),this.notifyListeners("streakContinued",{count:this.userData.streaks.daily.count,bonusXP:e})}else{const e=this.userData.streaks.daily.count;this.userData.streaks.daily.count=1,this.userData.streaks.daily.lastDate=t,this.notifyListeners("streakBroken",{oldStreak:e})}}}else this.userData.streaks.daily.count=1,this.userData.streaks.daily.lastDate=t,this.userData.streaks.daily.longestStreak=1;this.userData.stats.daysActive++,await this.saveUserData()}async logActivity(t,e,s={}){if(!this.userData)return;const a={type:t,section:e,timestamp:(new Date).toISOString(),data:s};this.userData.sections[e]&&(this.userData.sections[e].activities.push(a),this.userData.sections[e].lastVisit=a.timestamp,this.userData.sections[e].visits++,this.userData.sections[e].activities.length>50&&(this.userData.sections[e].activities=this.userData.sections[e].activities.slice(-50))),window.dispatchEvent(new CustomEvent("activityLogged",{detail:{type:t,section:e,data:s,activity:a}}));const i={meditation:{xp:50,stat:"meditations"},oracle_reading:{xp:30,stat:"oracleReadings"},journal_entry:{xp:40,stat:"journalEntries"},journal:{xp:40,stat:"journalEntries"},gratitude:{xp:20,stat:"gratitudeEntries"},prayer:{xp:30,stat:"prayers"},"book-read":{xp:100,stat:"booksRead"},"video-watched":{xp:20,stat:"videosWatched"},chakra_healing:{xp:60,stat:"chakraBalancingSessions"},"practice-completed":{xp:50,stat:"practicesCompleted"},"community-post":{xp:25,stat:"communityPosts"}}[t];i&&(await this.awardXP(i.xp,t,e),i.stat&&void 0!==this.userData.stats[i.stat]&&this.userData.stats[i.stat]++),await this.checkAchievements(),await this.saveUserData(),this.notifyListeners("activityLogged",a)}async checkAchievements(){const t=this.getAchievementDefinitions();for(const e of t)this.userData.achievements.some(t=>t.id===e.id)||e.check(this.userData)&&await this.unlockAchievement(e)}async unlockAchievement(t){this.userData.achievements.push({id:t.id,unlockedAt:(new Date).toISOString()}),await this.awardXP(t.xp,`Achievement: ${t.name}`),this.notifyListeners("achievementUnlocked",t),console.log(`ðŸ† Achievement Unlocked: ${t.name}`)}getAchievementDefinitions(){return[{id:"first-meditation",name:"First Steps",description:"Complete your first meditation",icon:"ðŸ§˜",xp:50,check:t=>t.stats.meditations>=1},{id:"meditation-10",name:"Meditation Devotee",description:"Complete 10 meditations",icon:"ðŸ§˜â€â™€ï¸",xp:200,check:t=>t.stats.meditations>=10},{id:"meditation-100",name:"Meditation Master",description:"Complete 100 meditations",icon:"ðŸ•‰ï¸",xp:1e3,check:t=>t.stats.meditations>=100},{id:"first-reading",name:"Divine Guidance",description:"Perform your first oracle reading",icon:"ðŸ”®",xp:30,check:t=>t.stats.oracleReadings>=1},{id:"oracle-50",name:"Oracle Adept",description:"Perform 50 oracle readings",icon:"ðŸƒ",xp:500,check:t=>t.stats.oracleReadings>=50},{id:"streak-7",name:"Week Warrior",description:"Maintain a 7-day streak",icon:"ðŸ”¥",xp:150,check:t=>t.streaks.daily.count>=7},{id:"streak-30",name:"Month Master",description:"Maintain a 30-day streak",icon:"ðŸ”¥ðŸ”¥",xp:750,check:t=>t.streaks.daily.count>=30},{id:"streak-100",name:"Century Sage",description:"Maintain a 100-day streak",icon:"ðŸ”¥ðŸ”¥ðŸ”¥",xp:2500,check:t=>t.streaks.daily.count>=100},{id:"level-10",name:"Apprentice Ascended",description:"Reach level 10",icon:"âœ¨",xp:500,check:t=>t.level>=10},{id:"level-25",name:"Adept Achieved",description:"Reach level 25",icon:"ðŸŒŸ",xp:1e3,check:t=>t.level>=25},{id:"level-50",name:"Mastery Manifested",description:"Reach level 50",icon:"ðŸ’«",xp:2500,check:t=>t.level>=50},{id:"journal-10",name:"Thoughtful Scribe",description:"Write 10 journal entries",icon:"ðŸ“",xp:200,check:t=>t.stats.journalEntries>=10},{id:"chakra-balance",name:"Balanced Being",description:"Complete 10 chakra balancing sessions",icon:"ðŸ•‰ï¸",xp:300,check:t=>t.stats.chakraBalancingSessions>=10},{id:"book-read",name:"Sacred Scholar",description:"Complete your first book",icon:"ðŸ“š",xp:150,check:t=>t.stats.booksRead>=1},{id:"community-join",name:"Community Connection",description:"Make your first community post",icon:"ðŸ¤",xp:50,check:t=>t.stats.communityPosts>=1},{id:"explorer",name:"Temple Explorer",description:"Visit all 14 sections",icon:"ðŸ—ºï¸",xp:500,check:t=>Object.values(t.sections).every(t=>t.visits>0)}]}addEventListener(t,e){this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push(e)}removeEventListener(t,e){if(this.listeners.has(t)){const s=this.listeners.get(t),a=s.indexOf(e);a>-1&&s.splice(a,1)}}notifyListeners(t,e){this.listeners.has(t)&&this.listeners.get(t).forEach(t=>t(e))}getUserLevel(){return this.userData?this.userData.level:1}getUserXP(){return this.userData?this.userData.totalXP:0}getUserRank(){return this.userData?this.userData.spiritualRank:"Seeker"}getStreak(){return this.userData?this.userData.streaks.daily.count:0}getLevelProgress(){return this.userData?this.userData.currentLevelXP/this.userData.nextLevelXP*100:0}getSectionProgress(t){return this.userData&&this.userData.sections[t]?this.userData.sections[t]:null}getAchievements(){return this.userData?this.userData.achievements:[]}hasAchievement(t){return this.userData&&this.userData.achievements.some(e=>e.id===t)}}window.progressSystem=new UniversalProgressSystem,console.log("âœ¨ Universal Progress System loaded and ready");